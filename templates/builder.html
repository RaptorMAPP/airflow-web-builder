{% extends "base.html" %}
{% block title %}Builder ¬∑ Airflow DAG Studio{% endblock %}
{% block page_title %}Creador de DAGs{% endblock %}
{% block page_subtitle %}Genera DAGs compatibles con Airflow 3.1{% endblock %}
{% block header_actions %}
  <button class="button ghost" id="btn_import">Importar .py/.json</button>
  <button class="button ghost" id="btn_clear">Limpiar</button>

  <button class="button secondary" id="btn_preview">Previsualizar</button>
  <button class="button" id="btn_download">Descargar .py</button>
{% endblock %}



{% block head_extra %}
<style>
  .form-grid-2 { display:grid; grid-template-columns: repeat(2, minmax(240px, 1fr)); gap:12px; }
  .form-grid-3 { display:grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap:12px; }
  .cards-autofit { display:grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap:12px; }
  .deps-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap:12px; }
  .tabs-header { display:flex; gap:6px; padding:8px; border-bottom:1px solid var(--border); background:var(--panel); position:sticky; top:72px; z-index:5; }
  .tab { border:1px solid var(--border); background:var(--panel-alt); padding:6px 10px; border-radius:8px; cursor:pointer; }
  .tab[aria-selected="true"]{ border-color:var(--brand); color:var(--brand); }
  .section-card { background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; }
  .muted-note { margin-top:.35rem; color:var(--muted); font-size:12px; }
  #pane-tasks.compact .section-card { padding:10px; border-radius:10px; }
  #pane-tasks.compact label { font-size:11px; margin:.15rem 0 .2rem; }
  #pane-tasks.compact input, #pane-tasks.compact select, #pane-tasks.compact textarea { padding:6px; font-size:12px; }
  #pane-tasks.compact .cards-autofit { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:8px; }
  .graph-card { background:var(--panel); border:1px solid var(--border);
                border-radius:var(--radius); padding:12px; }
  #dagGraph { width:100%; height:420px; border:1px dashed var(--border);
              border-radius:10px; background:
                radial-gradient(var(--border) 1px, transparent 0) 0 0/16px 16px,
                radial-gradient(var(--border) 1px, transparent 0) 8px 8px/16px 16px;
              margin-top:8px; }
  .form-grid-4 { display:grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap:12px; }
  #out_code, #out_val { max-height:520px; overflow:auto; white-space:pre-wrap; word-break:break-word; }
</style>
<script src="{{ url_for('static', filename='js/dag_import_ui.js') }}"></script>
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
{% endblock %}

{% block content %}
<input id="import_file" type="file" accept=".py,.json" style="display:none"/>

<div class="card" style="padding:0;">
  <!-- Tabs -->
  <div role="tablist" aria-label="Secciones" class="tabs-header">
    <button role="tab" class="tab" data-tab="general" aria-selected="true">General</button>
    <button role="tab" class="tab" data-tab="schedule">Scheduling</button>
    <button role="tab" class="tab" data-tab="tasks">Tasks</button>
    <button role="tab" class="tab" data-tab="deps">Dependencies</button>
  </div>

  <div class="tabpanes" style="padding:12px;">
    <!-- GENERAL -->
    <section id="pane-general" role="tabpanel">
      <div class="section-card">
        <h3 style="margin-top:0;">Datos generales</h3>

        <div class="form-grid-2">
          <div>
            <label>DAG ID</label>
            <input id="dag_id" placeholder="etl_sales_daily"/>
          </div>
          <div>
            <label>Descripci√≥n</label>
            <input id="description" placeholder="Breve descripci√≥n del DAG"/>
          </div>
        </div>

        <div class="form-grid-3" style="margin-top:12px;">
          <div>
            <label>Owner</label>
            <input id="owner" value="data-team"/>
          </div>
          <div>
            <label>Tag: Aplicaci√≥n</label>
            <input id="app" placeholder="(opcional)"/>
          </div>
          <div>
            <label>Tag: Sub-aplicaci√≥n</label>
            <input id="subapp" placeholder="(opcional)"/>
          </div>
        </div>

        <div class="form-grid-2" style="margin-top:12px;">
          <div>
            <label>Retries</label>
            <input id="retries" type="number" min="0" step="1" value="1"/>
          </div>
          <div>
            <label>Retry delay (min)</label>
            <input id="retry_minutes" type="number" min="1" step="1" value="5"/>
          </div>
        </div>

        <div style="display:flex;gap:.5rem;align-items:center;margin-top:12px;">
          <input id="catchup" type="checkbox"/><label for="catchup">catchup</label>
        </div>
      </div>

      <div class="section-card" style="margin-top:12px;">
        <h3 style="margin-top:0;">Par√°metros y argumentos (global)</h3>
        <div class="muted-note">Centraliza <b>params</b> (templating Jinja) y <b>argsets</b> (argumentos reutilizables). Luego los asignas por tarea en <b>Dependencies</b>.</div>

        <div class="form-grid-2" style="margin-top:10px;">
          <div>
            <h4 style="margin:0 0 6px;">Params (Jinja)</h4>
            <div id="global_params"></div>
            <div class="muted-note">Se renderiza como <code>params={...}</code> en el operador. Ej: <code>fecha</code> = <code>{{ ds }}</code></div>
          </div>
          <div>
            <h4 style="margin:0 0 6px;">Argsets (para scripts/comandos)</h4>
            <div id="global_argsets"></div>
            <div class="muted-note">Se aplican a <code>command</code>/<code>bash_command</code> seg√∫n el operador. Ej: <code>-r -c il_logs 3 *.log /ruta/origen /ruta/destino</code></div>
          </div>
        </div>
      </div>
    </section>

    <!-- SCHEDULING -->
    <section id="pane-schedule" role="tabpanel" hidden>
      <div class="section-card">
        <h3 style="margin-top:0;">Scheduling</h3>

        <div class="form-grid-2">
          <div>
            <label>Start date</label>
            <input id="start_date" type="date"/>
          </div>

          <div>
            <label>Schedule</label>
            <select id="schedule_kind">
                            <option value="@none">@none (Sin schedule)</option>
<option value="@calendar">@calendar (calendario custom)</option>
              <option value="@once">@once (una sola vez)</option>
              <option value="@times">@times (horarios espec√≠ficos)</option>
              <option value="@hourly">@hourly</option>
              <option value="@daily">@daily</option>
              <option value="@weekly">@weekly</option>
              <option value="@monthly">@monthly</option>
              <option value="@yearly">@yearly</option>
            </select>
            <div class="muted-note">Airflow 3.1 usa <code>schedule=</code> (no <code>schedule_interval</code>).</div>
          </div>
        </div>

        <!-- Campos espec√≠ficos -->
        <div id="sched_fields" style="margin-top:12px;">
          <!-- Calendario custom (tipo Control-M) -->
            <div class="form-grid-2 only-calendar" style="display:none; margin-top:8px;">
              <div>
                <label>Calendario</label>
                <select id="calendar_name"></select>
                <div class="muted-note">
                  Usa un calendario definido en el men√∫ <b>üìÖ Calendarios</b>. Se aplica sobre los d√≠as y este panel define la hora.
                </div>
              </div>
              <div style="display:flex; gap:8px; align-items:end;">
                <button id="btn_reload_calendars" class="button ghost" type="button">Recargar</button>
                <a class="button secondary" href="/calendars"
                   style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">
                  Gestionar
                </a>
              </div>
            </div>

          <!-- TIMES (horarios espec√≠ficos) -->
          <div class="only-times" style="display:none; margin-top:8px;">
            <div class="section-card" style="padding:12px;">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <b>Horarios espec√≠ficos</b>
                <span class="muted-note">Genera 1 o m√°s cron (agrupa por minuto). Si hay m√°s de uno, se env√≠a como <code>MULTI|...</code>.</span>
              </div>

              <div style="margin-top:10px;">
                <label>D√≠as de semana</label>
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="1" checked> Lun</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="2" checked> Mar</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="3" checked> Mi√©</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="4" checked> Jue</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="5" checked> Vie</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="6"> S√°b</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="0"> Dom</label>

                  <span style="flex:1;"></span>
                  <button id="times_btn_lv" class="button ghost" type="button">L-V</button>
                  <button id="times_btn_all" class="button ghost" type="button">Todos</button>
                  <button id="times_btn_none" class="button ghost" type="button">Limpiar</button>
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Horarios (HH:MM) ‚Äî separados por coma / espacio / salto de l√≠nea</label>
                <input id="times_list" placeholder="10:00, 11:00, 14:30, 17:00  (tambi√©n acepta 1000, 1430)"/>
                <div class="muted-note">Ej: <code>1000,1100,1430,1700</code> o <code>10:00 11:00 14:30 17:00</code></div>
              </div>

              <details style="margin-top:10px;">
                <summary>Ver cron(s) generados</summary>
                <pre id="times_crons" style="margin-top:8px; white-space:pre-wrap;">‚Äî</pre>
              </details>
            </div>
          </div>

<!-- ONCE -->
          <div class="form-grid-3 only-once">
            <div>
              <label>Hora (@once)</label>
              <input id="once_hh" type="number" min="0" max="23" value="9">
            </div>
            <div>
              <label>Minuto (@once)</label>
              <input id="once_mm" type="number" min="0" max="59" value="0">
            </div>
          </div>

          <!-- Hora base (daily/weekly/monthly/yearly) -->
          <div class="form-grid-3 only-daily only-weekly only-monthly only-yearly" style="margin-top:8px;">
            <div>
              <label>Hora</label>
              <input id="t_hh" type="number" min="0" max="23" value="9">
            </div>
            <div>
              <label>Minuto</label>
              <input id="t_mm" type="number" min="0" max="59" value="0">
            </div>
          </div>

          <!-- Weekly -->
          <div class="form-grid-3 only-weekly" style="margin-top:8px;">
            <div>
              <label>D√≠a de semana</label>
              <select id="w_dow">
                <option value="1">Lunes</option><option value="2">Martes</option>
                <option value="3">Mi√©rcoles</option><option value="4">Jueves</option>
                <option value="5">Viernes</option><option value="6">S√°bado</option>
                <option value="0">Domingo</option>
              </select>
            </div>
          </div>

          <!-- Monthly -->
          <div class="form-grid-3 only-monthly" style="margin-top:8px;">
            <div>
              <label>D√≠a del mes</label>
              <input id="m_dom" type="number" min="1" max="31" value="1">
            </div>
          </div>

          <!-- Yearly -->
          <div class="form-grid-3 only-yearly" style="margin-top:8px;">
            <div>
              <label>Mes</label>
              <select id="y_mon">
                <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
              </select>
            </div>
            <div>
              <label>D√≠a</label>
              <input id="y_dom" type="number" min="1" max="31" value="1">
            </div>
          </div>

          <!-- Hourly -->
          <div class="form-grid-3 only-hourly" style="margin-top:8px;">
            <div>
              <label>Minuto de la hora</label>
              <input id="h_mm" type="number" min="0" max="59" value="0">
            </div>
            <div>
              <label>Hora inicio (no c√≠clico)</label>
              <input id="h_start" type="number" min="0" max="23" value="">
            </div>
          </div>

          <!-- C√çCLICO -->
<div class="section-card only-cyclic" style="margin-top:12px;">
  <div style="display:flex;gap:8px;align-items:center;">
    <input id="cyclic_on" type="checkbox">
    <label for="cyclic_on"><b>C√≠clico dentro de ventana (cada N minutos/horas)</b></label>
  </div>

  <div class="form-grid-4" style="margin-top:8px;">
    <div>
      <label>Cada N</label>
      <input id="cyclic_n" type="number" min="1" max="59" value="15">
    </div>

    <div>
      <label>Unidad</label>
      <select id="cyclic_unit">
        <option value="minutes" selected>minutos</option>
        <option value="hours">horas</option>
      </select>
    </div>

    <div id="cyclic_at_mm_wrap" style="display:none;">
      <label>En minuto (solo si unidad=horas)</label>
      <input id="cyclic_at_mm" type="number" min="0" max="59" value="0">
    </div>

    <div>
      <label>Desde hora</label>
      <input id="cyc_from" type="number" min="0" max="23" value="9">
    </div>

    <div>
      <label>Hasta hora</label>
      <input id="cyc_to" type="number" min="0" max="23" value="18">
    </div>
  </div>

  <div class="muted-note">
    Si est√° activo ‚ÄúC√≠clico‚Äù, se ignoran los campos de hora/minuto de arriba y se genera un cron por intervalo.
  </div>
</div>


          <!-- TZ + acciones -->
          <div class="form-grid-3" style="margin-top:12px;">
            <div>
              <label>Timezone</label>
              <input id="sched_tz" type="text" value="America/Santiago">
            </div>
          </div>
          <div style="display:flex;gap:.5rem;align-items:center;margin-top:12px;">
            <input id="confirm_on" type="checkbox"/>
            <label for="confirm_on"><b>Confirm (manual)</b> ‚Äî no iniciar hasta aprobaci√≥n</label>
          </div>
          <div class="muted-note">
            Si est√° activo, se agrega una tarea sensor <code>confirm</code> al inicio que espera una Variable por <code>run_id</code> antes de continuar.
          </div>

          <div class="section-card" style="margin-top:12px;">
            <div style="display:flex;gap:.5rem;align-items:center;">
              <input id="mode_b_on" type="checkbox"/>
              <label for="mode_b_on"><b>Opci√≥n B</b> ‚Äî disparar por Asset y adem√°s correr cada 5 minutos (24x7)</label>
            </div>
            <div class="muted-note">
              Al activarlo, el builder habilita <b>Assets</b> y configura un schedule c√≠clico <code>*/5</code> para todo el d√≠a.
              Debes definir al menos 1 <b>Inlet</b> en la secci√≥n Assets.
            </div>
          </div>



          <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
            <button id="btn_build_cron" class="button">Generar cron</button>
            <code id="cron_preview" style="padding:4px 8px;border:1px solid var(--border);border-radius:8px;">‚Äî</code>
            <button id="btn_preview_runs" class="button ghost">Ver pr√≥ximos 5</button>
            <span id="runs_preview" class="muted"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- TASKS -->
    <section id="pane-tasks" role="tabpanel" hidden>
      <div class="section-card" style="margin-bottom:12px;">
        <div id="task-toolbar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <select id="opsel" style="width:320px; max-width:100%;"></select>
          <button id="add_op" class="button">+ Agregar tarea</button>
          <span class="muted">Accesos r√°pidos:</span>
          <button id="add_empty"  class="button ghost">+ Empty</button>
          <button id="add_bash"   class="button ghost">+ Bash</button>
          <button id="add_python" class="button ghost">+ Python</button>
          <button id="add_custom" class="button ghost">+ Custom</button>
          <button id="add_ssh"    class="button ghost">+ SSH</button>
          <button id="add_winrm"  class="button ghost">+ WinRM</button>

          <div style="margin-left:auto; display:flex; align-items:center; gap:6px;">
            <label for="toggle_compact" class="muted">Modo compacto</label>
            <input id="toggle_compact" type="checkbox" />
          </div>
        </div>
      </div>
      <div id="tasks" class="cards-autofit"></div>
    </section>

    <!-- DEPENDENCIES -->
    <section id="pane-deps" role="tabpanel" hidden>
      <div class="deps-grid">
        <div class="section-card">
          <h3 style="margin-top:0;">Internas (mismo DAG)</h3>
          <div id="deps"></div>
          <button id="add_dep" class="button" style="margin-top:8px;">+ Dependencia interna</button>
        </div>
        <div class="section-card">
          <h3 style="margin-top:0;">Externas (otro DAG/tarea)</h3>
          <div id="extdeps"></div>
          <button id="add_extdep" class="button" style="margin-top:8px;">+ Dependencia externa</button>
          <p class="muted-note">Crea un <code>ExternalTaskSensor</code> y lo encadena con una tarea local.</p>
        </div>

        <div class="section-card">
          <h3 style="margin-top:0;">Assets (condiciones tipo Control-M)</h3>
          <label style="display:flex;gap:10px;align-items:center;">
            <input type="checkbox" id="assets_on">
            <span>Habilitar Assets (condiciones entre DAGs)</span>
          </label>
          <p class="muted-note" style="margin-top:6px;">
            Define qu√© tasks <b>publican</b> Assets (outlets) y qu√© tasks los <b>consumen</b> (inlets).
            Si est√° habilitado, el DAG puede dispararse por Assets adem√°s del schedule seleccionado (se usa <code>AssetOrTimeSchedule</code>).
          </p>

          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div>
              <label>Combinaci√≥n de Assets</label>
              <select id="asset_logic" style="width:190px;">
                <option value="OR">OR (cualquiera)</option>
                <option value="AND">AND (todos)</option>
              </select>
            </div>
            <div style="flex:1; min-width:260px;">
              <label>Prefijo para auto-generar URI</label>
              <input id="asset_prefix" placeholder="asset://cond/" value="asset://cond/">
            </div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,.12); margin:12px 0;">

          <h4 style="margin:0 0 6px 0;">Inlets (Assets que consume)</h4>
          <div id="asset_inlets"></div>
          <button id="add_asset_inlet" class="button ghost" style="margin-top:6px;">+ Inlet</button>

          <h4 style="margin:14px 0 6px 0;">Outlets (Assets que publica)</h4>
          <div id="asset_outlets"></div>
          <button id="add_asset_outlet" class="button ghost" style="margin-top:6px;">+ Outlet</button>
        </div>


    </div>
    <div class="section-card">
          <h3 style="margin-top:0;">Recursos (Pools / Control-M)</h3>
          <div id="resdeps"></div>
          <p class="muted-note" style="margin-top:8px;">Asigna recursos por tarea (cuantitativo/exclusivo). Airflow aplica 1 pool por task: marca uno como aplicado.</p>
    </div>

    <div class="section-card">
          <h3 style="margin-top:0;">Args / Params por tarea</h3>
          <div id="argdeps"></div>
          <p class="muted-note" style="margin-top:8px;">Asigna un <b>argset</b> + args extra (se agrega a <code>command</code>/<code>bash_command</code> cuando aplique) y/o <b>params</b> (se pasa como <code>params</code> a cualquier operador).</p>
    </div>


    </section>
  </div>
</div>

<!-- GRAFO -->
<div class="graph-card" style="margin-top:12px;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0;">Vista de Grafo (en vivo)</h3>
    <div class="muted">Se actualiza al editar Tasks/Dependencies</div>
  </div>
  <div id="dagGraph" aria-label="DAG graph"></div>
</div>

<!-- PREVIEW/VALIDACI√ìN -->
<div class="card" style="margin-top:12px;">
  <h3 style="margin-top:0;">Preview / Validaci√≥n</h3>
  <div style="display:flex;gap:8px;margin-bottom:8px;">
    <button class="button secondary" id="btn_show_code">C√≥digo</button>
    <button class="button secondary" id="btn_show_val">Validaci√≥n</button>
  </div>
  <pre id="out_code">‚Äî</pre>
  <pre id="out_val" style="display:none">‚Äî</pre>
</div>
{% endblock %}




{% block scripts %}
<script>
(function initBuilder(){
  const main = () => {
/* ===== Tabs ===== */
(function(){
  const KEY='builder:lastTab';
  const tabs=[...document.querySelectorAll('[role="tab"]')];
  const panes = {general:'#pane-general', schedule:'#pane-schedule', tasks:'#pane-tasks', deps:'#pane-deps'};
  function show(name){
    tabs.forEach(t=>t.setAttribute('aria-selected', String(t.dataset.tab===name)));
    Object.entries(panes).forEach(([k,sel])=> document.querySelector(sel).hidden = (k!==name));
    localStorage.setItem(KEY, name);
  }
  tabs.forEach(t => t.addEventListener('click', ()=>show(t.dataset.tab)));
  show(localStorage.getItem(KEY) || 'general');
})();

/* ===== Config comunes ===== */
const OP_TYPES = [
  ["python","PythonOperator"], ["bash","BashOperator"],
  ["dummy","DummyOperator"], ["empty","EmptyOperator"],
  ["sqlite","SqliteOperator"], ["postgres","PostgresOperator"], ["mysql","MySqlOperator"],
  ["email","EmailOperator"], ["http","SimpleHttpOperator"], ["docker","DockerOperator"],
  ["mssql","MsSqlOperator"], ["oracle","OracleOperator"], ["snowflake","SnowflakeOperator"],
  ["s3","S3CreateObjectOperator"], ["lambda","LambdaInvokeFunctionOperator"], ["glue","GlueJobOperator"],
  ["bigquery","BigQueryExecuteQueryOperator"], ["dataflow","DataflowCreateJavaJobOperator"],
  ["azure","AzureDataFactoryRunPipelineOperator"], ["kubernetes","KubernetesPodOperator"],
  ["spark","SparkSubmitOperator"], ["databricks","DatabricksSubmitRunOperator"]
];

function el(tag, attrs={}, html=""){ const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v)); if(html) e.innerHTML=html; return e; }
let tcount = 0;
function normId(v){ let s=String(v||"").trim().replace(/\s+/g,"_"); s=s.replace(/[^A-Za-z0-9_]/g,"_"); if(!/^[A-Za-z_]/.test(s)) s="t_"+s; return s||"t_task"; }
function ensureUniqueTaskIds(tasks){ const seen=new Map(); return tasks.map(t=>{ const base=normId(t.task_id); let id=base; if(seen.has(base)){ const n=seen.get(base)+1; seen.set(base,n); id=`${base}_${n}` } else { seen.set(base,1) } return {...t, task_id:id}; }); }

/* ===== Scheduling (√∫nico control) ===== */
window.builderState = window.builderState || { schedule: "@daily", timezone: "America/Santiago", params: {}, argsets: {} };

/* ===== Params/Argsets (global) ===== */
function _tokenizeArgs(raw){
  const s = String(raw||'').trim();
  if(!s) return [];
  // respeta tokens entre comillas dobles
  const out=[];
  const reTok=/"([^"]*)"|(\S+)/g;
  let m;
  while((m=reTok.exec(s))!==null){ out.push((m[1]!==undefined)?m[1]:m[2]); }
  return out;
}

function initGlobalParamsPanel(){
  const host = document.getElementById('global_params');
  if(!host) return null;

  const box = el('div', {style:'display:flex; flex-direction:column; gap:10px;'});
  const form = el('div', {style:'display:grid; grid-template-columns: 180px 1fr 140px; gap:8px; align-items:end;'});

  const kDiv = el('div', {});
  kDiv.appendChild(el('label', {}, 'key'));
  const kInp = el('input', {placeholder:'fecha'});
  kDiv.appendChild(kInp);

  const vDiv = el('div', {});
  vDiv.appendChild(el('label', {}, 'value'));
  const vInp = el('input', {placeholder:'{{ ds }}'});
  vDiv.appendChild(vInp);

  const bDiv = el('div', {});
  bDiv.appendChild(el('label', {}, ''));
  const addBtn = el('button', {class:'button ghost', type:'button'}, '+ Agregar');
  bDiv.appendChild(addBtn);

  form.appendChild(kDiv); form.appendChild(vDiv); form.appendChild(bDiv);
  box.appendChild(form);

  const list = el('div', {style:'display:flex; flex-direction:column; gap:6px;'});
  box.appendChild(list);
  host.appendChild(box);

  function render(){
    const params = window.builderState.params || (window.builderState.params = {});
    list.innerHTML = '';
    const keys = Object.keys(params);
    if(!keys.length){
      list.appendChild(el('div',{class:'muted-note'}, '(sin params)'));
      return;
    }
    keys.sort().forEach((k)=>{
      const row = el('div', {style:'display:grid; grid-template-columns: 180px 1fr 120px; gap:8px; align-items:center; padding:8px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);'});
      const kk = el('input', {value:k});
      const vv = el('input', {value:String(params[k] ?? '')});
      const rm = el('button', {class:'button ghost', type:'button'}, 'Quitar');

      function saveKey(){
        const nk = (kk.value||'').trim();
        if(!nk) return;
        if(nk !== k){
          const val = params[k];
          delete params[k];
          params[nk] = val;
        }
        params[kk.value.trim()] = vv.value;
        window.builderState.params = params;
        render();
      }
      function saveVal(){
        params[kk.value.trim() || k] = vv.value;
        window.builderState.params = params;
      }
      kk.addEventListener('change', saveKey);
      vv.addEventListener('input', saveVal);
      rm.addEventListener('click', ()=>{ delete params[k]; window.builderState.params = params; render(); });

      row.appendChild(kk); row.appendChild(vv); row.appendChild(rm);
      list.appendChild(row);
    });
  }

  addBtn.addEventListener('click', ()=>{
    const k = (kInp.value||'').trim();
    if(!k) return;
    const params = window.builderState.params || (window.builderState.params = {});
    params[k] = vInp.value || '';
    window.builderState.params = params;
    kInp.value=''; vInp.value=''; kInp.focus();
    render();
  });

  render();
  return { render };
}

function initGlobalArgsetsPanel(){
  const host = document.getElementById('global_argsets');
  if(!host) return null;

  const box = el('div', {style:'display:flex; flex-direction:column; gap:10px;'});
  const form = el('div', {style:'display:grid; grid-template-columns: 220px 1fr 140px; gap:8px; align-items:end;'});

  const nDiv = el('div', {});
  nDiv.appendChild(el('label', {}, 'nombre'));
  const nInp = el('input', {placeholder:'SPLIT_FILE'});
  nDiv.appendChild(nInp);

  const aDiv = el('div', {});
  aDiv.appendChild(el('label', {}, 'args (texto o JSON)'));
  const aInp = el('input', {placeholder:'-r -c il_logs 3 *.log /ruta/origen /ruta/destino'});
  aDiv.appendChild(aInp);

  const bDiv = el('div', {});
  bDiv.appendChild(el('label', {}, ''));
  const addBtn = el('button', {class:'button ghost', type:'button'}, '+ Agregar');
  bDiv.appendChild(addBtn);

  form.appendChild(nDiv); form.appendChild(aDiv); form.appendChild(bDiv);
  box.appendChild(form);

  const list = el('div', {style:'display:flex; flex-direction:column; gap:6px;'});
  box.appendChild(list);
  host.appendChild(box);

  function parseArgset(raw){
    const s = String(raw||'').trim();
    if(!s) return [];
    if((s.startsWith('{') && s.endsWith('}')) || (s.startsWith('[') && s.endsWith(']'))){
      try{ return JSON.parse(s); }catch(_){ /* cae */ }
    }
    return _tokenizeArgs(s);
  }

  function fmtArgset(obj){
    if(Array.isArray(obj)) return obj.join(' ');
    if(obj && typeof obj === 'object'){
      try{ return JSON.stringify(obj); }catch(_){ return String(obj); }
    }
    return String(obj||'');
  }

  function render(){
    const argsets = window.builderState.argsets || (window.builderState.argsets = {});
    list.innerHTML='';
    const names = Object.keys(argsets);
    if(!names.length){
      list.appendChild(el('div',{class:'muted-note'}, '(sin argsets)'));
      if(window.__argMgr && window.__argMgr.refreshArgsets) window.__argMgr.refreshArgsets();
      return;
    }

    names.sort().forEach((name)=>{
      const row = el('div', {style:'display:grid; grid-template-columns: 220px 1fr 120px; gap:8px; align-items:center; padding:8px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);'});
      const nn = el('input', {value:name});
      const aa = el('input', {value: fmtArgset(argsets[name])});
      const rm = el('button', {class:'button ghost', type:'button'}, 'Quitar');

      function save(){
        const newName = (nn.value||'').trim();
        if(!newName) return;
        const parsed = parseArgset(aa.value);
        if(newName !== name){
          const old = argsets[name];
          delete argsets[name];
          argsets[newName] = parsed;
        }else{
          argsets[name] = parsed;
        }
        window.builderState.argsets = argsets;
        if(window.__argMgr && window.__argMgr.refreshArgsets) window.__argMgr.refreshArgsets();
      }

      nn.addEventListener('change', ()=>{ save(); render(); });
      aa.addEventListener('change', save);
      rm.addEventListener('click', ()=>{ delete argsets[name]; window.builderState.argsets = argsets; render(); });

      row.appendChild(nn); row.appendChild(aa); row.appendChild(rm);
      list.appendChild(row);
    });

    if(window.__argMgr && window.__argMgr.refreshArgsets) window.__argMgr.refreshArgsets();
  }

  addBtn.addEventListener('click', ()=>{
    const name = (nInp.value||'').trim();
    if(!name) return;
    const argsets = window.builderState.argsets || (window.builderState.argsets = {});
    argsets[name] = parseArgset(aInp.value);
    window.builderState.argsets = argsets;
    nInp.value=''; aInp.value=''; nInp.focus();
    render();
  });

  render();
  return { render };
}

window.__globalParamsMgr = initGlobalParamsPanel();
window.__globalArgsetsMgr = initGlobalArgsetsPanel();


function showSchedGroups(kind){
  const all = ['only-calendar','only-once','only-times','only-hourly','only-daily','only-weekly','only-monthly','only-yearly'];
  all.forEach(cls => document.querySelectorAll('.'+cls).forEach(el => el.style.display='none'));

  if (kind==='@none') { document.querySelectorAll('.only-cyclic').forEach(el=>el.style.display='none'); return; }

  if (kind==='@calendar') document.querySelectorAll('.only-calendar,.only-daily').forEach(el=>el.style.display='block');
  if (kind==='@once')    document.querySelectorAll('.only-once').forEach(el=>el.style.display='block');
  if (kind==='@times')   document.querySelectorAll('.only-times').forEach(el=>el.style.display='block');
  if (kind==='@hourly')  document.querySelectorAll('.only-hourly').forEach(el=>el.style.display='block');
  if (kind==='@daily')   document.querySelectorAll('.only-daily').forEach(el=>el.style.display='block');
  if (kind==='@weekly')  document.querySelectorAll('.only-weekly,.only-daily').forEach(el=>el.style.display='block');
  if (kind==='@monthly') document.querySelectorAll('.only-monthly,.only-daily').forEach(el=>el.style.display='block');
  if (kind==='@yearly')  document.querySelectorAll('.only-yearly,.only-daily').forEach(el=>el.style.display='block');

  // C√≠clico solo aplica a hourly/daily/weekly/monthly/yearly
  document.querySelectorAll('.only-cyclic').forEach(el=>{
    el.style.display = (kind==='@times' || kind==='@once') ? 'none' : 'block';
  });
}

function buildCronFromUI2(){
  const kind = document.getElementById('schedule_kind').value;
  const tz   = (document.getElementById('sched_tz').value || 'UTC').trim();
  window.builderState.timezone = tz;

  if (kind === '@none') return 'None';

  // Para @once no hay cron: devolvemos @once y usamos hora en start_time
  if (kind === '@once') return '@once';

  // Horarios espec√≠ficos: genera 1 o m√°s cron (agrupados por minuto)
  if (kind === '@times'){
    const clamp = (x, min, max) => Math.min(max, Math.max(min, x));

    const dows = Array.from(document.querySelectorAll('input[name="times_dow"]:checked'))
      .map(cb => cb.value)
      .filter(v => v !== undefined && v !== null && v !== "");

    // Si no marca nada, por defecto L-V
    const dowsEff = (dows.length ? dows : ["1","2","3","4","5"]);

    // Normaliza DOW a campo cron
    const uniq = [...new Set(dowsEff.map(String))];
    const asNums = uniq.map(n => parseInt(n,10)).filter(n => !Number.isNaN(n)).sort((a,b)=>a-b);

    let dowField = asNums.join(',');
    // compactar L-V
    if (asNums.length === 5 && asNums.join(',') === '1,2,3,4,5') dowField = '1-5';
    // compactar todos
    if (asNums.length === 7 && asNums.join(',') === '0,1,2,3,4,5,6') dowField = '*';

    const raw = (document.getElementById('times_list')?.value || '').trim();
    const tokens = raw
      .replace(/[;|]+/g, ' ')
      .split(/[\s,]+/g)
      .map(s => s.trim())
      .filter(Boolean);

    const times = [];
    for(const t of tokens){
      let hh=null, mm=null;
      if(t.includes(':')){
        const [h,m] = t.split(':');
        hh = parseInt(h,10); mm = parseInt(m,10);
      }else if(/^\d{4}$/.test(t)){
        hh = parseInt(t.slice(0,2),10); mm = parseInt(t.slice(2),10);
      }else if(/^\d{3}$/.test(t)){
        hh = parseInt(t.slice(0,1),10); mm = parseInt(t.slice(1),10);
      }else if(/^\d{1,2}$/.test(t)){
        // "10" => 10:00
        hh = parseInt(t,10); mm = 0;
      }else{
        continue;
      }
      hh = clamp(hh,0,23); mm = clamp(mm,0,59);
      times.push({hh,mm});
    }

    // dedupe
    const key = (o)=> `${String(o.hh).padStart(2,'0')}:${String(o.mm).padStart(2,'0')}`;
    const uniqTimes = [...new Map(times.map(o=>[key(o),o])).values()]
      .sort((a,b)=> (a.hh-b.hh) || (a.mm-b.mm));

    // fallback si no hay horarios
    if(!uniqTimes.length){
      const cr = `0 9 * * ${dowField}`;
      const pre = document.getElementById('times_crons');
      if(pre) pre.textContent = cr;
      return cr;
    }

    // agrupar por minuto
    const byMin = new Map();
    for(const t of uniqTimes){
      const mmKey = t.mm;
      if(!byMin.has(mmKey)) byMin.set(mmKey, []);
      byMin.get(mmKey).push(t.hh);
    }

    const crons = [];
    [...byMin.entries()].sort((a,b)=>a[0]-b[0]).forEach(([mmVal, hours])=>{
      const hs = [...new Set(hours)].sort((a,b)=>a-b);
      const hhField = hs.join(',');
      crons.push(`${mmVal} ${hhField} * * ${dowField}`);
    });

    const pre = document.getElementById('times_crons');
    if(pre) pre.textContent = crons.join('\n');

    if(crons.length === 1) return crons[0];
    return 'MULTI|' + crons.join('||');
  }


  const HH = +document.getElementById('t_hh')?.value || 0;
  const MM = +document.getElementById('t_mm')?.value || 0;

  const CY   = !!document.getElementById('cyclic_on').checked;
  const unit = (document.getElementById('cyclic_unit')?.value || 'minutes'); // minutes | hours

  const clamp = (x, min, max) => Math.min(max, Math.max(min, x));
  const rawN  = +document.getElementById('cyclic_n')?.value || (unit === 'hours' ? 2 : 15);

  const Nmax  = (unit === 'hours') ? 23 : 59;
  const N     = clamp(rawN, 1, Nmax);

  const F0    = clamp(+document.getElementById('cyc_from')?.value || 0, 0, 23);
  const T0    = clamp(+document.getElementById('cyc_to')?.value   || 23, 0, 23);
  const F     = Math.min(F0, T0);
  const T     = Math.max(F0, T0);

  const cycMM = clamp(+document.getElementById('cyclic_at_mm')?.value || 0, 0, 59);


  // --- Custom calendar ---
  if (kind === '@calendar'){
    const cal = (document.getElementById('calendar_name')?.value || '').trim();
    const hh2 = String(isNaN(HH)?0:HH).padStart(2,'0');
    const mm2 = String(isNaN(MM)?0:MM).padStart(2,'0');

    if(!cal) return '@calendar';

    // No c√≠clico: 1 corrida por fecha activa del calendario
    if (!CY) return `CAL|${cal}|${hh2}:${mm2}`;

    // C√≠clico: varias corridas dentro de cada fecha activa del calendario
    // Formato: CALC|<calendar>|<unit>|<N>|<from>|<to>|<at_mm>
    return `CALC|${cal}|${unit}|${N}|${F}|${T}|${cycMM}`;
  }

  // helpers para cron c√≠clico
  const cyclicDaily = () => {
    if (unit === 'minutes') return `*/${N} ${F}-${T} * * *`;
    // horas: minuto fijo, hora con step
    if (F === 0 && T === 23) return `${cycMM} */${N} * * *`;
    return `${cycMM} ${F}-${T}/${N} * * *`;
  };

  const cyclicWeekly = (DOW) => {
    if (unit === 'minutes') return `*/${N} ${F}-${T} * * ${DOW}`;
    if (F === 0 && T === 23) return `${cycMM} */${N} * * ${DOW}`;
    return `${cycMM} ${F}-${T}/${N} * * ${DOW}`;
  };

  const cyclicMonthly = (DOM) => {
    if (unit === 'minutes') return `*/${N} ${F}-${T} ${DOM} * *`;
    if (F === 0 && T === 23) return `${cycMM} */${N} ${DOM} * *`;
    return `${cycMM} ${F}-${T}/${N} ${DOM} * *`;
  };

  const cyclicYearly = (DOM, MON) => {
    if (unit === 'minutes') return `*/${N} ${F}-${T} ${DOM} ${MON} *`;
    if (F === 0 && T === 23) return `${cycMM} */${N} ${DOM} ${MON} *`;
    return `${cycMM} ${F}-${T}/${N} ${DOM} ${MON} *`;
  };

  if (kind === '@hourly'){
    if (CY) return cyclicDaily(); // permite tambi√©n ciclos en horas
    const hmm   = +document.getElementById('h_mm').value || 0;
    const hstart = document.getElementById('h_start').value;
    if (hstart !== "" && hstart !== undefined && hstart !== null){
      const HS = Math.min(23, Math.max(0, +hstart));
      return `${hmm} ${HS}-23 * * *`;
    }
    return `${hmm} * * * *`;
  }
  if (kind === '@daily'){
    if (CY) return cyclicDaily();
    return `${MM} ${HH} * * *`;
  }
    if (kind === '@weekly'){
    const DOW = document.getElementById('w_dow').value;
    if (CY) return cyclicWeekly(DOW);
    return `${MM} ${HH} * * ${DOW}`;
  }

    if (kind === '@monthly'){
    const DOM = +document.getElementById('m_dom').value || 1;
    if (CY) return cyclicMonthly(DOM);
    return `${MM} ${HH} ${DOM} * *`;
  }

    if (kind === '@yearly'){
    const MON = +document.getElementById('y_mon').value || 1;
    const DOM = +document.getElementById('y_dom').value || 1;
    if (CY) return cyclicYearly(DOM, MON);
    return `${MM} ${HH} ${DOM} ${MON} *`;
  }

  return "@daily";
}


async function loadCalendarsIntoSelect(preferValue){
  const sel = document.getElementById('calendar_name');
  if(!sel) return;

  const keep = (preferValue !== undefined && preferValue !== null) ? String(preferValue) : (sel.value || '');
  sel.innerHTML = '<option value="">‚Äî Selecciona ‚Äî</option>';

  try{
    const r = await fetch('/api/calendars');
    const data = await r.json().catch(()=>[]);
    if(!Array.isArray(data) || !data.length){
      sel.innerHTML = '<option value="">(sin calendarios)</option>';
      return;
    }
    data.forEach(o=>{
      const name = (o && o.name) ? String(o.name) : '';
      if(!name) return;
      const count = (o && o.count !== undefined) ? o.count : '';
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = count !== '' ? `${name} (${count})` : name;
      sel.appendChild(opt);
    });

    if(keep){
      sel.value = keep;
    }else{
      const first = sel.querySelector('option[value]:not([value=""])');
      if(first) sel.value = first.value;
    }
  }catch(e){
    sel.innerHTML = '<option value="">(error cargando calendarios)</option>';
  }
}

(function initSched2(){
  const kindSel = document.getElementById('schedule_kind');
  const tz      = document.getElementById('sched_tz');

  let initial = (window.builderState.schedule || '@daily');
  if (typeof initial === 'string') initial = initial.trim();
  let initialCalendar = null;

  // Si viene de un DAG/spec ya generado con calendario custom
  if (typeof initial === 'string' && initial.startsWith('CAL|')){
    kindSel.value = '@calendar';
    const parts = initial.split('|');
    initialCalendar = (parts[1] || '').trim();

    const hm = (parts[2] || '00:00').trim();
    const [hhS, mmS] = hm.split(':');
    const hh = parseInt(hhS || '0', 10);
    const mm = parseInt(mmS || '0', 10);

    const hhEl = document.getElementById('t_hh'); if(hhEl) hhEl.value = String(isNaN(hh)?0:hh);
    const mmEl = document.getElementById('t_mm'); if(mmEl) mmEl.value = String(isNaN(mm)?0:mm);

  } else if (initial === 'None') {
    kindSel.value = '@none';
  } else if (['@once','@times','@hourly','@daily','@weekly','@monthly','@yearly'].includes(initial)){
    kindSel.value = initial;
  } else { kindSel.value = '@daily'; }

  tz.value = window.builderState.timezone || tz.value || 'UTC';


  // Cargar calendarios existentes para el selector (y mantener selecci√≥n si edito un DAG existente)
  loadCalendarsIntoSelect(initialCalendar).then(()=>{ if (typeof syncCronFromUI === 'function') syncCronFromUI(); });

  document.getElementById('btn_reload_calendars')?.addEventListener('click', async ()=>{
    await loadCalendarsIntoSelect();
    if (typeof syncCronFromUI === 'function') syncCronFromUI();
  });
  // Botones r√°pidos para @times
  function setTimesDows(mode){
    const cbs = Array.from(document.querySelectorAll('input[name="times_dow"]'));
    if(!cbs.length) return;
    if(mode==='lv'){
      cbs.forEach(cb => cb.checked = ['1','2','3','4','5'].includes(cb.value));
    } else if(mode==='all'){
      cbs.forEach(cb => cb.checked = true);
    } else if(mode==='none'){
      cbs.forEach(cb => cb.checked = false);
    }
    if (typeof syncCronFromUI === 'function') syncCronFromUI();
  }
  document.getElementById('times_btn_lv')?.addEventListener('click', ()=> setTimesDows('lv'));
  document.getElementById('times_btn_all')?.addEventListener('click', ()=> setTimesDows('all'));
  document.getElementById('times_btn_none')?.addEventListener('click', ()=> setTimesDows('none'));
  document.querySelectorAll('input[name="times_dow"]').forEach(cb=>{
    cb.addEventListener('change', ()=>{ if (typeof syncCronFromUI === 'function') syncCronFromUI(); });
  });

  // Auto-sync al tocar cualquier campo de scheduling
  const schedIds = [
    'schedule_kind','sched_tz','calendar_name',
    't_hh','t_mm','h_mm','h_start',
    'w_dow','m_dom','y_mon','y_dom',
    'cyclic_on','cyclic_n','cyclic_unit','cyclic_at_mm','cyc_from','cyc_to',
    'once_hh','once_mm',
    'times_list'
  ];
  schedIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const ev = (el.tagName === 'SELECT' || el.type === 'checkbox') ? 'change' : 'input';
    el.addEventListener(ev, ()=>{ if (typeof syncCronFromUI === 'function') syncCronFromUI(); });
    if(ev !== 'change') el.addEventListener('change', ()=>{ if (typeof syncCronFromUI === 'function') syncCronFromUI(); });
  });
  showSchedGroups(kindSel.value);

  // Mantener builderState.schedule sincronizado con la UI (evita que el preview use el valor inicial "@daily")
  function syncCronFromUI(){
    const cron = buildCronFromUI2();
    window.builderState.schedule = cron;
    const cp = document.getElementById('cron_preview');
    if(cp){
      if(typeof cron === 'string' && cron.startsWith('MULTI|')){
        const n = cron.slice(6).split('||').filter(Boolean).length;
        cp.textContent = `MULTI (${n})`;
        cp.title = cron;
      } else if (typeof cron === 'string' && cron.startsWith('CAL|')){
        const parts = cron.split('|');
        const cal = (parts[1] || '').trim();
        const hm  = (parts[2] || '').trim();
        cp.textContent = cal ? `CAL (${cal}) ${hm}` : 'CAL (sin calendario)';
        cp.title = cron;
      } else {
        cp.textContent = cron || '‚Äî';
        cp.title = '';
      }
    }
    return cron;
  }

  kindSel.addEventListener('change', ()=> { showSchedGroups(kindSel.value); syncCronFromUI(); });

  document.getElementById('btn_build_cron').addEventListener('click', ()=>{
    syncCronFromUI();
  });

  document.getElementById('btn_preview_runs').addEventListener('click', async ()=>{
    const cron = window.builderState.schedule || buildCronFromUI2();
    const timezone = window.builderState.timezone || 'UTC';
    async function previewOne(cr){
      const r = await fetch('/api/schedule/preview', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ cron: cr, timezone, count: 5 }),
      });
      const data = await r.json().catch(()=>({error:'resp inv√°lida'}));
      if(data.error) throw new Error(data.error);
      return Array.isArray(data.next_runs) ? data.next_runs : [];
    }

    try {
      // CAL|<name>|HH:MM  (vista previa cliente-side)

      // CALC|<name>|unit|N|from|to|at_mm  (vista previa cliente-side)
      if(typeof cron === 'string' && cron.startsWith('CALC|')){
        const parts = cron.split('|');
        const calId = (parts[1] || '').trim();
        const unit  = (parts[2] || 'minutes').trim();
        const every = parseInt(parts[3] || '15', 10);
        const wFrom = parseInt(parts[4] || '0', 10);
        const wTo   = parseInt(parts[5] || '23', 10);
        const atMM  = parseInt(parts[6] || '0', 10);

        if(!calId){
          document.getElementById('runs_preview').textContent = 'Selecciona un calendario.';
          return;
        }

        const resp = await fetch(`/api/calendars/${encodeURIComponent(calId)}`);
        const calData = await resp.json().catch(()=>({}));
        const dates = Array.isArray(calData.dates) ? calData.dates : [];

        const now = new Date();
        const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        const nowMinutes = now.getHours()*60 + now.getMinutes();

        const clamp = (x,min,max)=>Math.min(max,Math.max(min,x));
        const F = clamp(Math.min(wFrom,wTo), 0, 23);
        const T = clamp(Math.max(wFrom,wTo), 0, 23);
        const out = [];

        const pushCandidate = (d, hh, mm) => {
          const dt = new Date(`${d}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`);
          out.push(dt.toISOString());
        };

        // generar candidatos por cada fecha del calendario, tomar pr√≥ximos 5 desde "ahora"
        for(const d of dates){
          if(d < today) continue;

          if(unit === 'hours'){
            const step = clamp(isNaN(every)?2:every, 1, 23);
            const mm = clamp(isNaN(atMM)?0:atMM, 0, 59);

            for(let hh=F; hh<=T; hh+=step){
              if(d === today){
                const candMin = hh*60 + mm;
                if(candMin < nowMinutes) continue;
              }
              pushCandidate(d, hh, mm);
              if(out.length >= 20) break;
            }
          } else {
            const step = clamp(isNaN(every)?15:every, 1, 59);
            for(let hh=F; hh<=T; hh++){
              for(let mm=0; mm<60; mm+=step){
                if(d === today){
                  const candMin = hh*60 + mm;
                  if(candMin < nowMinutes) continue;
                }
                pushCandidate(d, hh, mm);
                if(out.length >= 20) break;
              }
              if(out.length >= 20) break;
            }
          }

          if(out.length >= 20) break;
        }

        document.getElementById('runs_preview').textContent = out.slice(0,5).join('\n') || 'Sin pr√≥ximas ejecuciones (seg√∫n calendario).';
        return;
      }

if(typeof cron === 'string' && cron.startsWith('CAL|')){
        const parts = cron.split('|');
        const calId = (parts[1] || '').trim();
        const hm    = (parts[2] || '00:00').trim();
        if(!calId){
          document.getElementById('runs_preview').textContent = 'Selecciona un calendario';
          return;
        }
        const [hhS, mmS] = hm.split(':');
        const hh = parseInt(hhS || '0', 10);
        const mm = parseInt(mmS || '0', 10);

        const resp = await fetch(`/api/calendars/${encodeURIComponent(calId)}`);
        const calData = await resp.json().catch(()=>({}));
        const dates = Array.isArray(calData.dates) ? calData.dates : [];

        // Tomar pr√≥ximos 5 desde hoy (asumiendo TZ del navegador ~ sched_tz)
        const now = new Date();
        const today = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        const nowMinutes = now.getHours()*60 + now.getMinutes();
        const schMinutes = (isNaN(hh)?0:hh)*60 + (isNaN(mm)?0:mm);

        const out = [];
        for(const d of dates){
          if(d < today) continue;
          if(d === today && nowMinutes >= schMinutes) continue;
          out.push(`${d} ${String(isNaN(hh)?0:hh).padStart(2,'0')}:${String(isNaN(mm)?0:mm).padStart(2,'0')}:00`);
          if(out.length >= 5) break;
        }

        document.getElementById('runs_preview').textContent = out.length ? out.join('  ¬∑  ') : '‚Äî';
        return;
      }

      // MULTI|cron1||cron2...
      if(typeof cron === 'string' && cron.startsWith('MULTI|')){
        const parts = cron.slice(6).split('||').map(s=>s.trim()).filter(Boolean);
        const lists = await Promise.all(parts.map(p => previewOne(p)));
        const merged = lists.flat().filter(Boolean);

        // Ordenar (formato "YYYY-MM-DD HH:MM:SS" => orden lexicogr√°fico funciona)
        merged.sort();

        // dedupe y tomar 5
        const out = [];
        const seen = new Set();
        for(const dt of merged){
          if(seen.has(dt)) continue;
          seen.add(dt);
          out.push(dt);
          if(out.length >= 5) break;
        }
        document.getElementById('runs_preview').textContent = out.length ? out.join('  ¬∑  ') : '‚Äî';
        return;
      }

      const runs = await previewOne(cron);
      document.getElementById('runs_preview').textContent = runs.length ? runs.join('  ¬∑  ') : '‚Äî';
    } catch (e) {
      document.getElementById('runs_preview').textContent = 'Error: ' + (e?.message || '‚Äî');
    }
  });

    function toggleCyclicUnitFields(){
    const unitSel = document.getElementById('cyclic_unit');
    const wrap    = document.getElementById('cyclic_at_mm_wrap');
    const nInput  = document.getElementById('cyclic_n');
    if(!unitSel || !wrap || !nInput) return;

    const unit = unitSel.value || 'minutes';
    wrap.style.display = (unit === 'hours') ? 'block' : 'none';

    // ajustar max seg√∫n unidad
    nInput.max = (unit === 'hours') ? '23' : '59';
    const n = +nInput.value || 1;
    if(unit === 'hours' && n > 23) nInput.value = 23;
    if(unit === 'minutes' && n > 59) nInput.value = 59;

    // recalcular cron al cambiar unidad/max
    if (typeof syncCronFromUI === 'function') syncCronFromUI();
  }

  document.getElementById('cyclic_unit')?.addEventListener('change', ()=>{ toggleCyclicUnitFields(); if (typeof syncCronFromUI === 'function') syncCronFromUI(); });
  toggleCyclicUnitFields();
  if (typeof syncCronFromUI === 'function') syncCronFromUI();


})();
/* ===== Tasks / Deps / Graph ===== */
/* ===== Tasks ===== */
function taskIdOptions(){
  return Array.from(document.querySelectorAll('#tasks input[data-k="task_id"]'))
    .map(i=>normId(i.value)).filter(Boolean)
    .filter((v,i,a)=>a.indexOf(v)===i);
}

window.__resMgr = initResDepsPanel();
if(window.__resMgr){ window.__resMgr.refresh(taskIdOptions()); }

window.__argMgr = initArgsDepsPanel();
if(window.__argMgr){ window.__argMgr.refresh(taskIdOptions()); }



function refreshTaskSelects(){
  const ids = taskIdOptions();
  document.querySelectorAll('#deps select[data-k="_sel"]').forEach(sel=>{
    const v=sel.value; sel.innerHTML=""; ids.forEach(id=>sel.appendChild(el("option",{value:id},id))); if(ids.includes(v)) sel.value=v;
  });
  document.querySelectorAll('#extdeps select[data-k="downstream"]').forEach(sel=>{
    const v=sel.value; sel.innerHTML=""; ids.forEach(id=>sel.appendChild(el("option",{value:id},id))); if(ids.includes(v)) sel.value=v;
  });

  document.querySelectorAll('#asset_inlets select[data-k="task_id"], #asset_outlets select[data-k="task_id"]').forEach(sel=>{
    const v=sel.value; sel.innerHTML=""; ids.forEach(id=>sel.appendChild(el("option",{value:id},id))); if(ids.includes(v)) sel.value=v;
  });
  if(window.__resMgr && typeof window.__resMgr.refresh === 'function'){
    window.__resMgr.refresh(ids);
  }
  if(window.__argMgr && typeof window.__argMgr.refresh === 'function'){
    window.__argMgr.refresh(ids);
  }
}
function addTask(type){
  const wrap = el("div",{class:"section-card"});
  const tid = `t${++tcount}`;
  wrap.appendChild(el("div",{},`<b>${type}</b>`));
  wrap.appendChild(el("label",{},"task_id"));
  const idInput = el("input",{value:tid,"data-k":"task_id"});
  idInput.addEventListener('change', refreshTaskSelects);
  wrap.appendChild(idInput);
  wrap.appendChild(el("input",{"type":"hidden","data-k":"type",value:type}));
  // args/params centralizados (se asignan desde Dependencies)
  wrap.appendChild(el("input",{"type":"hidden","data-k":"argset_ref",value:""}));
  wrap.appendChild(el("input",{"type":"hidden","data-k":"append_args",value:""}));
  wrap.appendChild(el("input",{"type":"hidden","data-k":"params",value:""}));

  const add = (label, key, ph="", long=false) => {
    wrap.appendChild(el("label",{},label));
    if(long){ wrap.appendChild(el("textarea",{"data-k":key,style:"height:88px;"}, ph)); }
    else { wrap.appendChild(el("input",{"data-k":key,placeholder:ph})); }
  };

  if(type==="BashOperator"){
    const help = el("div",{class:"muted-note"}, "Ejecuta bash_command. Puedes elegir comando directo o construir un script + argumentos.");
    wrap.appendChild(help);

    wrap.appendChild(el("label",{},"tipo de ejecucion"));
    const modeSel = el("select",{"data-ui":"bash_mode"});
    modeSel.innerHTML = '<option value="command" selected>comando</option><option value="script">script</option>';
    wrap.appendChild(modeSel);

    const scriptBox = el("div",{style:"margin-top:8px; padding:12px; border:1px dashed var(--border); border-radius:12px; display:none;"});
    scriptBox.appendChild(el("div",{class:"muted-note"},"Si eliges script: indica ruta + script + args. El bash_command se autogenera."));

    const sg = el("div",{class:"form-grid-2", style:"margin-top:8px;"});
    const dirDiv = el("div",{});
    const fileDiv = el("div",{});
    const dirInp = el("input",{placeholder:"/opt/jobs"});
    const fileInp = el("input",{placeholder:"mi_script.sh / .ksh"});
    dirDiv.appendChild(el("label",{},"ruta (directorio)"));
    dirDiv.appendChild(dirInp);
    fileDiv.appendChild(el("label",{},"script (archivo)"));
    fileDiv.appendChild(fileInp);
    sg.appendChild(dirDiv);
    sg.appendChild(fileDiv);
    scriptBox.appendChild(sg);

    const sg2 = el("div",{class:"form-grid-2", style:"margin-top:8px;"});
    const shDiv = el("div",{});
    const argsDiv = el("div",{});
    shDiv.appendChild(el("label",{},"int√©rprete"));
    const shSel = el("select",{style:"width:100%;"});
    shSel.innerHTML = '<option value="bash" selected>bash</option><option value="sh">sh</option><option value="ksh">ksh</option><option value="direct">directo (./script)</option>';
    shDiv.appendChild(shSel);

    const argsInp = el("input",{placeholder:"-r -c il_logs 3 *.log (opcional)"});
    argsDiv.appendChild(el("label",{},"argumentos (opcional)"));
    argsDiv.appendChild(argsInp);

    sg2.appendChild(shDiv);
    sg2.appendChild(argsDiv);
    scriptBox.appendChild(sg2);

    const cdChk = el("input",{type:"checkbox"});
    cdChk.checked = true;
    const cdRow = el("div",{style:"display:flex; gap:8px; align-items:center; margin-top:8px;"});
    cdRow.appendChild(cdChk);
    cdRow.appendChild(el("span",{class:"muted-note"},"ejecutar desde la ruta (cd)"));
    scriptBox.appendChild(cdRow);

    // Params builder -> se concatenan como args
    const parmBox = el("div",{style:"margin-top:8px; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);"});
    parmBox.appendChild(el("div",{class:"muted-note"},"Agrega parametros (PARM1..PARMn). Se concatenan como argumentos al final del script."));
    const pRow = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px;"});
    const pK = el("input",{placeholder:"PARM1", style:"min-width:160px;"});
    const pV = el("input",{placeholder:"valor", style:"min-width:220px; flex:1;"});
    const pAdd = el("button",{class:"button ghost", type:"button"},"+ Agregar");
    pRow.appendChild(pK); pRow.appendChild(pV); pRow.appendChild(pAdd);
    const pList = el("div",{style:"margin-top:8px; display:flex; flex-direction:column; gap:6px;"});
    parmBox.appendChild(pRow); parmBox.appendChild(pList);
    const spTA = el("textarea",{"data-k":"script_params", style:"display:none; height:72px;"},"{}");
    scriptBox.appendChild(parmBox);
    scriptBox.appendChild(pList);
    scriptBox.appendChild(spTA);

    const btnGen = el("button",{class:"button ghost", type:"button", style:"margin-top:8px;"},"Construir bash_command");
    scriptBox.appendChild(btnGen);

    wrap.appendChild(scriptBox);

    wrap.appendChild(el("label",{},"bash_command"));
    const cmdTA = el("textarea",{"data-k":"bash_command",style:"height:88px;"},"echo 'hola'");
    wrap.appendChild(cmdTA);

    const manualRow = el("div",{style:"display:flex; gap:10px; align-items:center; margin-top:6px;"});
    const manualChk = el("input",{type:"checkbox"});
    manualRow.appendChild(manualChk);
    manualRow.appendChild(el("span",{class:"muted-note"},"Editar bash_command manualmente (solo aplica si elegiste script)"));
    wrap.appendChild(manualRow);

    function paramsFromUI(){
      const rows = Array.from(pList.querySelectorAll('[data-p-row="1"]'));
      const pairs = [];
      rows.forEach(r=>{
        const k = (r.querySelector('[data-p-k]')?.value || '').trim();
        const v = (r.querySelector('[data-p-v]')?.value || '').trim();
        if(k && v !== '') pairs.push([k,v]);
      });
      const allParm = pairs.length && pairs.every(([k,_]) => /^PARM\d+$/i.test(k));
      if(allParm){
        pairs.sort((a,b)=> parseInt(a[0].slice(4),10) - parseInt(b[0].slice(4),10));
      }
      const obj = {}; pairs.forEach(([k,v])=>{ obj[k]=v; });
      return {pairs, obj};
    }
    function syncParamsToHidden(){
      const {obj} = paramsFromUI();
      spTA.value = JSON.stringify(obj);
    }
    function argsFromParams(){
      const {pairs} = paramsFromUI();
      return pairs.map(([_,v])=> String(v).trim()).filter(Boolean).join(' ');
    }
    function buildCommandFromScript(){
      const dir = (dirInp.value || '').trim();
      const file = (fileInp.value || '').trim();
      const interp = shSel.value;
      const args = (argsInp.value || '').trim();
      if(!file){ return; }
      const safeDir = dir.replace(/"/g,'\\"');
      const safeFile = file.replace(/"/g,'\\"');
      const exe = (interp === 'direct') ? `./${safeFile}` : `${interp} "./${safeFile}"`;
      let cmd = exe + (args ? ` ${args}` : '');
      if(dir && cdChk.checked){ cmd = `cd "${safeDir}" && ${cmd}`; }
      cmdTA.value = cmd;
    }
    function syncAll(){
      syncParamsToHidden();
      argsInp.value = argsFromParams();
      if(modeSel.value === 'script' && !manualChk.checked){ buildCommandFromScript(); }
    }
    function addParamRow(k,v){
      const row = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap;", "data-p-row":"1"});
      const kk = el("input",{"data-p-k":"1", style:"min-width:160px;", value: k || ''});
      const vv = el("input",{"data-p-v":"1", style:"min-width:220px; flex:1;", value: v || ''});
      const rm = el("button",{class:"button ghost", type:"button"},"Quitar");
      rm.addEventListener('click', ()=>{ row.remove(); syncAll(); });
      kk.addEventListener('input', syncAll);
      vv.addEventListener('input', syncAll);
      row.appendChild(kk); row.appendChild(vv); row.appendChild(rm);
      pList.appendChild(row);
      syncAll();
    }
    pAdd.addEventListener('click', ()=>{
      const kk = (pK.value || '').trim();
      if(!kk) return;
      addParamRow(kk, pV.value || '');
      pK.value=''; pV.value='';
      pK.focus();
    });

    function applyMode(){
      const isScript = modeSel.value === 'script';
      scriptBox.style.display = isScript ? 'block' : 'none';
      manualRow.style.display = isScript ? 'flex' : 'none';
      if(!isScript){ cmdTA.readOnly = false; return; }
      cmdTA.readOnly = !manualChk.checked;
      if(!manualChk.checked) buildCommandFromScript();
    }

    modeSel.addEventListener('change', applyMode);
    manualChk.addEventListener('change', applyMode);
    [dirInp, fileInp, argsInp].forEach(inp=>inp.addEventListener('input', ()=>{ if(modeSel.value==='script' && !manualChk.checked) buildCommandFromScript(); }));
    shSel.addEventListener('change', ()=>{ if(modeSel.value==='script' && !manualChk.checked) buildCommandFromScript(); });
    cdChk.addEventListener('change', ()=>{ if(modeSel.value==='script' && !manualChk.checked) buildCommandFromScript(); });
    btnGen.addEventListener('click', ()=>{ if(modeSel.value==='script') buildCommandFromScript(); });

    applyMode();
  }

  if(type==="PythonOperator"){ add("python_callable_name","python_callable_name","my_callable"); add("python_callable_body","python_callable_body","print('Hello')",true); }
  if(type==="SqliteOperator"){ add("sqlite_conn_id","sqlite_conn_id","sqlite_default"); add("sql","sql","SELECT 1;"); }
  if(type==="PostgresOperator"){ add("postgres_conn_id","postgres_conn_id","postgres_default"); add("sql","sql","SELECT 1;"); }
  if(type==="MySqlOperator"){ add("mysql_conn_id","mysql_conn_id","mysql_default"); add("sql","sql","SELECT 1;"); }
  if(type==="MsSqlOperator"){ add("mssql_conn_id","mssql_conn_id","mssql_default"); add("sql","sql","SELECT 1;"); }
  if(type==="OracleOperator"){ add("oracle_conn_id","oracle_conn_id","oracle_default"); add("sql","sql","SELECT 1 FROM dual"); }
  if(type==="SnowflakeOperator"){ add("snowflake_conn_id","snowflake_conn_id","snowflake_default"); add("sql","sql","SELECT 1;"); }
  if(type==="S3CreateObjectOperator"){ add("aws_conn_id","aws_conn_id","aws_default"); add("s3_bucket","s3_bucket","my-bucket"); add("s3_key","s3_key","path/file.txt"); add("data","data","hello world"); }
  if(type==="LambdaInvokeFunctionOperator"){ add("aws_conn_id","aws_conn_id","aws_default"); add("function_name","function_name","my-fn"); add("payload","payload",'{"key":"value"}'); }
  if(type==="GlueJobOperator"){ add("aws_conn_id","aws_conn_id","aws_default"); add("job_name","job_name","my-job"); add("script_location","script_location","s3://bucket/script.py"); add("iam_role_name","iam_role_name","glue-role"); add("num_of_dpus","num_of_dpus","10"); }
  if(type==="BigQueryExecuteQueryOperator"){ add("gcp_conn_id","gcp_conn_id","google_cloud_default"); add("sql","sql","SELECT 1;"); add("use_legacy_sql","use_legacy_sql","false"); }
  if(type==="DataflowCreateJavaJobOperator"){ add("gcp_conn_id","gcp_conn_id","google_cloud_default"); add("jar","jar","/path/app.jar"); add("job_name","job_name","dataflow-job"); add("options","options",'{"key":"value"}'); }
  if(type==="AzureDataFactoryRunPipelineOperator"){ add("azure_data_factory_conn_id","azure_data_factory_conn_id","azure_data_factory_default"); add("pipeline_name","pipeline_name","pipeline1"); add("parameters","parameters",'{"p":1}'); }
  if(type==="DockerOperator"){ add("image","image","python:3.11"); add("api_version","api_version","auto"); add("command","command","echo hello"); add("docker_url","docker_url","unix://var/run/docker.sock"); add("auto_remove","auto_remove","true"); }
  if(type==="KubernetesPodOperator"){ add("name","name","pod-task"); add("namespace","namespace","default"); add("image","image","python:3.11"); add("cmds","cmds",'["python","-c"]'); add("arguments","arguments",'["print(\\"hi\\")"]'); add("env","env",'{"ENV":"value"}'); }
  if(type==="SparkSubmitOperator"){ add("application","application","/path/app.py"); add("conn_id","conn_id","spark_default"); add("application_args","application_args",'["--flag","value"]'); }
  if(type==="DatabricksSubmitRunOperator"){ add("databricks_conn_id","databricks_conn_id","databricks_default"); add("json","json",'{"run_name":"demo","new_cluster":{...}}',true); }
  if(type==="SimpleHttpOperator"){ add("http_conn_id","http_conn_id","http_default"); add("endpoint","endpoint","/"); add("method","method","GET"); add("data","data",""); add("headers","headers",'{"Content-Type":"application/json"}'); }
  if(type==="EmailOperator"){ add("to","to","example@example.com"); add("subject","subject","Airflow Notification"); add("html_content","html_content","Job done."); }

  if(type==="CustomOperator"){
    const help = el("div",{class:"muted"}, "Completa import path, class y kwargs (JSON).");
    wrap.appendChild(help);
    const row = el("div", {style:"display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px;"});
    const ip = el("div"); ip.appendChild(el("label",{},"import_path")); ip.appendChild(el("input",{"data-k":"import_path",placeholder:"airflow.providers.xxx.operators.yyy"}));
    const cl = el("div"); cl.appendChild(el("label",{},"class_name"));   cl.appendChild(el("input",{"data-k":"class_name",placeholder:"SomeOperator"}));
    row.appendChild(ip); row.appendChild(cl);
    wrap.appendChild(row);
    wrap.appendChild(el("label",{},"kwargs (JSON)"));
    wrap.appendChild(el("textarea",{"data-k":"kwargs",style:"height:120px;"}, "{\n  \n}"));
  }

  if(type==="SSHOperator"){
    const help = el("div",{class:"muted-note"},
      "Ejecuta en host remoto por SSH (usa Connection ssh_conn_id). " +
      "Elige comando directo o script (ruta + archivo) y agrega par√°metros (argumentos) si aplica."
    );
    wrap.appendChild(help);

    // Conexi√≥n
    wrap.appendChild(el("label",{},"ssh_conn_id"));
    const sshConn = el("input",{"data-k":"ssh_conn_id",placeholder:"ssh_default"});
    wrap.appendChild(sshConn);

    wrap.appendChild(el("label",{},"remote_host (opcional)"));
    const remoteHost = el("input",{"data-k":"remote_host",placeholder:"host remoto si tu Conn no lo define"});
    wrap.appendChild(remoteHost);

    // Tipo de ejecuci√≥n (solo UI; NO va a spec)
    wrap.appendChild(el("label",{},"tipo de ejecuci√≥n"));
    const modeSel = el("select",{"data-ui":"ssh_mode"});
    modeSel.innerHTML = '<option value="command" selected>comando</option><option value="script">script</option>';
    wrap.appendChild(modeSel);

    // Bloque script (solo UI)
    const scriptBox = el("div",{style:"margin-top:8px; padding:12px; border:1px dashed var(--border); border-radius:12px; display:none;"});
    scriptBox.appendChild(el("div",{class:"muted-note"},"Si eliges script: indica ruta + script. El command se autogenera y se guarda en el campo 'command'."));

    const sg = el("div",{class:"form-grid-3", style:"margin-top:8px;"});
    const dirDiv  = el("div",{});
    const fileDiv = el("div",{});
    const shDiv   = el("div",{});

    const dirInp  = el("input",{placeholder:"/opt/jobs"});
    const fileInp = el("input",{placeholder:"mi_job.ksh"});
    const shSel   = el("select",{});
    shSel.innerHTML = '<option value="ksh" selected>ksh</option><option value="bash">bash</option><option value="sh">sh</option><option value="direct">directo (ejecutable)</option>';

    dirDiv.appendChild(el("label",{},"ruta (directorio)"));
    dirDiv.appendChild(dirInp);
    fileDiv.appendChild(el("label",{},"script (archivo)"));
    fileDiv.appendChild(fileInp);
    shDiv.appendChild(el("label",{},"int√©rprete"));
    shDiv.appendChild(shSel);

    sg.appendChild(dirDiv);
    sg.appendChild(fileDiv);
    sg.appendChild(shDiv);
    scriptBox.appendChild(sg);

    const sg2 = el("div",{class:"form-grid-2", style:"margin-top:8px;"});
    const argsDiv = el("div",{});
    const cdDiv = el("div",{});

    const argsInp = el("input",{placeholder:"--param1 123 --flag (opcional)"});
    argsDiv.appendChild(el("label",{},"argumentos (opcional)"));
    argsDiv.appendChild(argsInp);

    const cdChk = el("input",{type:"checkbox"});
    cdChk.checked = true;
    cdDiv.appendChild(el("label",{},"ejecutar desde la ruta (cd)"));
    const cdRow = el("div",{style:"display:flex; gap:8px; align-items:center;"});
    cdRow.appendChild(cdChk);
    cdRow.appendChild(el("span",{class:"muted-note"},"(recomendado para scripts con rutas relativas)"));
    cdDiv.appendChild(cdRow);

    sg2.appendChild(argsDiv);
    sg2.appendChild(cdDiv);
    scriptBox.appendChild(sg2);

    const btnGen = el("button",{class:"button ghost", type:"button", style:"margin-top:8px;"},"Construir command");
    scriptBox.appendChild(btnGen);

    wrap.appendChild(scriptBox);

    // Command (s√≠ va a spec)
    wrap.appendChild(el("label",{},"command"));
    const cmdTA = el("textarea",{"data-k":"command",style:"height:88px;"},"echo 'hola'");
    wrap.appendChild(cmdTA);

    const manualRow = el("div",{style:"display:flex; gap:10px; align-items:center; margin-top:6px;"});
    const manualChk = el("input",{type:"checkbox"});
    manualRow.appendChild(manualChk);
    manualRow.appendChild(el("span",{class:"muted-note"},"Editar command manualmente (solo aplica si elegiste script)"));
    wrap.appendChild(manualRow);

    // Par√°metros para la shell (argumentos). NO son environment vars.
    const parmSection = el("div",{style:"margin-top:8px; padding:10px; border:1px solid var(--border); border-radius:12px; display:none;"});
    parmSection.appendChild(el("div",{class:"muted-note"},
      "Estos valores se agregan como argumentos al final del command del script (ej: split_file.ksh -r -c ...). " +
      "Si necesitas variables de entorno reales, usa el modo avanzado environment (JSON)."
    ));

    const argsManualRow = el("div",{style:"display:flex; gap:10px; align-items:center; margin-top:6px;"});
    const argsManualChk = el("input",{type:"checkbox"});
    argsManualRow.appendChild(argsManualChk);
    argsManualRow.appendChild(el("span",{class:"muted-note"},"Editar args manualmente"));
    parmSection.appendChild(argsManualRow);

    // Builder de par√°metros
    const pBox = el("div",{style:"margin-top:8px; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);"});
    const pRow = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap;"});
    const pK = el("input",{placeholder:"PARM1", style:"min-width:160px;"});
    const pV = el("input",{placeholder:"valor (ej: -r / *.log / /ruta)", style:"min-width:220px; flex:1;"});
    const pAdd = el("button",{class:"button ghost", type:"button"},"+ Agregar");
    pRow.appendChild(pK); pRow.appendChild(pV); pRow.appendChild(pAdd);
    const pList = el("div",{style:"margin-top:8px; display:flex; flex-direction:column; gap:6px;"});
    pBox.appendChild(pRow); pBox.appendChild(pList);
    parmSection.appendChild(pBox);

    // script_params se guarda en spec (opcional)
    const spTA = el("textarea",{"data-k":"script_params",style:"height:72px;"},'{}');
    const spDetails = el("details",{style:"margin-top:8px;"});
    spDetails.appendChild(el("summary",{},"Modo avanzado: script_params (JSON)"));
    spDetails.appendChild(spTA);
    parmSection.appendChild(spDetails);

    wrap.appendChild(parmSection);

    function paramsFromUI(){
      const rows = Array.from(pList.querySelectorAll('[data-p-row="1"]'));
      const pairs = [];
      rows.forEach(r=>{
        const k = (r.querySelector('[data-p-k]')?.value || '').trim();
        const v = (r.querySelector('[data-p-v]')?.value || '').trim();
        if(k && v !== '') pairs.push([k,v]);
      });
      // ordenar PARM\d+ si aplica
      const allParm = pairs.length && pairs.every(([k,_]) => /^PARM\d+$/i.test(k));
      if(allParm){
        pairs.sort((a,b)=> parseInt(a[0].slice(4),10) - parseInt(b[0].slice(4),10));
      }
      const obj = {};
      pairs.forEach(([k,v])=>{ obj[k]=v; });
      return {pairs, obj};
    }

    function syncParamsToTextarea(){
      try{ JSON.parse(spTA.value || "{}"); } catch { return; } // no pisar si inv√°lido
      const {obj} = paramsFromUI();
      spTA.value = JSON.stringify(obj);
    }

    function argsFromParams(){
      const {pairs} = paramsFromUI();
      return pairs.map(([_,v])=> String(v).trim()).filter(Boolean).join(' ');
    }

    function syncArgsFromParams(){
      if(argsManualChk.checked) return;
      argsInp.value = argsFromParams();
    }

    function addParamRow(k,v){
      const row = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap;", "data-p-row":"1"});
      const kk = el("input",{"data-p-k":"1", style:"min-width:160px;", value: k || ""});
      const vv = el("input",{"data-p-v":"1", style:"min-width:220px; flex:1;", value: v || ""});
      const rm = el("button",{class:"button ghost", type:"button"},"Quitar");

      function syncAll(){
        syncParamsToTextarea();
        syncArgsFromParams();
        if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript();
      }

      rm.addEventListener("click", ()=>{ row.remove(); syncAll(); });
      kk.addEventListener("input", syncAll);
      vv.addEventListener("input", syncAll);

      row.appendChild(kk);
      row.appendChild(vv);
      row.appendChild(rm);
      pList.appendChild(row);
      syncAll();
    }

    pAdd.addEventListener("click", ()=>{
      const kk = (pK.value || "").trim();
      if(!kk) return;
      addParamRow(kk, pV.value || "");
      pK.value = ""; pV.value = "";
      pK.focus();
    });

    argsManualChk.addEventListener("change", ()=>{
      argsInp.readOnly = !argsManualChk.checked;
      if(!argsManualChk.checked) syncArgsFromParams();
      if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript();
    });

    // Environment (JSON) real para spec (modo avanzado)
    const envTA = el("textarea",{"data-k":"environment",style:"height:72px;"},'{}');
    const envDetails = el("details",{style:"margin-top:8px;"});
    envDetails.appendChild(el("summary",{},"Modo avanzado: environment (JSON)"));
    envDetails.appendChild(envTA);
    wrap.appendChild(envDetails);

// Editor simple de environment (opcional). Se sincroniza con envTA.
// Nota: environment son variables de entorno reales del proceso remoto, NO argumentos.
wrap.appendChild(el("label",{},"variables de entorno (opcional)"));
const varBox = el("div",{style:"padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);"});
varBox.appendChild(el("div",{class:"muted-note"},
  "Estas variables se env√≠an como environment del comando remoto. " +
  "No son argumentos; para argumentos usa el bloque de Par√°metros/args."
));

const kvRow = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px;"});
const kInp = el("input",{placeholder:"NOMBRE_VAR", style:"min-width:180px;"});
const vInp = el("input",{placeholder:"valor", style:"min-width:220px; flex:1;"});
const addBtn = el("button",{class:"button ghost", type:"button"},"+ Agregar");
kvRow.appendChild(kInp);
kvRow.appendChild(vInp);
kvRow.appendChild(addBtn);

const list = el("div",{style:"margin-top:8px; display:flex; flex-direction:column; gap:6px;"});
varBox.appendChild(kvRow);
varBox.appendChild(list);
wrap.appendChild(varBox);


    // get_pty (s√≠ va a spec)
    wrap.appendChild(el("label",{},"get_pty"));
    const sel = el("select",{"data-k":"get_pty"});
    sel.innerHTML = '<option value="true">true</option><option value="false" selected>false</option>';
    wrap.appendChild(sel);

    // Helpers
    const dq = (s) => (s ?? "").replace(/\\/g,"\\\\").replace(/"/g,'\\"');

    function buildShellCall(shell, scriptRef){
      const q = `"${dq(scriptRef)}"`;
      if(shell === "direct") return q;
      return `${shell} ${q}`;
    }

    function envFromUI(){
      const env = {};
      Array.from(list.querySelectorAll('[data-env-row="1"]')).forEach(row=>{
        const kk = row.querySelector('[data-env-k]')?.value?.trim();
        const vv = row.querySelector('[data-env-v]')?.value ?? "";
        if(kk) env[kk] = vv;
      });
      return env;
    }

    function syncEnvToTextarea(){
      // Si el JSON actual es inv√°lido, no lo pisamos (para no romper el modo avanzado)
      try{ JSON.parse(envTA.value || "{}"); } catch { return; }
      envTA.value = JSON.stringify(envFromUI());
    }

    function addEnvRow(k, v){
      const row = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap;", "data-env-row":"1"});
      const kk = el("input",{"data-env-k":"1", style:"min-width:180px;", value: k || ""});
      const vv = el("input",{"data-env-v":"1", style:"min-width:220px; flex:1;", value: v || ""});
      const rm = el("button",{class:"button ghost", type:"button"},"Quitar");

      rm.addEventListener("click", ()=>{ row.remove(); syncEnvToTextarea(); });
      kk.addEventListener("input", syncEnvToTextarea);
      vv.addEventListener("input", syncEnvToTextarea);

      row.appendChild(kk);
      row.appendChild(vv);
      row.appendChild(rm);
      list.appendChild(row);
      syncEnvToTextarea();
    }

    addBtn.addEventListener("click", ()=>{
      const kk = (kInp.value || "").trim();
      if(!kk) return;
      addEnvRow(kk, vInp.value ?? "");
      kInp.value = ""; vInp.value = "";
      kInp.focus();
    });

    function buildCommandFromScript(){
      const dir  = (dirInp.value || "").trim();
      const file = (fileInp.value || "").trim();
      const args = (argsInp.value || "").trim();
      const shell = shSel.value || "ksh";
      if(!file){
        cmdTA.value = "";
        return;
      }
      let cmd = "";
      if(dir){
        if(cdChk.checked){
          const ref = (file.startsWith("./") || file.startsWith("/") ) ? file : `./${file}`;
          cmd = `cd "${dq(dir)}" && ${buildShellCall(shell, ref)}`;
        }else{
          const cleanDir = dir.replace(/\/+$/,"");
          const cleanFile = file.replace(/^\/+/, "");
          const full = `${cleanDir}/${cleanFile}`;
          cmd = buildShellCall(shell, full);
        }
      }else{
        cmd = buildShellCall(shell, file);
      }
      if(args) cmd += ` ${args}`;
      cmdTA.value = cmd;
    }

    function applyMode(){
      const m = modeSel.value || "command";
      const isScript = (m === "script");
      scriptBox.style.display = isScript ? "block" : "none";
      parmSection.style.display = isScript ? "block" : "none";

      if(isScript){
        // args: por defecto se construyen desde script_params
        argsInp.readOnly = !argsManualChk.checked;
        if(!argsManualChk.checked) syncArgsFromParams();

        cmdTA.readOnly = !manualChk.checked;
        if(!manualChk.checked){
          buildCommandFromScript();
        }
      }else{
        cmdTA.readOnly = false;
      }
    }

    // Eventos
    modeSel.addEventListener("change", applyMode);
    manualChk.addEventListener("change", applyMode);

    [dirInp, fileInp, argsInp].forEach(inp=>{
      inp.addEventListener("input", ()=>{ if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript(); });
    });
    shSel.addEventListener("change", ()=>{ if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript(); });
    cdChk.addEventListener("change", ()=>{ if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript(); });
    btnGen.addEventListener("click", ()=>{ if(modeSel.value==="script") buildCommandFromScript(); });

    // Estado inicial
    applyMode();
  }

  if(type==="WinRMOperator"){
    const help = el("div",{class:"muted-note"}, "Ejecuta comando en Windows por WinRM (usa Connection winrm_conn_id). Puedes elegir comando directo o script.");
    wrap.appendChild(help);

    wrap.appendChild(el("label",{},"winrm_conn_id"));
    wrap.appendChild(el("input",{"data-k":"winrm_conn_id",placeholder:"winrm_default"}));

    wrap.appendChild(el("label",{},"powershell"));
    const psSel = el("select",{"data-k":"powershell"});
    psSel.innerHTML='<option value="true" selected>true</option><option value="false">false</option>';
    wrap.appendChild(psSel);

    wrap.appendChild(el("label",{},"tipo de ejecucion"));
    const modeSel = el("select",{"data-ui":"winrm_mode"});
    modeSel.innerHTML = '<option value="command" selected>comando</option><option value="script">script</option>';
    wrap.appendChild(modeSel);

    const scriptBox = el("div",{style:"margin-top:8px; padding:12px; border:1px dashed var(--border); border-radius:12px; display:none;"});
    scriptBox.appendChild(el("div",{class:"muted-note"},"Si eliges script: indica ruta + script + args. El command se autogenera."));

    const sg = el("div",{class:"form-grid-2", style:"margin-top:8px;"});
    const dirDiv = el("div",{});
    const fileDiv = el("div",{});
    const dirInp = el("input",{placeholder:"C:\\Jobs"});
    const fileInp = el("input",{placeholder:"mi_script.ps1 / .bat"});
    dirDiv.appendChild(el("label",{},"ruta (directorio)"));
    dirDiv.appendChild(dirInp);
    fileDiv.appendChild(el("label",{},"script (archivo)"));
    fileDiv.appendChild(fileInp);
    sg.appendChild(dirDiv);
    sg.appendChild(fileDiv);
    scriptBox.appendChild(sg);

    const argsInp = el("input",{placeholder:"-Param 123 -Flag (opcional)"});
    scriptBox.appendChild(el("label",{style:"margin-top:8px;"},"argumentos (opcional)"));
    scriptBox.appendChild(argsInp);

    const cdChk = el("input",{type:"checkbox"});
    cdChk.checked = true;
    const cdRow = el("div",{style:"display:flex; gap:8px; align-items:center; margin-top:8px;"});
    cdRow.appendChild(cdChk);
    cdRow.appendChild(el("span",{class:"muted-note"},"ejecutar desde la ruta (cd)"));
    scriptBox.appendChild(cdRow);

    const btnGen = el("button",{class:"button ghost", type:"button", style:"margin-top:8px;"},"Construir command");
    scriptBox.appendChild(btnGen);

    wrap.appendChild(scriptBox);

    wrap.appendChild(el("label",{},"command"));
    const cmdTA = el("textarea",{"data-k":"command",style:"height:88px;"},"Write-Output 'hola'");
    wrap.appendChild(cmdTA);

    const manualRow = el("div",{style:"display:flex; gap:10px; align-items:center; margin-top:6px;"});
    const manualChk = el("input",{type:"checkbox"});
    manualRow.appendChild(manualChk);
    manualRow.appendChild(el("span",{class:"muted-note"},"Editar command manualmente (solo aplica si elegiste script)"));
    wrap.appendChild(manualRow);

    function buildCommandFromScript(){
      const dir = (dirInp.value || '').trim();
      const file = (fileInp.value || '').trim();
      const args = (argsInp.value || '').trim();
      const ps = String(psSel.value || 'true').toLowerCase() === 'true';
      if(!file){ return; }

      const safeDir = dir.replace(/"/g,'\\"');
      const safeFile = file.replace(/"/g,'\\"');

      let cmd = '';
      if(ps){
        if(dir && cdChk.checked){
          cmd = `cd \"${safeDir}\"; & \".\\\\${safeFile}\"${args ? ` ${args}` : ''}`;
        }else if(dir){
          const join = (safeDir.endsWith('\\\\') || safeDir.endsWith('\\')) ? safeDir : (safeDir + '\\\\');
          cmd = `& \"${join}${safeFile}\"${args ? ` ${args}` : ''}`;
        }else{
          cmd = `& \"${safeFile}\"${args ? ` ${args}` : ''}`;
        }
      }else{
        if(dir && cdChk.checked){
          cmd = `cd /d \"${safeDir}\" && \"${safeFile}\"${args ? ` ${args}` : ''}`;
        }else{
          cmd = `\"${safeFile}\"${args ? ` ${args}` : ''}`;
        }
      }
      cmdTA.value = cmd;
    }

    function applyMode(){
      const isScript = modeSel.value === 'script';
      scriptBox.style.display = isScript ? 'block' : 'none';
      manualRow.style.display = isScript ? 'flex' : 'none';
      if(!isScript){ cmdTA.readOnly = false; return; }
      cmdTA.readOnly = !manualChk.checked;
      if(!manualChk.checked) buildCommandFromScript();
    }

    modeSel.addEventListener('change', applyMode);
    manualChk.addEventListener('change', applyMode);
    psSel.addEventListener('change', ()=>{ if(modeSel.value==='script' && !manualChk.checked) buildCommandFromScript(); });
    [dirInp, fileInp, argsInp].forEach(inp=>inp.addEventListener('input', ()=>{ if(modeSel.value==='script' && !manualChk.checked) buildCommandFromScript(); }));
    cdChk.addEventListener('change', ()=>{ if(modeSel.value==='script' && !manualChk.checked) buildCommandFromScript(); });
    btnGen.addEventListener('click', ()=>{ if(modeSel.value==='script') buildCommandFromScript(); });

    applyMode();
  }
const adv = el("details",{style:"margin-top:8px;"});
adv.appendChild(el("summary",{}, "Avanzado"));
adv.appendChild(el("div",{class:"muted-note", style:"margin-top:6px;"}, "Pool/recursos se configuran en Dependencies -> Recursos."));
// Hidden fields para pool/pool_slots/resources (los edita el panel de Dependencies)
const poolInp = el("input",{"data-k":"pool",style:"display:none;"});
const slotsInp = el("input",{"data-k":"pool_slots",style:"display:none;", value:"1"});
const resourcesTA = el("textarea",{"data-k":"resources",style:"display:none;height:72px;"}, "[]");
adv.appendChild(poolInp);
adv.appendChild(slotsInp);
adv.appendChild(resourcesTA);

const grid2 = el("div",{style:"display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px;margin-top:8px;"});
const qWrap = el("div",{});
qWrap.appendChild(el("label",{},"queue (opcional)"));
qWrap.appendChild(el("input",{"data-k":"queue",placeholder:"celery queue"}));
const pwWrap = el("div",{});
pwWrap.appendChild(el("label",{},"priority_weight (opcional)"));
pwWrap.appendChild(el("input",{"data-k":"priority_weight",type:"number",min:"1",step:"1"}));
const dopWrap = el("div",{});
dopWrap.appendChild(el("label",{},"depends_on_past"));
const dopSel = el("select",{"data-k":"depends_on_past"});
dopSel.innerHTML = "<option value=\"false\" selected>false</option><option value=\"true\">true</option>";
dopWrap.appendChild(dopSel);
const tcWrap = el("div",{});
tcWrap.appendChild(el("label",{},"task_concurrency (opcional)"));
tcWrap.appendChild(el("input",{"data-k":"task_concurrency",type:"number",min:"1",step:"1"}));
grid2.appendChild(qWrap);
grid2.appendChild(pwWrap);
grid2.appendChild(dopWrap);
grid2.appendChild(tcWrap);
adv.appendChild(grid2);
wrap.appendChild(adv);

  const del = el("button",{},"Eliminar");
  del.onclick = () => { wrap.remove(); refreshTaskSelects(); updateGraph(); };
  wrap.appendChild(el("div",{style:"margin-top:6px;"})).appendChild(del);

  document.getElementById("tasks").appendChild(wrap);
  refreshTaskSelects();
  updateGraph();
}

/* Dependencias */
function makeTaskSelect(selected){
  const sel = el("select", {"data-k":"_sel"});
  taskIdOptions().forEach(id => {
    const opt = el("option",{value:id}, id);
    if(id === selected) opt.selected = true;
    sel.appendChild(opt);
  });
  return sel;
}
function addDep(){
  const wrap = el("div",{class:"section-card"});
  wrap.appendChild(el("label",{},"upstream"));
  wrap.appendChild(makeTaskSelect());
  wrap.appendChild(el("label",{},"downstream"));
  wrap.appendChild(makeTaskSelect());
  const del = el("button",{},"Eliminar");
  del.onclick = () => { wrap.remove(); updateGraph(); };
  wrap.appendChild(el("div",{style:"margin-top:6px;"})).appendChild(del);
  document.getElementById("deps").appendChild(wrap);
  updateGraph();
}
function makeDownstreamSelect(selected){
  const sel = el("select", {"data-k":"downstream", style:"width:100%;"});
  taskIdOptions().forEach(id => sel.appendChild(el("option",{value:id}, id)));
  if(selected) sel.value = selected;
  return sel;
}
function addExternalDep(){
  const wrap = el("div",{class:"section-card"});
  wrap.appendChild(el("label",{},"external_dag_id"));
  wrap.appendChild(el("input",{"data-k":"external_dag_id",placeholder:"otro_dag_id"}));
  wrap.appendChild(el("label",{},"external_task_id (opcional)"));
  wrap.appendChild(el("input",{"data-k":"external_task_id",placeholder:"(vac√≠o => espera al DAG)"}));
  wrap.appendChild(el("label",{},"mode (poke/reschedule)"));
  wrap.appendChild(el("input",{"data-k":"mode",value:"reschedule"}));
  wrap.appendChild(el("label",{},"poke_interval (s)"));
  wrap.appendChild(el("input",{"data-k":"poke_interval",type:"number",value:"60"}));
  wrap.appendChild(el("label",{},"timeout (s)"));
  wrap.appendChild(el("input",{"data-k":"timeout",type:"number",value:"3600"}));
  wrap.appendChild(el("label",{},"Conectar a (downstream local)"));
  wrap.appendChild(makeDownstreamSelect()); /* <- fix sin par√©ntesis extra */
  const del = el("button",{},"Eliminar");
  del.onclick = () => { wrap.remove(); updateGraph(); };
  wrap.appendChild(el("div",{style:"margin-top:6px;"})).appendChild(del);
  document.getElementById("extdeps").appendChild(wrap);
  updateGraph();
}



/* Assets (condiciones) - panel en Dependencies */
function makeAssetTaskSelect(selected){
  const sel = el("select", {"data-k":"task_id", style:"width:100%;"});
  taskIdOptions().forEach(id => sel.appendChild(el("option",{value:id}, id)));
  if(selected) sel.value = selected;
  return sel;
}
function _autoAssetUri(taskId){
  const p = (document.getElementById('asset_prefix')?.value || 'asset://cond/').trim() || 'asset://cond/';
  const dag = (document.getElementById('dag_id')?.value || 'dag').trim() || 'dag';
  // Por defecto incluye dag_id + task_id para evitar colisiones. Puedes editarlo manualmente si quieres referenciar otro DAG.
  return `${p}${dag}/${taskId}_done`;
}
function addAssetLinkRow(containerId, kind){
  const wrap = el("div",{class:"section-card", style:"margin-top:8px;"});
  wrap.appendChild(el("label",{}, "task"));
  const sel = makeAssetTaskSelect();
  wrap.appendChild(sel);

  wrap.appendChild(el("label",{}, "asset_uri"));
  const inp = el("input", {"data-k":"uri", placeholder:"asset://cond/<dag>/<task>_done"});
  wrap.appendChild(inp);

  const actions = el("div",{style:"display:flex; gap:8px; margin-top:6px; flex-wrap:wrap;"});
  const btnAuto = el("button",{class:"button ghost", type:"button"}, "Auto");
  btnAuto.onclick = () => { inp.value = _autoAssetUri(sel.value || 'task'); };
  const del = el("button",{class:"button ghost", type:"button"}, "Eliminar");
  del.onclick = () => wrap.remove();
  actions.appendChild(btnAuto);
  actions.appendChild(del);
  wrap.appendChild(actions);

  document.getElementById(containerId).appendChild(wrap);
}
function setAssetsUiEnabled(on){
  const panelIds = ['asset_logic','asset_prefix','add_asset_inlet','add_asset_outlet'];
  panelIds.forEach(id => {
    const elx = document.getElementById(id);
    if(elx) elx.disabled = !on;
  });
  ['asset_inlets','asset_outlets'].forEach(cid=>{
    document.querySelectorAll(`#${cid} input, #${cid} select, #${cid} button`).forEach(x=>x.disabled = !on);
  });
  const root = document.getElementById('assets_on')?.closest('.section-card');
  if(root) root.style.opacity = on ? '1' : '.55';
}
document.getElementById('assets_on')?.addEventListener('change', (e)=>setAssetsUiEnabled(!!e.target.checked));
document.getElementById('add_asset_inlet')?.addEventListener('click', ()=>addAssetLinkRow('asset_inlets','inlet'));
document.getElementById('add_asset_outlet')?.addEventListener('click', ()=>addAssetLinkRow('asset_outlets','outlet'));

// default UI state
setAssetsUiEnabled(!!document.getElementById('assets_on')?.checked);




// Opci√≥n B: Assets + ciclo cada 5 minutos (24x7)
function applyOptionB(on){
  if(!on) return; // no deshace autom√°ticamente

  // 1) Habilitar Assets
  const aOn = document.getElementById('assets_on');
  if(aOn){
    aOn.checked = true;
    setAssetsUiEnabled(true);
  }

  // 2) Forzar un schedule c√≠clico cada 5 min en todo el d√≠a
  const kind = document.getElementById('schedule_kind');
  if(kind){
    kind.value = '@daily';
    showSchedGroups('@daily');
  }

  const cycOn = document.getElementById('cyclic_on');
  if(cycOn) cycOn.checked = true;

  const unit = document.getElementById('cyclic_unit');
  if(unit) unit.value = 'minutes';

  const n = document.getElementById('cyclic_n');
  if(n) n.value = 5;

  const f = document.getElementById('cyc_from');
  if(f) f.value = 0;

  const t = document.getElementById('cyc_to');
  if(t) t.value = 23;

  // ajustar UI por unidad y recalcular cron
  if(typeof toggleCyclicUnitFields === 'function') toggleCyclicUnitFields();
  if(typeof syncCronFromUI === 'function') syncCronFromUI();
}

document.getElementById('mode_b_on')?.addEventListener('change', (e)=> applyOptionB(!!e.target.checked));

/* Recursos (Pools) - panel en Dependencies */
function _findTaskCardById(taskId){
  const cards = Array.from(document.querySelectorAll('#tasks > .section-card'));
  return cards.find(c => (c.querySelector('[data-k="task_id"]')?.value || '') === taskId);
}
function _resEls(taskId){
  const card = _findTaskCardById(taskId);
  if(!card) return null;
  const pool = card.querySelector('[data-k="pool"]');
  const slots = card.querySelector('[data-k="pool_slots"]');
  const res = card.querySelector('[data-k="resources"]');
  return {card, pool, slots, res};
}
function _resRead(taskId){
  const e = _resEls(taskId);
  if(!e || !e.res) return [];
  try{ return JSON.parse(e.res.value || '[]') || []; }catch{ return []; }
}
function _resWrite(taskId, list){
  const e = _resEls(taskId);
  if(!e || !e.res) return;
  e.res.value = JSON.stringify(list || []);
  const applied = (list || []).find(x=>x.primary) || (list || [])[0];
  if(applied && e.pool && e.slots){
    e.pool.value = applied.pool || '';
    e.slots.value = String(applied.slots || 1);
  }else if(e.pool && e.slots){
    e.pool.value = '';
    e.slots.value = '1';
  }
}

function initResDepsPanel(){
  const host = document.getElementById('resdeps');
  if(!host) return null;

  const box = el('div', {style:'display:flex; flex-direction:column; gap:10px;'});

  const selRow = el('div', {style:'display:grid; grid-template-columns: 220px 1fr; gap:10px; align-items:end;'});
  const tDiv = el('div', {});
  tDiv.appendChild(el('label', {}, 'tarea'));
  const tSel = el('select', {id:'res_task_sel', style:'width:100%;'});
  tDiv.appendChild(tSel);

  const noteDiv = el('div', {});
  noteDiv.appendChild(el('div', {class:'muted-note', style:'margin-bottom:4px;'}, 'Recursos al estilo Control-M. Marca 1 como aplicado (pool real en Airflow).'));
  noteDiv.appendChild(el('div', {class:'muted-note'}, 'Exclusivo => slots=1. Cuantitativo => slots=N.'));

  selRow.appendChild(tDiv);
  selRow.appendChild(noteDiv);
  box.appendChild(selRow);

  const form = el('div', {style:'display:grid; grid-template-columns: 180px 1fr 160px 200px; gap:8px; align-items:end;'});

  const typeDiv = el('div', {});
  typeDiv.appendChild(el('label', {}, 'tipo'));
  const typeSel = el('select', {id:'res_type', style:'width:100%;'});
  typeSel.innerHTML = '<option value="quant" selected>Cuantitativo</option><option value="exclusive">Exclusivo</option>';
  typeDiv.appendChild(typeSel);

  const poolDiv = el('div', {});
  poolDiv.appendChild(el('label', {}, 'recurso / pool'));
  const poolInp = el('input', {id:'res_pool', placeholder:'POOL_NAME', style:'width:100%;'});
  poolDiv.appendChild(poolInp);

  const slotsDiv = el('div', {});
  slotsDiv.appendChild(el('label', {}, 'slots'));
  const slotsInp = el('input', {id:'res_slots', type:'number', min:'1', step:'1', value:'1', style:'width:100%;'});
  slotsDiv.appendChild(slotsInp);

  const btnDiv = el('div', {});
  btnDiv.appendChild(el('label', {}, ''));
  const addBtn = el('button', {class:'button ghost', type:'button', id:'res_add', style:'width:100%;'}, '+ Agregar');
  btnDiv.appendChild(addBtn);

  form.appendChild(typeDiv);
  form.appendChild(poolDiv);
  form.appendChild(slotsDiv);
  form.appendChild(btnDiv);
  box.appendChild(form);

  const listWrap = el('div', {id:'res_list', style:'display:flex; flex-direction:column; gap:6px;'});
  box.appendChild(listWrap);

  host.appendChild(box);

  let currentTask = '';

  function render(){
    listWrap.innerHTML = '';
    if(!currentTask){
      listWrap.appendChild(el('div', {class:'muted-note'}, '(no hay tareas)'));
      return;
    }
    const arr = _resRead(currentTask);
    if(!arr.length){
      listWrap.appendChild(el('div', {class:'muted-note'}, '(sin recursos configurados)'));
      return;
    }

    arr.forEach((it, idx)=>{
      const row = el('div', {style:'display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:8px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);'});

      const radio = el('input', {type:'radio', name:'res_primary_global'});
      radio.checked = !!it.primary;

      const editType = el('select', {});
      editType.innerHTML = '<option value="quant">Cuantitativo</option><option value="exclusive">Exclusivo</option>';
      editType.value = it.type || 'quant';

      const editPool = el('input', {value: it.pool || '', style:'min-width:220px; flex:1;'});
      const editSlots = el('input', {type:'number', min:'1', step:'1', value: String(it.slots || 1), style:'width:120px;'});
      if(editType.value==='exclusive'){
        editSlots.value='1';
        editSlots.disabled=true;
      }

      const rm = el('button', {class:'button ghost', type:'button'}, 'Quitar');

      function save(){
        const cur = _resRead(currentTask);
        if(!cur[idx]) return;
        cur[idx].type = editType.value;
        cur[idx].pool = (editPool.value || '').trim();
        cur[idx].slots = (cur[idx].type==='exclusive') ? 1 : Math.max(1, parseInt(editSlots.value||'1',10));
        _resWrite(currentTask, cur);
      }

      radio.addEventListener('change', ()=>{
        const cur = _resRead(currentTask);
        cur.forEach((x,i)=> x.primary = (i===idx));
        _resWrite(currentTask, cur);
        render();
      });

      editType.addEventListener('change', ()=>{
        if(editType.value==='exclusive'){
          editSlots.value='1';
          editSlots.disabled=true;
        }else{
          editSlots.disabled=false;
        }
        save();
        render();
      });
      editPool.addEventListener('input', save);
      editSlots.addEventListener('input', save);

      rm.addEventListener('click', ()=>{
        const cur = _resRead(currentTask);
        cur.splice(idx,1);
        if(cur.length && !cur.some(x=>x.primary)) cur[0].primary=true;
        _resWrite(currentTask, cur);
        render();
      });

      row.appendChild(radio);
      row.appendChild(el('span',{class:'pill'}, editType.value==='exclusive' ? 'Exclusivo' : 'Cuantitativo'));
      row.appendChild(editType);
      row.appendChild(editPool);
      row.appendChild(editSlots);
      row.appendChild(rm);

      listWrap.appendChild(row);
    });
  }

  function setCurrentTask(tid){
    currentTask = tid || '';
    render();
  }

  function refresh(ids){
    const cur = tSel.value;
    tSel.innerHTML = '';
    (ids || []).forEach(id=> tSel.appendChild(el('option', {value:id}, id)));
    if(ids && ids.length){
      if(cur && ids.includes(cur)) tSel.value = cur;
      else tSel.value = ids[0];
      setCurrentTask(tSel.value);
    }else{
      setCurrentTask('');
    }
  }

  // type behavior
  typeSel.addEventListener('change', ()=>{
    if(typeSel.value==='exclusive'){
      slotsInp.value='1';
      slotsInp.disabled=true;
    }else{
      slotsInp.disabled=false;
    }
  });

  tSel.addEventListener('change', ()=> setCurrentTask(tSel.value));

  addBtn.addEventListener('click', ()=>{
    if(!currentTask) return;
    const pool = (poolInp.value || '').trim();
    if(!pool) return;
    const arr = _resRead(currentTask);
    const item = {
      type: (typeSel.value==='exclusive' ? 'exclusive' : 'quant'),
      pool: pool,
      slots: (typeSel.value==='exclusive' ? 1 : Math.max(1, parseInt(slotsInp.value||'1',10))),
      primary: false
    };
    if(!arr.length) item.primary = true;
    arr.push(item);
    if(arr.length && !arr.some(x=>x.primary)) arr[0].primary = true;
    _resWrite(currentTask, arr);
    poolInp.value='';
    slotsInp.value='1';
    poolInp.focus();
    render();
  });

  return { refresh, render, setCurrentTask };
}



/* Args/Params - panel en Dependencies */
function _argEls(taskId){
  const card = _findTaskCardById(taskId);
  if(!card) return null;
  return {
    card,
    argset: card.querySelector('[data-k="argset_ref"]'),
    append: card.querySelector('[data-k="append_args"]'),
    params: card.querySelector('[data-k="params"]'),
  };
}
function _argRead(taskId){
  const e=_argEls(taskId);
  if(!e) return { argset_ref:'', append_args:'', params:{} };
  let p={};
  try{ p = JSON.parse(e.params?.value || '{}') || {}; }catch(_){ p = {}; }
  return { argset_ref: e.argset?.value || '', append_args: e.append?.value || '', params: p };
}
function _argWrite(taskId, data){
  const e=_argEls(taskId);
  if(!e) return;
  if(e.argset) e.argset.value = data.argset_ref || '';
  if(e.append) e.append.value = data.append_args || '';
  if(e.params) e.params.value = JSON.stringify(data.params || {});
}

function initArgsDepsPanel(){
  const host = document.getElementById('argdeps');
  if(!host) return null;

  const box = el('div', {style:'display:flex; flex-direction:column; gap:10px;'});

  const top = el('div', {style:'display:grid; grid-template-columns: 220px 220px 1fr; gap:10px; align-items:end;'});
  const tDiv = el('div', {});
  tDiv.appendChild(el('label', {}, 'tarea'));
  const tSel = el('select', {id:'arg_task_sel', style:'width:100%;'});
  tDiv.appendChild(tSel);

  const aDiv = el('div', {});
  aDiv.appendChild(el('label', {}, 'argset'));
  const aSel = el('select', {id:'arg_argset_sel', style:'width:100%;'});
  aDiv.appendChild(aSel);

  const apDiv = el('div', {});
  apDiv.appendChild(el('label', {}, 'args extra (append)'));
  const apInp = el('input', {id:'arg_append', placeholder:'-x 1 --flag (opcional)', style:'width:100%;'});
  apDiv.appendChild(apInp);

  top.appendChild(tDiv); top.appendChild(aDiv); top.appendChild(apDiv);
  box.appendChild(top);

  // params editor
  const pCard = el('div', {style:'padding:10px; border:1px dashed var(--border); border-radius:12px;'});
  pCard.appendChild(el('div',{class:'muted-note', style:'margin-bottom:8px;'}, 'Params por tarea (merge con params globales; la tarea sobreescribe).'));

  const pForm = el('div', {style:'display:grid; grid-template-columns: 180px 1fr 140px; gap:8px; align-items:end;'});
  const pkDiv = el('div', {});
  pkDiv.appendChild(el('label', {}, 'key'));
  const pkInp = el('input', {placeholder:'fecha'});
  pkDiv.appendChild(pkInp);

  const pvDiv = el('div', {});
  pvDiv.appendChild(el('label', {}, 'value'));
  const pvInp = el('input', {placeholder:'{{ ds }}'});
  pvDiv.appendChild(pvInp);

  const pbDiv = el('div', {});
  pbDiv.appendChild(el('label', {}, ''));
  const pAdd = el('button', {class:'button ghost', type:'button'}, '+ Agregar');
  pbDiv.appendChild(pAdd);

  pForm.appendChild(pkDiv); pForm.appendChild(pvDiv); pForm.appendChild(pbDiv);
  pCard.appendChild(pForm);

  const pList = el('div', {id:'arg_params_list', style:'display:flex; flex-direction:column; gap:6px; margin-top:10px;'});
  pCard.appendChild(pList);
  box.appendChild(pCard);

  host.appendChild(box);

  let currentTask = '';
  let cur = { argset_ref:'', append_args:'', params:{} };

  function refreshArgsets(){
    const argsets = window.builderState.argsets || {};
    const curVal = aSel.value;
    aSel.innerHTML = '';
    aSel.appendChild(el('option', {value:''}, '(ninguno)'));
    Object.keys(argsets).sort().forEach(name=> aSel.appendChild(el('option', {value:name}, name)));
    if(curVal && [...aSel.options].some(o=>o.value===curVal)) aSel.value = curVal;
  }

  function renderParams(){
    pList.innerHTML='';
    const keys = Object.keys(cur.params || {});
    if(!keys.length){
      pList.appendChild(el('div',{class:'muted-note'}, '(sin params en la tarea)'));
      return;
    }
    keys.sort().forEach((k)=>{
      const row = el('div', {style:'display:grid; grid-template-columns: 180px 1fr 120px; gap:8px; align-items:center; padding:8px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);'});
      const kk = el('input', {value:k});
      const vv = el('input', {value:String(cur.params[k] ?? '')});
      const rm = el('button', {class:'button ghost', type:'button'}, 'Quitar');

      function saveKey(){
        const nk = (kk.value||'').trim();
        if(!nk) return;
        if(nk !== k){
          const val = cur.params[k];
          delete cur.params[k];
          cur.params[nk] = val;
        }
        cur.params[kk.value.trim()] = vv.value;
        _argWrite(currentTask, cur);
        renderParams();
      }
      function saveVal(){
        cur.params[kk.value.trim() || k] = vv.value;
        _argWrite(currentTask, cur);
      }

      kk.addEventListener('change', saveKey);
      vv.addEventListener('input', saveVal);
      rm.addEventListener('click', ()=>{ delete cur.params[k]; _argWrite(currentTask, cur); renderParams(); });

      row.appendChild(kk); row.appendChild(vv); row.appendChild(rm);
      pList.appendChild(row);
    });
  }

  function loadTask(tid){
    currentTask = tid || '';
    if(!currentTask){
      cur = { argset_ref:'', append_args:'', params:{} };
      apInp.value='';
      refreshArgsets();
      aSel.value='';
      renderParams();
      return;
    }
    cur = _argRead(currentTask);
    refreshArgsets();
    aSel.value = cur.argset_ref || '';
    apInp.value = cur.append_args || '';
    renderParams();
  }

  function refresh(ids){
    const prev = tSel.value;
    tSel.innerHTML='';
    (ids||[]).forEach(id => tSel.appendChild(el('option',{value:id}, id)));
    if(ids && ids.length){
      if(prev && ids.includes(prev)) tSel.value = prev;
      else tSel.value = ids[0];
      loadTask(tSel.value);
    }else{
      loadTask('');
    }
  }

  // events
  tSel.addEventListener('change', ()=> loadTask(tSel.value));
  aSel.addEventListener('change', ()=>{ cur.argset_ref = aSel.value || ''; _argWrite(currentTask, cur); });
  apInp.addEventListener('input', ()=>{ cur.append_args = apInp.value || ''; _argWrite(currentTask, cur); });

  pAdd.addEventListener('click', ()=>{
    const k = (pkInp.value||'').trim();
    if(!k || !currentTask) return;
    cur.params = cur.params || {};
    cur.params[k] = pvInp.value || '';
    _argWrite(currentTask, cur);
    pkInp.value=''; pvInp.value=''; pkInp.focus();
    renderParams();
  });

  // initial
  refresh(taskIdOptions());
  refreshArgsets();

  return { refresh, refreshArgsets };
}

window.__resMgr = initResDepsPanel();
if(window.__resMgr){ window.__resMgr.refresh(taskIdOptions()); }
/* Toolbar + selects */
(function initOps(){
  const sel = document.getElementById("opsel");
  if(sel){ OP_TYPES.forEach(([k,v])=> sel.appendChild(el("option",{value:v}, `${k} ‚Äî ${v}`))); }
  document.getElementById("add_op")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask(sel.value); });
  document.getElementById("add_empty")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("EmptyOperator"); });
  document.getElementById("add_bash")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("BashOperator"); });
  document.getElementById("add_python")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("PythonOperator"); });
  document.getElementById("add_dep")?.addEventListener("click", (e)=>{ e.preventDefault(); addDep(); });
  document.getElementById("add_extdep")?.addEventListener("click", (e)=>{ e.preventDefault(); addExternalDep(); });
  document.getElementById("add_custom")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("CustomOperator"); });
  document.getElementById("add_ssh")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("SSHOperator"); });
  document.getElementById("add_winrm")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("WinRMOperator"); });
})();

/* ===== Collect + Preview/Download ===== */
function qAll(root, sel){ return Array.from((root||document).querySelectorAll(sel)); }
function collect(){
  const taskCards = qAll(document, "#tasks > .section-card");
  let tasks = taskCards.map(card => {
    const o = {};
    qAll(card, "[data-k]").forEach(inp => {
      const k = inp.getAttribute("data-k");
      o[k] = (k === "task_id") ? normId(inp.value) : inp.value;
    });
    return o;
  });
  tasks = ensureUniqueTaskIds(tasks);

    // --- Dependencias internas ---
  const deps = qAll(document, "#deps > .section-card").map(card => {
    const [upSel, downSel] = qAll(card, 'select[data-k="_sel"]');
    return { upstream: upSel?.value || "", downstream: downSel?.value || "" };
  });

    // --- Dependencias externas -> ExternalTaskSensor + edge ---
  const extDeps = qAll(document, "#extdeps > .section-card").map(card => {
    const ext = {}; qAll(card, "[data-k]").forEach(inp => ext[inp.getAttribute("data-k")] = inp.value); return ext;
  });
  extDeps.forEach((e, idx) => {
    const ets_id = normId(`wait_${e.external_dag_id}_${e.external_task_id || "dag"}`) + (idx ? `_${idx+1}` : "");
    tasks.push({
      type: "ExternalTaskSensor", task_id: ets_id, external_dag_id: e.external_dag_id,
      external_task_id: e.external_task_id || null, mode: e.mode || "reschedule",
      poke_interval: e.poke_interval || 60, timeout: e.timeout || 3600
    });
    if(e.downstream){ deps.push({ upstream: ets_id, downstream: e.downstream }); }
  });


    // --- Assets (condiciones) ---
  const assets_enabled = !!document.getElementById('assets_on')?.checked;
  const asset_logic = (document.getElementById('asset_logic')?.value || 'OR').toUpperCase();
  const asset_inlets_rows = qAll(document, "#asset_inlets > .section-card").map(card => {
    const sel = card.querySelector('select[data-k="task_id"]');
    const uri = card.querySelector('input[data-k="uri"]')?.value || "";
    return { task_id: sel?.value || "", uri: uri.trim() };
  }).filter(x => x.task_id && x.uri);
  const asset_outlets_rows = qAll(document, "#asset_outlets > .section-card").map(card => {
    const sel = card.querySelector('select[data-k="task_id"]');
    const uri = card.querySelector('input[data-k="uri"]')?.value || "";
    return { task_id: sel?.value || "", uri: uri.trim() };
  }).filter(x => x.task_id && x.uri);

  // dedupe URIs for schedule trigger (only inlets trigger the DAG)
  const asset_inlets = [...new Set(asset_inlets_rows.map(x => x.uri))];

  // attach inlets/outlets to tasks (lineage/documentation)
  const byId = {}; tasks.forEach(t => { if(t.task_id) byId[t.task_id]=t; });
  asset_inlets_rows.forEach(x => {
    const t = byId[x.task_id]; if(!t) return;
    t.inlets = (t.inlets || []); if(!t.inlets.includes(x.uri)) t.inlets.push(x.uri);
  });
  asset_outlets_rows.forEach(x => {
    const t = byId[x.task_id]; if(!t) return;
    t.outlets = (t.outlets || []); if(!t.outlets.includes(x.uri)) t.outlets.push(x.uri);
  });


// --- Hora espec√≠fica para @once (NO es cron) ---
  const start_time_once = (() => {
    const hh = document.getElementById('once_hh')?.value ?? '';
    const mm = document.getElementById('once_mm')?.value ?? '';
    return (hh !== '' && mm !== '')
      ? `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`
      : '';
  })();

  return {
    dag_id: document.getElementById("dag_id")?.value || "",
    description: document.getElementById("description")?.value || "",
    owner: document.getElementById("owner")?.value || "owner",
    app: document.getElementById("app")?.value || "",
    subapp: document.getElementById("subapp")?.value || "",
    retries: parseInt(document.getElementById("retries")?.value || "1", 10),
    retry_minutes: parseInt(document.getElementById("retry_minutes")?.value || "5", 10),
    start_date: document.getElementById("start_date")?.value || "",    schedule: (function(){ const c = buildCronFromUI2(); window.builderState.schedule = c; return c; })(),
    timezone: (window.builderState?.timezone) || "UTC",
    params: (window.builderState?.params) || {},
    argsets: (window.builderState?.argsets) || {},
    start_time: start_time_once,
    catchup: !!document.getElementById("catchup")?.checked,
    confirm: !!document.getElementById("confirm_on")?.checked,
    assets_enabled,
    asset_logic,
    asset_inlets,
    tags: (function(){
      const out = [];
      const a = (document.getElementById("app")?.value || "").trim();
      const s = (document.getElementById("subapp")?.value || "").trim();
      if (a) out.push("app:" + a);
      if (s) out.push("subapp:" + s);
      return out;
    })(),
    tasks, dependencies: deps
  };
}

async function doPreview(){
  const spec = collect();
  const r = await fetch("/api/builder/preview", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(spec)});
  const data = await r.json().catch(()=>({}));
  document.getElementById("out_code").textContent = data.code || "";
  document.getElementById("out_val").textContent  = JSON.stringify(data.validation || {}, null, 2);
  document.getElementById("statusChip").textContent = (data.validation?.valid ? "v√°lido" : "con errores");
}
document.getElementById("btn_preview")?.addEventListener("click", doPreview);
document.getElementById("btn_preview_footer")?.addEventListener("click", doPreview);

function sanitizeFilename(name){
  let s = String(name || '').trim();
  if(!s) s = 'dag_generated';

  // Quita caracteres inv√°lidos en Windows/macOS/Linux para nombres de archivo
  // y evita rutas/segmentos.
  s = s.replace(/[\\\/:*?"<>|]+/g, "_");

  // Limpia espacios repetidos
  s = s.replace(/\s+/g, "_");

  // Evita nombre vac√≠o o solo puntos
  s = s.replace(/^\.+$/, "dag_generated");

  return s;
}

function filenameFromContentDisposition(cd){
  if(!cd) return null;

  // filename*=UTF-8''xxx
  const m1 = cd.match(/filename\*\s*=\s*UTF-8''([^;]+)/i);
  if(m1 && m1[1]) {
    try { return decodeURIComponent(m1[1].replace(/["']/g, '')); } catch { return m1[1]; }
  }

  // filename="xxx"
  const m2 = cd.match(/filename\s*=\s*"([^"]+)"/i);
  if(m2 && m2[1]) return m2[1];

  // filename=xxx
  const m3 = cd.match(/filename\s*=\s*([^;]+)/i);
  if(m3 && m3[1]) return m3[1].trim().replace(/["']/g, '');

  return null;
}

document.getElementById("btn_download")?.addEventListener("click", async ()=>{
  const spec = collect();

  const r = await fetch("/api/builder/download", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(spec)
  });

  if(!r.ok){
    const t = await r.text().catch(()=> "");
    alert(`Error download: ${r.status} ${t}`);
    return;
  }

  const blob = await r.blob();

  // 1) Intenta usar filename desde el backend si existe
  const cd = r.headers.get('Content-Disposition');
  let fname = filenameFromContentDisposition(cd);

  // 2) Fallback: dag_id sanitizado
  if(!fname){
    fname = sanitizeFilename(spec.dag_id) + ".py";
  } else {
    fname = sanitizeFilename(fname);
    if(!fname.toLowerCase().endsWith('.py')) fname += '.py';
  }

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fname;

  document.body.appendChild(a);
  a.click();
  a.remove();

  // libera memoria
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
});

  /* ===== Importar / Limpiar (separado) ===== */
  function _ev(name){ return new Event(name,{bubbles:true}); }
  function _setVal(id, val){
    const e = document.getElementById(id);
    if(!e) return;
    if(e.type === 'checkbox'){
      e.checked = !!val;
      e.dispatchEvent(_ev('change'));
      return;
    }
    e.value = (val === undefined || val === null) ? '' : String(val);
    const isSelect = (e.tagName === 'SELECT');
    e.dispatchEvent(_ev(isSelect ? 'change' : 'input'));
    if(!isSelect) e.dispatchEvent(_ev('change'));
  }
  function _todayYmd(){
    const now = new Date();
    const y=now.getFullYear();
    const m=String(now.getMonth()+1).padStart(2,'0');
    const d=String(now.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function _isObj(x){ return x && typeof x === 'object' && !Array.isArray(x); }
  function _parseIntSafe(x, dflt){
    const n = parseInt(String(x ?? ''),10);
    return Number.isFinite(n) ? n : dflt;
  }

  /* Limpia todo y deja listo para crear/importar */
  function resetBuilderUI(){
    // General
    ['dag_id','description','owner','app','subapp'].forEach(id=>_setVal(id,''));
    _setVal('retries','1');
    _setVal('retry_minutes','5');
    _setVal('catchup', false);
    _setVal('confirm_on', false);

    const sd = document.getElementById('start_date');
    if(sd){ sd.value = _todayYmd(); sd.dispatchEvent(_ev('change')); }

    // Scheduling defaults
    _setVal('sched_tz', window.builderState?.timezone || 'America/Santiago');
    _setVal('schedule_kind','@daily');
    _setVal('t_hh','9'); _setVal('t_mm','0');
    _setVal('h_mm','0'); _setVal('h_start','');
    _setVal('w_dow','1');
    _setVal('m_dom','1');
    _setVal('y_mon','1');
    _setVal('y_dom','1');
    _setVal('cyclic_on', false);
    _setVal('cyclic_unit','minutes');
    _setVal('cyclic_n','15');
    _setVal('cyclic_at_mm','0');
    _setVal('cyc_from','0');
    _setVal('cyc_to','23');
    _setVal('once_hh','9');
    _setVal('once_mm','0');
    _setVal('times_list','');
    document.querySelectorAll('input[name="times_dow"]').forEach(cb=>{
      cb.checked = ['1','2','3','4','5'].includes(cb.value);
      cb.dispatchEvent(_ev('change'));
    });

    // Assets
    _setVal('assets_on', false);
    _setVal('asset_logic', 'OR');
    const ap = document.getElementById('asset_prefix');
    if(ap && !ap.value) ap.value = 'asset://cond/';
    document.getElementById('asset_inlets')?.replaceChildren();
    document.getElementById('asset_outlets')?.replaceChildren();
    setAssetsUiEnabled(!!document.getElementById('assets_on')?.checked);

    // Clear sections
    document.getElementById('tasks')?.replaceChildren();
    document.getElementById('deps')?.replaceChildren();
    document.getElementById('extdeps')?.replaceChildren();

    // Reset state/counters
    tcount = 0;
    window.builderState.schedule = '@daily';
    window.builderState.params = {};
    window.builderState.argsets = {};
    window.__globalParamsMgr?.render?.();
    window.__globalArgsetsMgr?.render?.();

    refreshTaskSelects();
    updateGraph();

    const oc = document.getElementById('out_code'); if(oc) oc.textContent = '‚Äî';
    const ov = document.getElementById('out_val');  if(ov) ov.textContent = '‚Äî';
    const st = document.getElementById('statusChip'); if(st) st.textContent = 'sin validar';
  }

  /* Detecta ExternalTaskSensor ‚Äúgenerado por externas‚Äù y lo convierte a extdeps UI */
  function preprocessImportedTasksAndDeps(spec){
    const tasks = Array.isArray(spec.tasks) ? spec.tasks : [];
    const deps  = Array.isArray(spec.dependencies) ? spec.dependencies : [];

    const extdeps = [];
    const keepTasks = [];
    const removedTaskIds = new Set();

    tasks.forEach(t=>{
      if(!t || t.type !== 'ExternalTaskSensor') { keepTasks.push(t); return; }
      const hasExt = !!(t.external_dag_id || t.external_task_id || t.mode || t.poke_interval || t.timeout);
      if(!hasExt){ keepTasks.push(t); return; }

      const tid = String(t.task_id||'');
      const out = deps.filter(d => d && String(d.upstream||'')===tid && d.downstream);
      if(!out.length){ keepTasks.push(t); return; }

      out.forEach(d=>{
        extdeps.push({
          external_dag_id: t.external_dag_id || '',
          external_task_id: t.external_task_id || '',
          mode: t.mode || 'reschedule',
          poke_interval: t.poke_interval || '60',
          timeout: t.timeout || '3600',
          downstream: d.downstream || ''
        });
      });
      removedTaskIds.add(tid);
    });

    const finalTasks = keepTasks.filter(t => t && !removedTaskIds.has(String(t.task_id||'')));
    const finalDeps = deps.filter(d => {
      if(!d) return false;
      const u = String(d.upstream||'');
      const v = String(d.downstream||'');
      if(!u || !v) return false;
      if(removedTaskIds.has(u) || removedTaskIds.has(v)) return false;
      return true;
    });

    return { tasks: finalTasks, dependencies: finalDeps, extdeps };
  }

  /* Helpers @times */
  function _setTimesDowFromField(dowField){
    const all = Array.from(document.querySelectorAll('input[name="times_dow"]'));
    if(!all.length) return;
    const s = String(dowField||'').trim();
    let set = new Set();
    if(!s || s === '*'){
      set = new Set(['0','1','2','3','4','5','6']);
    } else if(s.includes('-')){
      const [a,b] = s.split('-').map(v=>_parseIntSafe(v,0));
      for(let i=Math.min(a,b); i<=Math.max(a,b); i++) set.add(String(i));
    } else if(s.includes(',')){
      s.split(',').forEach(v=>{ const n=_parseIntSafe(v,-1); if(n>=0) set.add(String(n)); });
    } else {
      const n=_parseIntSafe(s,-1); if(n>=0) set.add(String(n));
    }
    all.forEach(cb=>{ cb.checked = set.has(cb.value); cb.dispatchEvent(_ev('change')); });
  }
  function _expandHourField(field){
    const s = String(field||'').trim();
    const out = new Set();
    if(!s || s==='*'){
      for(let i=0;i<=23;i++) out.add(i);
      return [...out];
    }
    s.split(',').forEach(tok=>{
      tok = tok.trim();
      if(!tok) return;
      if(tok.includes('-')){
        const [range, stepPart] = tok.split('/');
        const [a,b] = range.split('-');
        const A=_parseIntSafe(a,0), B=_parseIntSafe(b,0);
        const step = stepPart ? _parseIntSafe(stepPart,1) : 1;
        for(let i=Math.min(A,B); i<=Math.max(A,B); i+=Math.max(1,step)) out.add(i);
      } else if(tok.includes('/')){
        const [base, stepPart] = tok.split('/');
        const step = _parseIntSafe(stepPart,1);
        if(base==='*'){
          for(let i=0;i<=23;i+=Math.max(1,step)) out.add(i);
        }
      } else {
        const n=_parseIntSafe(tok,-1);
        if(n>=0) out.add(n);
      }
    });
    return [...out].sort((a,b)=>a-b);
  }

  /* Aplica Scheduling a la UI desde spec.schedule */
  async function applyScheduleFromImportedSpec(spec){
    const schedule = String((spec.schedule ?? '@daily')).trim();

    if(spec.start_date) _setVal('start_date', spec.start_date);
    if(spec.timezone) _setVal('sched_tz', spec.timezone);

    const kindSel = document.getElementById('schedule_kind');
    if(!kindSel) return;

    const setKind = (k)=>{ kindSel.value = k; kindSel.dispatchEvent(_ev('change')); };

    const kindFromFields = (dom, mon, dow)=>{
      if(dom==='*' && mon==='*' && dow==='*') return '@daily';
      if(dom==='*' && mon==='*' && dow!=='*') return '@weekly';
      if(dom!=='*' && mon==='*') return '@monthly';
      if(dom!=='*' && mon!=='*') return '@yearly';
      return '@daily';
    };

    if(schedule === 'None'){
      setKind('@none');
      return;
    }

    if(schedule === '@once'){
      setKind('@once');
      const st = String(spec.start_time||'').trim();
      const m = st.match(/^(\d{1,2}):(\d{2})$/);
      if(m){ _setVal('once_hh', _parseIntSafe(m[1],9)); _setVal('once_mm', _parseIntSafe(m[2],0)); }
      return;
    }

    if(schedule.startsWith('CAL|') || schedule.startsWith('CALC|')){
      setKind('@calendar');
      const parts = schedule.split('|');
      const cal = (parts[1] || '').trim();
      await loadCalendarsIntoSelect(cal);
      _setVal('calendar_name', cal);

      if(schedule.startsWith('CAL|')){
        const hm = (parts[2] || '00:00').trim();
        const [hhS, mmS] = hm.split(':');
        _setVal('t_hh', _parseIntSafe(hhS,0));
        _setVal('t_mm', _parseIntSafe(mmS,0));
        _setVal('cyclic_on', false);
        return;
      }

      // CALC|<cal>|<unit>|<N>|<from>|<to>|<at_mm>
      _setVal('cyclic_on', true);
      _setVal('cyclic_unit', (parts[2] || 'minutes').trim());
      _setVal('cyclic_n', _parseIntSafe(parts[3], 15));
      _setVal('cyc_from', _parseIntSafe(parts[4], 0));
      _setVal('cyc_to', _parseIntSafe(parts[5], 23));
      _setVal('cyclic_at_mm', _parseIntSafe(parts[6], 0));
      return;
    }

    if(schedule.startsWith('MULTI|')){
      setKind('@times');
      const list = schedule.slice(6).split('||').map(s=>s.trim()).filter(Boolean);
      const times = [];
      let dowField = '';
      list.forEach(cr=>{
        const p = cr.split(/\s+/);
        if(p.length < 5) return;
        const mm = _parseIntSafe(p[0],0);
        const hours = _expandHourField(p[1]);
        if(!dowField) dowField = p[4];
        hours.forEach(h=>{
          times.push(`${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`);
        });
      });
      _setVal('times_list', [...new Set(times)].sort().join(', '));
      if(dowField) _setTimesDowFromField(dowField);

      const pre = document.getElementById('times_crons');
      if(pre) pre.textContent = list.join('\n');
      return;
    }

    // Cron simple
    const p = schedule.split(/\s+/);
    if(p.length >= 5){
      const [minF, hourF, domF, monF, dowF] = p;

      // cyclic minutes: */N F-T ...
      const mCycMin = minF.match(/^\*\/(\d+)$/);
      const mHourRange = hourF.match(/^(\d+)-(\d+)$/);
      if(mCycMin){
        const N=_parseIntSafe(mCycMin[1],15);
        let F=0, T=23;
        if(mHourRange){ F=_parseIntSafe(mHourRange[1],0); T=_parseIntSafe(mHourRange[2],23); }
        const k = kindFromFields(domF, monF, dowF);
        setKind(k);
        if(k==='@weekly') _setVal('w_dow', dowF);
        if(k==='@monthly') _setVal('m_dom', domF);
        if(k==='@yearly'){ _setVal('y_dom', domF); _setVal('y_mon', monF); }
        _setVal('cyclic_on', true);
        _setVal('cyclic_unit', 'minutes');
        _setVal('cyclic_n', N);
        _setVal('cyc_from', F);
        _setVal('cyc_to', T);
        return;
      }

      // cyclic hours: mm */N ... OR mm F-T/N ...
      const mCycHour1 = hourF.match(/^\*\/(\d+)$/);
      const mCycHour2 = hourF.match(/^(\d+)-(\d+)\/(\d+)$/);
      if(mCycHour1 || mCycHour2){
        const N = _parseIntSafe(mCycHour1 ? mCycHour1[1] : mCycHour2[3], 1);
        let F=0, T=23;
        if(mCycHour2){ F=_parseIntSafe(mCycHour2[1],0); T=_parseIntSafe(mCycHour2[2],23); }
        const mm = _parseIntSafe(minF,0);
        const k = kindFromFields(domF, monF, dowF);
        setKind(k);
        if(k==='@weekly') _setVal('w_dow', dowF);
        if(k==='@monthly') _setVal('m_dom', domF);
        if(k==='@yearly'){ _setVal('y_dom', domF); _setVal('y_mon', monF); }
        _setVal('cyclic_on', true);
        _setVal('cyclic_unit', 'hours');
        _setVal('cyclic_at_mm', mm);
        _setVal('cyclic_n', N);
        _setVal('cyc_from', F);
        _setVal('cyc_to', T);
        return;
      }

      // hour list => @times (cuando es * * en dom/mon)
      if(hourF.includes(',') && domF==='*' && monF==='*'){
        setKind('@times');
        const mm = _parseIntSafe(minF,0);
        const hours = _expandHourField(hourF);
        _setVal('times_list', hours.map(h=>`${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`).join(', '));
        _setTimesDowFromField(dowF);
        const pre = document.getElementById('times_crons');
        if(pre) pre.textContent = schedule;
        return;
      }

      // hourly (mm * * * *) o (mm HS-23 * * *)
      if(domF==='*' && monF==='*' && dowF==='*'){
        const hrStart = hourF.match(/^(\d+)-23$/);
        if(hourF==='*' || hrStart){
          setKind('@hourly');
          _setVal('h_mm', _parseIntSafe(minF,0));
          _setVal('h_start', hrStart ? _parseIntSafe(hrStart[1],0) : '');
          return;
        }
      }

      // daily/weekly/monthly/yearly simples
      const mm=_parseIntSafe(minF,0);
      if(domF==='*' && monF==='*' && dowF==='*' && /^\d+$/.test(hourF)){
        setKind('@daily'); _setVal('t_hh', _parseIntSafe(hourF,9)); _setVal('t_mm', mm); return;
      }
      if(domF==='*' && monF==='*' && dowF!=='*' && /^\d+$/.test(hourF)){
        setKind('@weekly'); _setVal('w_dow', dowF); _setVal('t_hh', _parseIntSafe(hourF,9)); _setVal('t_mm', mm); return;
      }
      if(domF!=='*' && monF==='*' && dowF==='*' && /^\d+$/.test(hourF)){
        setKind('@monthly'); _setVal('m_dom', domF); _setVal('t_hh', _parseIntSafe(hourF,9)); _setVal('t_mm', mm); return;
      }
      if(domF!=='*' && monF!=='*' && dowF==='*' && /^\d+$/.test(hourF)){
        setKind('@yearly'); _setVal('y_mon', monF); _setVal('y_dom', domF); _setVal('t_hh', _parseIntSafe(hourF,9)); _setVal('t_mm', mm); return;
      }
    }

    // fallback (no round-trip perfecto)
    const cp = document.getElementById('cron_preview');
    if(cp){ cp.textContent = schedule; cp.title = schedule; }
    window.builderState.schedule = schedule;
  }

  /* Aplica spec a la UI */
  async function applyImportedSpec(raw){
    if(!_isObj(raw)) throw new Error('El import no es un objeto JSON v√°lido.');
    const spec = (_isObj(raw.config) ? raw.config : raw);

    resetBuilderUI();

    // General
    _setVal('dag_id', spec.dag_id || '');
    _setVal('description', spec.description || '');
    _setVal('owner', spec.owner || '');

    let app = spec.app || '';
    let subapp = spec.subapp || '';
    if((!app || !subapp) && Array.isArray(spec.tags)){
      const tApp = spec.tags.find(t => String(t).startsWith('app:'));
      const tSub = spec.tags.find(t => String(t).startsWith('subapp:'));
      if(!app && tApp) app = String(tApp).slice(4);
      if(!subapp && tSub) subapp = String(tSub).slice(7);
    }
    _setVal('app', app);
    _setVal('subapp', subapp);

    _setVal('retries', spec.retries ?? 1);
    _setVal('retry_minutes', spec.retry_minutes ?? spec.retry_delay_minutes ?? 5);
    _setVal('catchup', !!spec.catchup);
    _setVal('confirm_on', !!spec.confirm);

    // globals
    if(_isObj(spec.params)) window.builderState.params = spec.params;
    if(_isObj(spec.argsets)) window.builderState.argsets = spec.argsets;
    window.__globalParamsMgr?.render?.();
    window.__globalArgsetsMgr?.render?.();

    // schedule
    await applyScheduleFromImportedSpec(spec);

    // assets
    _setVal('assets_on', !!spec.assets_enabled);
    _setVal('asset_logic', spec.asset_logic || 'OR');
    if(typeof spec.asset_prefix === 'string') _setVal('asset_prefix', spec.asset_prefix);

    // tasks/deps/extdeps
    const prep = preprocessImportedTasksAndDeps(spec);

    (prep.tasks || []).forEach(t=>{
      const type = (t && t.type) ? String(t.type) : 'EmptyOperator';
      addTask(type);
      const card = document.querySelector('#tasks > .section-card:last-child');
      if(!card || !t) return;

      Object.keys(t).forEach(k=>{
        const v = t[k];
        const sel = '[data-k="' + String(k).replace(/"/g,'\\"') + '"]';
        const elx = card.querySelector(sel);
        if(!elx) return;
        elx.value = (v === undefined || v === null) ? '' : String(v);
      });

      const tidInp = card.querySelector('[data-k="task_id"]');
      if(tidInp) tidInp.value = normId(tidInp.value);
    });

    refreshTaskSelects();

    (prep.dependencies || []).forEach(d=>{
      addDep();
      const card = document.querySelector('#deps > .section-card:last-child');
      if(!card || !d) return;
      const sels = card.querySelectorAll('select[data-k="_sel"]');
      if(sels[0]) sels[0].value = d.upstream || '';
      if(sels[1]) sels[1].value = d.downstream || '';
    });

    (prep.extdeps || []).forEach(ed=>{
      addExternalDep();
      const card = document.querySelector('#extdeps > .section-card:last-child');
      if(!card || !ed) return;
      ['external_dag_id','external_task_id','mode','poke_interval','timeout'].forEach(k=>{
        const elx = card.querySelector('[data-k="'+k+'"]');
        if(elx) elx.value = (ed[k] === undefined || ed[k] === null) ? '' : String(ed[k]);
      });
      const down = card.querySelector('select[data-k="downstream"]');
      if(down) down.value = ed.downstream || '';
    });

    // assets rows (inlets/outlets por task)
    if(!!spec.assets_enabled){
      document.getElementById('asset_inlets')?.replaceChildren();
      document.getElementById('asset_outlets')?.replaceChildren();

      const inRows = [];
      const outRows = [];
      (spec.tasks || []).forEach(t=>{
        const tid = t?.task_id;
        (Array.isArray(t?.inlets) ? t.inlets : []).forEach(u=> inRows.push({task_id:tid, uri:u}));
        (Array.isArray(t?.outlets) ? t.outlets : []).forEach(u=> outRows.push({task_id:tid, uri:u}));
      });

      inRows.forEach(r=>{
        addAssetLinkRow('asset_inlets','inlet');
        const card = document.querySelector('#asset_inlets > .section-card:last-child');
        const sel = card?.querySelector('select[data-k="task_id"]');
        const inp = card?.querySelector('input[data-k="uri"]');
        if(sel) sel.value = r.task_id || '';
        if(inp) inp.value = r.uri || '';
      });
      outRows.forEach(r=>{
        addAssetLinkRow('asset_outlets','outlet');
        const card = document.querySelector('#asset_outlets > .section-card:last-child');
        const sel = card?.querySelector('select[data-k="task_id"]');
        const inp = card?.querySelector('input[data-k="uri"]');
        if(sel) sel.value = r.task_id || '';
        if(inp) inp.value = r.uri || '';
      });
      setAssetsUiEnabled(true);
    } else {
      setAssetsUiEnabled(false);
    }

    refreshTaskSelects();
    window.__resMgr?.refresh?.(taskIdOptions());
    window.__argMgr?.refresh?.(taskIdOptions());
    updateGraph();

    const st = document.getElementById('statusChip');
    if(st) st.textContent = 'importado';
  }

  /* Import .py best-effort: b√°sico (dag_id, schedule, tasks, deps) */
  function parsePythonDagToSpec(pyText){
    const pad2 = (n)=>String(n).padStart(2,'0');
    const spec = {
      dag_id:'', description:'', owner:'',
      app:'', subapp:'',
      retries:1, retry_minutes:5,
      start_date:'', schedule:'@daily', start_time:'',
      catchup:false, confirm:false,
      timezone:'UTC', tags:[],
      params:{}, argsets:{},
      assets_enabled:false, asset_logic:'OR', asset_prefix:'asset://cond/', asset_inlets:[],
      tasks:[], dependencies:[]
    };

    let m = pyText.match(/\bdag_id\s*=\s*['"]([^'"]+)['"]/);
    if(!m) m = pyText.match(/\bDAG\(\s*['"]([^'"]+)['"]/);
    if(m) spec.dag_id = m[1];

    m = pyText.match(/\bdescription\s*=\s*['"]([^'"]*)['"]/);
    if(m) spec.description = m[1];

    m = pyText.match(/\bowner\s*=\s*['"]([^'"]+)['"]/);
    if(m) spec.owner = m[1];

    m = pyText.match(/\bcatchup\s*=\s*(True|False)\b/);
    if(m) spec.catchup = (m[1] === 'True');

    m = pyText.match(/\bretries\s*=\s*(\d+)\b/);
    if(m) spec.retries = parseInt(m[1],10);

    m = pyText.match(/\bretry_delay\s*=\s*timedelta\(\s*minutes\s*=\s*(\d+)/);
    if(m) spec.retry_minutes = parseInt(m[1],10);

    m = pyText.match(/\btimezone\s*=\s*['"]([^'"]+)['"]/);
    if(m) spec.timezone = m[1];

    m = pyText.match(/\bstart_date\s*=\s*datetime\(\s*(\d{4})\s*,\s*(\d{1,2})\s*,\s*(\d{1,2})/);
    if(m){
      spec.start_date = `${m[1]}-${pad2(parseInt(m[2],10))}-${pad2(parseInt(m[3],10))}`;
    }

    m = pyText.match(/\bschedule(?:_interval)?\s*=\s*(None|['"][^'"]+['"])/);
    if(m){
      if(m[1] === 'None') spec.schedule = 'None';
      else spec.schedule = m[1].slice(1,-1);
    }

    const tasks = [];
    const varToTaskId = new Map();
    const reAssign = /\b([A-Za-z_][A-Za-z0-9_]*)\s*=\s*([A-Za-z_][A-Za-z0-9_\.]+)\s*\(/g;
    const isOperator = (cls)=>/(Operator|Sensor)$/i.test(cls) || cls === 'ExternalTaskSensor';
    let mm;
    while((mm = reAssign.exec(pyText))){
      const varName = mm[1];
      const cls = mm[2].split('.').pop();
      if(!isOperator(cls)) continue;

      const openIdx = reAssign.lastIndex - 1; // '('
      let i = openIdx, depth = 0, inS = false, sChar = '';
      for(; i<pyText.length; i++){
        const ch = pyText[i];
        if(inS){
          if(ch === '\\\\'){ i += 1; continue; }
          if(ch === sChar) inS = false;
          continue;
        }
        if(ch === '"' || ch === "'"){ inS = true; sChar = ch; continue; }
        if(ch === '('){ depth += 1; continue; }
        if(ch === ')'){
          depth -= 1;
          if(depth === 0){ i += 1; break; }
        }
      }
      const callBody = pyText.slice(openIdx+1, i-1);
      let taskId = varName;
      const mt = callBody.match(/\btask_id\s*=\s*['"]([^'"]+)['"]/);
      if(mt) taskId = mt[1];

      const t = { type: cls, task_id: taskId };
      const mb = callBody.match(/\bbash_command\s*=\s*['"]([\s\S]*?)['"]/);
      if(mb) t.bash_command = mb[1];

      tasks.push(t);
      varToTaskId.set(varName, taskId);
    }
    spec.tasks = tasks;

    // deps con >> / << (simple)
    const deps = [];
    const lines = pyText.split(/\r?\n/);
    const extractNames = (expr)=>{
      const out = [];
      const re = /[A-Za-z_][A-Za-z0-9_]*/g;
      let m2;
      while((m2 = re.exec(expr||''))) out.push(m2[0]);
      return out;
    };
    for(const raw of lines){
      const line = raw.split('#')[0];
      if(!line.includes('>>') && !line.includes('<<')) continue;

      const dir = line.includes('>>') ? '>>' : '<<';
      const parts = line.split(dir).map(s=>s.trim()).filter(Boolean);
      if(parts.length < 2) continue;

      const seq = parts.map(extractNames).filter(a=>a.length);
      if(seq.length < 2) continue;

      for(let j=0;j<seq.length-1;j++){
        const left = seq[j];
        const right = seq[j+1];
        for(const L of left){
          for(const R of right){
            const upVar = (dir==='>>') ? L : R;
            const dnVar = (dir==='>>') ? R : L;
            const up = varToTaskId.get(upVar) || upVar;
            const dn = varToTaskId.get(dnVar) || dnVar;
            deps.push({upstream: up, downstream: dn});
          }
        }
      }
    }
    const seen = new Set();
    spec.dependencies = deps.filter(d=>{
      const k = `${d.upstream}>>${d.downstream}`;
      if(seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    return spec;
  }

  async function handleImportFile(file){
  const name = (file?.name || '').toLowerCase();

  // JSON directo
  if(name.endsWith('.json')){
    const txt = await file.text();
    const obj = JSON.parse(txt);
    await applyImportedSpec(obj);
    return;
  }

  // PY: backend AST -> spec
  if(name.endsWith('.py')){
    const fd = new FormData();
    fd.append('file', file);
    const r = await fetch('/api/import-dag', { method:'POST', body: fd });
    if(!r.ok){
      const t = await r.text();
      throw new Error(`Import backend error: ${r.status} ${t}`);
    }
    const spec = await r.json();
    await applyImportedSpec(spec);
    return;
  }

  throw new Error('Formato no soportado: usa .json o .py');
}


  /* Wiring botones */
  document.getElementById('btn_import')?.addEventListener('click', (e)=>{
    e.preventDefault();
    const f = document.getElementById('import_file');
    if(f){ f.value=''; f.click(); }
  });
  document.getElementById('btn_import_footer')?.addEventListener('click', ()=> document.getElementById('btn_import')?.click());

  document.getElementById('btn_clear')?.addEventListener('click', (e)=>{
    e.preventDefault();
    resetBuilderUI();
  });
  document.getElementById('btn_clear_footer')?.addEventListener('click', ()=> document.getElementById('btn_clear')?.click());

  document.getElementById('import_file')?.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const st = document.getElementById('statusChip');
    if(st) st.textContent = 'importando...';
    try{
      await handleImportFile(file);
    }catch(err){
      console.error(err);
      if(st) st.textContent = 'error import';
      alert(String(err?.message || err));
    }finally{
      e.target.value = '';
    }
  });
  /* ===== fin Importar / Limpiar (separado) ===== */

/* Switch C√≥digo/Validaci√≥n */
document.getElementById("btn_show_code")?.addEventListener("click", ()=>{
  document.getElementById("out_code").style.display="block";
  document.getElementById("out_val").style.display="none";
});
document.getElementById("btn_show_val")?.addEventListener("click", ()=>{
  document.getElementById("out_code").style.display="none";
  document.getElementById("out_val").style.display="block";
});

/* Fecha por defecto = hoy */
(function setDefaultDate(){
  const d = document.getElementById("start_date");
  if(!d?.value){
    const now = new Date(); const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,"0"), dd=String(now.getDate()).padStart(2,"0");
    d.value = `${y}-${m}-${dd}`;
  }
})();

/* Modo compacto persistente */
(function initCompact(){
  const KEY = 'builder:compact';
  const pane = document.getElementById('pane-tasks');
  const chk  = document.getElementById('toggle_compact');
  if(!pane || !chk) return;
  function apply(on){ pane.classList.toggle('compact', !!on); localStorage.setItem(KEY, on ? '1' : '0'); }
  const saved = localStorage.getItem(KEY) === '1';
  chk.checked = saved; apply(saved);
  chk.addEventListener('change', e => apply(e.target.checked));
})();

/* ===== DAG Graph (Cytoscape) ===== */
let cy = null;
function graphElementsFromSpec(spec){
  const nodes = [], edges = [], seenNode = new Set(), seenEdge = new Set();
  (spec.tasks || []).forEach(t => {
    const id = t.task_id; if(!id || seenNode.has(id)) return; seenNode.add(id);
    nodes.push({ data: { id, label: `${id}\n${t.type || 'Task'}` }, classes: (t.type==='ExternalTaskSensor')?'external':'internal' });
  });
  (spec.dependencies || []).forEach(d => {
    const u=d.upstream, v=d.downstream; if(!u||!v) return;
    const key = `${u}>>${v}`; if(seenEdge.has(key)) return; seenEdge.add(key);
    edges.push({ data: { id: key, source: u, target: v } });
  });
  return { nodes, edges };
}
function ensureCy(){
  if(cy) return cy;
  const text   = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#e6eaf2';
  const border = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#1f2a44';
  const brand  = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#017CEE';
  cy = cytoscape({
    container: document.getElementById('dagGraph'),
    wheelSensitivity: 0.2, pixelRatio: 1,
    layout: { name: 'breadthfirst', directed: true, spacingFactor: 1.15, padding: 20 },
    style: [
      { selector: 'node', style: {
          'shape':'round-rectangle','background-color':'#151a28','border-color':border,'border-width':1.5,
          'padding':'8px','label':'data(label)','font-size':12,'font-family':'ui-monospace, Menlo, Consolas, monospace',
          'text-wrap':'wrap','text-valign':'center','text-halign':'center','color':text,'width':'label','height':'label'
      }},
      { selector: 'node.external', style: { 'background-color':'#0b1220','border-style':'dashed','border-color':brand }},
      { selector: 'edge', style: {
          'curve-style':'taxi','taxi-direction':'downward','taxi-turn':20,'width':1.2,'line-color':border,
          'target-arrow-shape':'triangle','target-arrow-color':border
      }},
      { selector: ':selected', style: { 'border-color': brand, 'line-color': brand, 'target-arrow-color': brand } }
    ]
  });
  window.addEventListener('resize', () => cy.resize());
  return cy;
}
let graphDebounce = null;
function updateGraph(){
  if(graphDebounce){ cancelAnimationFrame(graphDebounce); }
  graphDebounce = requestAnimationFrame(()=>{
    const spec = collect();
    const {nodes, edges} = graphElementsFromSpec(spec);
    const g = ensureCy();
    g.json({ elements: { nodes, edges }});
    g.layout({ name: 'breadthfirst', directed: true, spacingFactor: 1.15, padding: 20 }).run();
  });
}
document.getElementById("btn_preview")?.addEventListener("click", updateGraph);
document.getElementById("btn_preview_footer")?.addEventListener("click", updateGraph);
['tasks','deps','extdeps'].forEach(id=>{
  const root = document.getElementById(id);
  if(root){ root.addEventListener('input', updateGraph); root.addEventListener('change', updateGraph); }
});
updateGraph();
document.getElementById('themeToggle')?.addEventListener('click', ()=>{ setTimeout(()=>{ cy=null; updateGraph(); }, 50); });
  };
  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', main, { once:true });
  } else {
    main();
  }
})();
</script>
<script src="{{ url_for('static', filename='js/dag_importer_full.js') }}"></script>

{% endblock %}
