{% extends "base.html" %}
{% block title %}Builder · Airflow DAG Studio{% endblock %}
{% block page_title %}Creador de DAGs{% endblock %}
{% block page_subtitle %}Genera DAGs compatibles con Airflow 3.1{% endblock %}
{% block header_actions %}
  <button class="button secondary" id="btn_preview">Previsualizar</button>
  <button class="button" id="btn_download">Descargar .py</button>
{% endblock %}

{% block head_extra %}
<style>
  .form-grid-2 { display:grid; grid-template-columns: repeat(2, minmax(240px, 1fr)); gap:12px; }
  .form-grid-3 { display:grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap:12px; }
  .cards-autofit { display:grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap:12px; }
  .deps-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap:12px; }
  .tabs-header { display:flex; gap:6px; padding:8px; border-bottom:1px solid var(--border); background:var(--panel); position:sticky; top:72px; z-index:5; }
  .tab { border:1px solid var(--border); background:var(--panel-alt); padding:6px 10px; border-radius:8px; cursor:pointer; }
  .tab[aria-selected="true"]{ border-color:var(--brand); color:var(--brand); }
  .section-card { background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; }
  .muted-note { margin-top:.35rem; color:var(--muted); font-size:12px; }
  #pane-tasks.compact .section-card { padding:10px; border-radius:10px; }
  #pane-tasks.compact label { font-size:11px; margin:.15rem 0 .2rem; }
  #pane-tasks.compact input, #pane-tasks.compact select, #pane-tasks.compact textarea { padding:6px; font-size:12px; }
  #pane-tasks.compact .cards-autofit { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:8px; }
  .graph-card { background:var(--panel); border:1px solid var(--border);
                border-radius:var(--radius); padding:12px; }
  #dagGraph { width:100%; height:420px; border:1px dashed var(--border);
              border-radius:10px; background:
                radial-gradient(var(--border) 1px, transparent 0) 0 0/16px 16px,
                radial-gradient(var(--border) 1px, transparent 0) 8px 8px/16px 16px;
              margin-top:8px; }
  .form-grid-4 { display:grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap:12px; }
  .preview-box{
    white-space: pre-wrap;        /* respeta saltos y permite wrap */
    overflow-wrap: anywhere;      /* corta palabras largas */
    word-break: break-word;
    max-height: 160px;            /* ajusta a gusto */
    overflow: auto;               /* scroll si se pasa */
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    line-height: 1.35;
    padding: 10px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;

  }
</style>
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
{% endblock %}

{% block content %}
<div class="card" style="padding:0;">
  <!-- Tabs -->
  <div role="tablist" aria-label="Secciones" class="tabs-header">
    <button role="tab" class="tab" data-tab="general" aria-selected="true">General</button>
    <button role="tab" class="tab" data-tab="schedule">Scheduling</button>
    <button role="tab" class="tab" data-tab="tasks">Tasks</button>
    <button role="tab" class="tab" data-tab="deps">Dependencies</button>
  </div>

  <div class="tabpanes" style="padding:12px;">
    <!-- GENERAL -->
    <section id="pane-general" role="tabpanel">
      <div class="section-card">
        <h3 style="margin-top:0;">Datos generales</h3>

        <div class="form-grid-2">
          <div>
            <label>DAG ID</label>
            <input id="dag_id" placeholder="etl_sales_daily"/>
          </div>
          <div>
            <label>Descripción</label>
            <input id="description" placeholder="Breve descripción del DAG"/>
          </div>
        </div>

        <div class="form-grid-3" style="margin-top:12px;">
          <div>
            <label>Owner</label>
            <input id="owner" value="data-team"/>
          </div>
          <div>
            <label>Aplicación</label>
            <input id="app" placeholder="(opcional)"/>
          </div>
          <div>
            <label>Sub-aplicación</label>
            <input id="subapp" placeholder="(opcional)"/>
          </div>
        </div>

        <div class="form-grid-2" style="margin-top:12px;">
          <div>
            <label>Retries</label>
            <input id="retries" type="number" min="0" step="1" value="1"/>
          </div>
          <div>
            <label>Retry delay (min)</label>
            <input id="retry_minutes" type="number" min="1" step="1" value="5"/>
          </div>
        </div>

        <div style="display:flex;gap:.5rem;align-items:center;margin-top:12px;">
          <input id="catchup" type="checkbox"/><label for="catchup">catchup</label>
        </div>

        <div style="margin-top:12px;">
          <label>Tags (coma)</label>
          <input id="tags" placeholder="etl, sales"/>
        </div>
      </div>
    </section>

    <!-- SCHEDULING -->
    <section id="pane-schedule" role="tabpanel" hidden>
      <div class="section-card">
        <h3 style="margin-top:0;">Scheduling</h3>

        <div class="form-grid-2">
          <div>
            <label>Start date</label>
            <input id="start_date" type="date"/>
          </div>

          <div>
            <label>Schedule</label>
            <select id="schedule_kind">
              <option value="@once">@once (una sola vez)</option>
              <option value="@times">@times (horarios específicos)</option>
              <option value="@hourly">@hourly</option>
              <option value="@daily">@daily</option>
              <option value="@weekly">@weekly</option>
              <option value="@monthly">@monthly</option>
              <option value="@yearly">@yearly</option>
            </select>
            <div class="muted-note">Airflow 3.1 usa <code>schedule=</code> (no <code>schedule_interval</code>).</div>
          </div>
        </div>

        <!-- Campos específicos -->
        <div id="sched_fields" style="margin-top:12px;">

          <!-- TIMES (horarios específicos) -->
          <div class="only-times" style="display:none; margin-top:8px;">
            <div class="section-card" style="padding:12px;">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <b>Horarios específicos</b>
                <span class="muted-note">Genera 1 o más cron (agrupa por minuto). Si hay más de uno, se envía como <code>MULTI|...</code>.</span>
              </div>

              <div style="margin-top:10px;">
                <label>Días de semana</label>
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="1" checked> Lun</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="2" checked> Mar</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="3" checked> Mié</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="4" checked> Jue</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="5" checked> Vie</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="6"> Sáb</label>
                  <label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" name="times_dow" value="0"> Dom</label>

                  <span style="flex:1;"></span>
                  <button id="times_btn_lv" class="button ghost" type="button">L-V</button>
                  <button id="times_btn_all" class="button ghost" type="button">Todos</button>
                  <button id="times_btn_none" class="button ghost" type="button">Limpiar</button>
                </div>
              </div>

              <div style="margin-top:10px;">
                <label>Horarios (HH:MM) — separados por coma / espacio / salto de línea</label>
                <input id="times_list" placeholder="10:00, 11:00, 14:30, 17:00  (también acepta 1000, 1430)"/>
                <div class="muted-note">Ej: <code>1000,1100,1430,1700</code> o <code>10:00 11:00 14:30 17:00</code></div>
              </div>

              <details style="margin-top:10px;">
                <summary>Ver cron(s) generados</summary>
                <pre id="times_crons" style="margin-top:8px; white-space:pre-wrap;">—</pre>
              </details>
            </div>
          </div>

<!-- ONCE -->
          <div class="form-grid-3 only-once">
            <div>
              <label>Hora (@once)</label>
              <input id="once_hh" type="number" min="0" max="23" value="9">
            </div>
            <div>
              <label>Minuto (@once)</label>
              <input id="once_mm" type="number" min="0" max="59" value="0">
            </div>
          </div>

          <!-- Hora base (daily/weekly/monthly/yearly) -->
          <div class="form-grid-3 only-daily only-weekly only-monthly only-yearly" style="margin-top:8px;">
            <div>
              <label>Hora</label>
              <input id="t_hh" type="number" min="0" max="23" value="9">
            </div>
            <div>
              <label>Minuto</label>
              <input id="t_mm" type="number" min="0" max="59" value="0">
            </div>
          </div>

          <!-- Weekly -->
          <div class="form-grid-3 only-weekly" style="margin-top:8px;">
            <div>
              <label>Día de semana</label>
              <select id="w_dow">
                <option value="1">Lunes</option><option value="2">Martes</option>
                <option value="3">Miércoles</option><option value="4">Jueves</option>
                <option value="5">Viernes</option><option value="6">Sábado</option>
                <option value="0">Domingo</option>
              </select>
            </div>
          </div>

          <!-- Monthly -->
          <div class="form-grid-3 only-monthly" style="margin-top:8px;">
            <div>
              <label>Día del mes</label>
              <input id="m_dom" type="number" min="1" max="31" value="1">
            </div>
          </div>

          <!-- Yearly -->
          <div class="form-grid-3 only-yearly" style="margin-top:8px;">
            <div>
              <label>Mes</label>
              <select id="y_mon">
                <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
              </select>
            </div>
            <div>
              <label>Día</label>
              <input id="y_dom" type="number" min="1" max="31" value="1">
            </div>
          </div>

          <!-- Hourly -->
          <div class="form-grid-3 only-hourly" style="margin-top:8px;">
            <div>
              <label>Minuto de la hora</label>
              <input id="h_mm" type="number" min="0" max="59" value="0">
            </div>
            <div>
              <label>Hora inicio (no cíclico)</label>
              <input id="h_start" type="number" min="0" max="23" value="">
            </div>
          </div>

          <!-- CÍCLICO -->
<div class="section-card only-cyclic" style="margin-top:12px;">
  <div style="display:flex;gap:8px;align-items:center;">
    <input id="cyclic_on" type="checkbox">
    <label for="cyclic_on"><b>Cíclico dentro de ventana (cada N minutos/horas)</b></label>
  </div>

  <div class="form-grid-4" style="margin-top:8px;">
    <div>
      <label>Cada N</label>
      <input id="cyclic_n" type="number" min="1" max="59" value="15">
    </div>

    <div>
      <label>Unidad</label>
      <select id="cyclic_unit">
        <option value="minutes" selected>minutos</option>
        <option value="hours">horas</option>
      </select>
    </div>

    <div id="cyclic_at_mm_wrap" style="display:none;">
      <label>En minuto (solo si unidad=horas)</label>
      <input id="cyclic_at_mm" type="number" min="0" max="59" value="0">
    </div>

    <div>
      <label>Desde hora</label>
      <input id="cyc_from" type="number" min="0" max="23" value="9">
    </div>

    <div>
      <label>Hasta hora</label>
      <input id="cyc_to" type="number" min="0" max="23" value="18">
    </div>
  </div>

  <div class="muted-note">
    Si está activo “Cíclico”, se ignoran los campos de hora/minuto de arriba y se genera un cron por intervalo.
  </div>
</div>


          <!-- TZ + acciones -->
          <div class="form-grid-3" style="margin-top:12px;">
            <div>
              <label>Timezone</label>
              <input id="sched_tz" type="text" value="America/Santiago">
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
            <button id="btn_build_cron" class="button">Generar cron</button>
            <code id="cron_preview" style="padding:4px 8px;border:1px solid var(--border);border-radius:8px;">—</code>
            <button id="btn_preview_runs" class="button ghost">Ver próximos 5</button>
            <span id="runs_preview" class="muted"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- TASKS -->
    <section id="pane-tasks" role="tabpanel" hidden>
      <div class="section-card" style="margin-bottom:12px;">
        <div id="task-toolbar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <select id="opsel" style="width:320px; max-width:100%;"></select>
          <button id="add_op" class="button">+ Agregar tarea</button>
          <span class="muted">Accesos rápidos:</span>
          <button id="add_empty"  class="button ghost">+ Empty</button>
          <button id="add_bash"   class="button ghost">+ Bash</button>
          <button id="add_python" class="button ghost">+ Python</button>
          <button id="add_custom" class="button ghost">+ Custom</button>
          <button id="add_ssh"    class="button ghost">+ SSH</button>
          <button id="add_winrm"  class="button ghost">+ WinRM</button>

          <div style="margin-left:auto; display:flex; align-items:center; gap:6px;">
            <label for="toggle_compact" class="muted">Modo compacto</label>
            <input id="toggle_compact" type="checkbox" />
          </div>
        </div>
      </div>
      <div id="tasks" class="cards-autofit"></div>
    </section>

    <!-- DEPENDENCIES -->
    <section id="pane-deps" role="tabpanel" hidden>
      <div class="deps-grid">
        <div class="section-card">
          <h3 style="margin-top:0;">Internas (mismo DAG)</h3>
          <div id="deps"></div>
          <button id="add_dep" class="button" style="margin-top:8px;">+ Dependencia interna</button>
        </div>
        <div class="section-card">
          <h3 style="margin-top:0;">Externas (otro DAG/tarea)</h3>
          <div id="extdeps"></div>
          <button id="add_extdep" class="button" style="margin-top:8px;">+ Dependencia externa</button>
          <p class="muted-note">Crea un <code>ExternalTaskSensor</code> y lo encadena con una tarea local.</p>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- GRAFO -->
<div class="graph-card" style="margin-top:12px;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0;">Vista de Grafo (en vivo)</h3>
    <div class="muted">Se actualiza al editar Tasks/Dependencies</div>
  </div>
  <div id="dagGraph" aria-label="DAG graph"></div>
</div>

<!-- PREVIEW/VALIDACIÓN -->
<div class="card" style="margin-top:12px;">
  <h3 style="margin-top:0;">Preview / Validación</h3>
  <div style="display:flex;gap:8px;margin-bottom:8px;">
    <button class="button secondary" id="btn_show_code">Código</button>
    <button class="button secondary" id="btn_show_val">Validación</button>
  </div>
  <pre id="out_code" class="preview-box">—</pre>
  <pre id="out_val" style="display:none">—</pre>
</div>
{% endblock %}

{% block footer_sticky %}
<div class="footer-sticky">
  <div>Estado: <span id="statusChip" class="tag">sin validar</span></div>
  <div style="display:flex;gap:8px;">
    <button class="button secondary" id="btn_preview_footer">Previsualizar</button>
    <button class="button" id="btn_download_footer">Descargar .py</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('DOMContentLoaded', () => {
/* ===== Tabs ===== */
(function(){
  const KEY='builder:lastTab';
  const tabs=[...document.querySelectorAll('[role="tab"]')];
  const panes = {general:'#pane-general', schedule:'#pane-schedule', tasks:'#pane-tasks', deps:'#pane-deps'};
  function show(name){
    tabs.forEach(t=>t.setAttribute('aria-selected', String(t.dataset.tab===name)));
    Object.entries(panes).forEach(([k,sel])=> document.querySelector(sel).hidden = (k!==name));
    localStorage.setItem(KEY, name);
  }
  tabs.forEach(t => t.addEventListener('click', ()=>show(t.dataset.tab)));
  show(localStorage.getItem(KEY) || 'general');
})();

/* ===== Config comunes ===== */
const OP_TYPES = [
  ["python","PythonOperator"], ["bash","BashOperator"],
  ["dummy","DummyOperator"], ["empty","EmptyOperator"],
  ["sqlite","SqliteOperator"], ["postgres","PostgresOperator"], ["mysql","MySqlOperator"],
  ["email","EmailOperator"], ["http","SimpleHttpOperator"], ["docker","DockerOperator"],
  ["mssql","MsSqlOperator"], ["oracle","OracleOperator"], ["snowflake","SnowflakeOperator"],
  ["s3","S3CreateObjectOperator"], ["lambda","LambdaInvokeFunctionOperator"], ["glue","GlueJobOperator"],
  ["bigquery","BigQueryExecuteQueryOperator"], ["dataflow","DataflowCreateJavaJobOperator"],
  ["azure","AzureDataFactoryRunPipelineOperator"], ["kubernetes","KubernetesPodOperator"],
  ["spark","SparkSubmitOperator"], ["databricks","DatabricksSubmitRunOperator"]
];

function el(tag, attrs={}, html=""){ const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v)); if(html) e.innerHTML=html; return e; }
let tcount = 0;
function normId(v){ let s=String(v||"").trim().replace(/\s+/g,"_"); s=s.replace(/[^A-Za-z0-9_]/g,"_"); if(!/^[A-Za-z_]/.test(s)) s="t_"+s; return s||"t_task"; }
function ensureUniqueTaskIds(tasks){ const seen=new Map(); return tasks.map(t=>{ const base=normId(t.task_id); let id=base; if(seen.has(base)){ const n=seen.get(base)+1; seen.set(base,n); id=`${base}_${n}` } else { seen.set(base,1) } return {...t, task_id:id}; }); }

/* ===== Scheduling (único control) ===== */
window.builderState = window.builderState || { schedule: "@daily", timezone: "America/Santiago" };

function showSchedGroups(kind){
  const all = ['only-once','only-times','only-hourly','only-daily','only-weekly','only-monthly','only-yearly'];
  all.forEach(cls => document.querySelectorAll('.'+cls).forEach(el => el.style.display='none'));
  if (kind==='@once')    document.querySelectorAll('.only-once').forEach(el=>el.style.display='block');
  if (kind==='@times')   document.querySelectorAll('.only-times').forEach(el=>el.style.display='block');
  if (kind==='@hourly')  document.querySelectorAll('.only-hourly').forEach(el=>el.style.display='block');
  if (kind==='@daily')   document.querySelectorAll('.only-daily').forEach(el=>el.style.display='block');
  if (kind==='@weekly')  document.querySelectorAll('.only-weekly,.only-daily').forEach(el=>el.style.display='block');
  if (kind==='@monthly') document.querySelectorAll('.only-monthly,.only-daily').forEach(el=>el.style.display='block');
  if (kind==='@yearly')  document.querySelectorAll('.only-yearly,.only-daily').forEach(el=>el.style.display='block');
  // Cíclico solo aplica a hourly/daily/weekly/monthly/yearly
  document.querySelectorAll('.only-cyclic').forEach(el=>{
    el.style.display = (kind==='@times' || kind==='@once') ? 'none' : 'block';
  });
}

function buildCronFromUI2(){
  const kind = document.getElementById('schedule_kind').value;
  const tz   = (document.getElementById('sched_tz').value || 'UTC').trim();
  window.builderState.timezone = tz;

  // Para @once no hay cron: devolvemos @once y usamos hora en start_time
  if (kind === '@once') return '@once';

  // Horarios específicos: genera 1 o más cron (agrupados por minuto)
  if (kind === '@times'){
    const clamp = (x, min, max) => Math.min(max, Math.max(min, x));

    const dows = Array.from(document.querySelectorAll('input[name="times_dow"]:checked'))
      .map(cb => cb.value)
      .filter(v => v !== undefined && v !== null && v !== "");

    // Si no marca nada, por defecto L-V
    const dowsEff = (dows.length ? dows : ["1","2","3","4","5"]);

    // Normaliza DOW a campo cron
    const uniq = [...new Set(dowsEff.map(String))];
    const asNums = uniq.map(n => parseInt(n,10)).filter(n => !Number.isNaN(n)).sort((a,b)=>a-b);

    let dowField = asNums.join(',');
    // compactar L-V
    if (asNums.length === 5 && asNums.join(',') === '1,2,3,4,5') dowField = '1-5';
    // compactar todos
    if (asNums.length === 7 && asNums.join(',') === '0,1,2,3,4,5,6') dowField = '*';

    const raw = (document.getElementById('times_list')?.value || '').trim();
    const tokens = raw
      .replace(/[;|]+/g, ' ')
      .split(/[\s,]+/g)
      .map(s => s.trim())
      .filter(Boolean);

    const times = [];
    for(const t of tokens){
      let hh=null, mm=null;
      if(t.includes(':')){
        const [h,m] = t.split(':');
        hh = parseInt(h,10); mm = parseInt(m,10);
      }else if(/^\d{4}$/.test(t)){
        hh = parseInt(t.slice(0,2),10); mm = parseInt(t.slice(2),10);
      }else if(/^\d{3}$/.test(t)){
        hh = parseInt(t.slice(0,1),10); mm = parseInt(t.slice(1),10);
      }else if(/^\d{1,2}$/.test(t)){
        // "10" => 10:00
        hh = parseInt(t,10); mm = 0;
      }else{
        continue;
      }
      hh = clamp(hh,0,23); mm = clamp(mm,0,59);
      times.push({hh,mm});
    }

    // dedupe
    const key = (o)=> `${String(o.hh).padStart(2,'0')}:${String(o.mm).padStart(2,'0')}`;
    const uniqTimes = [...new Map(times.map(o=>[key(o),o])).values()]
      .sort((a,b)=> (a.hh-b.hh) || (a.mm-b.mm));

    // fallback si no hay horarios
    if(!uniqTimes.length){
      const cr = `0 9 * * ${dowField}`;
      const pre = document.getElementById('times_crons');
      if(pre) pre.textContent = cr;
      return cr;
    }

    // agrupar por minuto
    const byMin = new Map();
    for(const t of uniqTimes){
      const mmKey = t.mm;
      if(!byMin.has(mmKey)) byMin.set(mmKey, []);
      byMin.get(mmKey).push(t.hh);
    }

    const crons = [];
    [...byMin.entries()].sort((a,b)=>a[0]-b[0]).forEach(([mmVal, hours])=>{
      const hs = [...new Set(hours)].sort((a,b)=>a-b);
      const hhField = hs.join(',');
      crons.push(`${mmVal} ${hhField} * * ${dowField}`);
    });

    const pre = document.getElementById('times_crons');
    if(pre) pre.textContent = crons.join('\n');

    if(crons.length === 1) return crons[0];
    return 'MULTI|' + crons.join('||');
  }


  const HH = +document.getElementById('t_hh')?.value || 0;
  const MM = +document.getElementById('t_mm')?.value || 0;

  const CY   = !!document.getElementById('cyclic_on').checked;
  const unit = (document.getElementById('cyclic_unit')?.value || 'minutes'); // minutes | hours

  const clamp = (x, min, max) => Math.min(max, Math.max(min, x));
  const rawN  = +document.getElementById('cyclic_n')?.value || (unit === 'hours' ? 2 : 15);

  const Nmax  = (unit === 'hours') ? 23 : 59;
  const N     = clamp(rawN, 1, Nmax);

  const F0    = clamp(+document.getElementById('cyc_from')?.value || 0, 0, 23);
  const T0    = clamp(+document.getElementById('cyc_to')?.value   || 23, 0, 23);
  const F     = Math.min(F0, T0);
  const T     = Math.max(F0, T0);

  const cycMM = clamp(+document.getElementById('cyclic_at_mm')?.value || 0, 0, 59);

  // helpers para cron cíclico
  const cyclicDaily = () => {
    if (unit === 'minutes') return `*/${N} ${F}-${T} * * *`;
    // horas: minuto fijo, hora con step
    if (F === 0 && T === 23) return `${cycMM} */${N} * * *`;
    return `${cycMM} ${F}-${T}/${N} * * *`;
  };

  const cyclicWeekly = (DOW) => {
    if (unit === 'minutes') return `*/${N} ${F}-${T} * * ${DOW}`;
    if (F === 0 && T === 23) return `${cycMM} */${N} * * ${DOW}`;
    return `${cycMM} ${F}-${T}/${N} * * ${DOW}`;
  };

  const cyclicMonthly = (DOM) => {
    if (unit === 'minutes') return `*/${N} ${F}-${T} ${DOM} * *`;
    if (F === 0 && T === 23) return `${cycMM} */${N} ${DOM} * *`;
    return `${cycMM} ${F}-${T}/${N} ${DOM} * *`;
  };

  const cyclicYearly = (DOM, MON) => {
    if (unit === 'minutes') return `*/${N} ${F}-${T} ${DOM} ${MON} *`;
    if (F === 0 && T === 23) return `${cycMM} */${N} ${DOM} ${MON} *`;
    return `${cycMM} ${F}-${T}/${N} ${DOM} ${MON} *`;
  };

  if (kind === '@hourly'){
    if (CY) return cyclicDaily(); // permite también ciclos en horas
    const hmm   = +document.getElementById('h_mm').value || 0;
    const hstart = document.getElementById('h_start').value;
    if (hstart !== "" && hstart !== undefined && hstart !== null){
      const HS = Math.min(23, Math.max(0, +hstart));
      return `${hmm} ${HS}-23 * * *`;
    }
    return `${hmm} * * * *`;
  }
  if (kind === '@daily'){
    if (CY) return cyclicDaily();
    return `${MM} ${HH} * * *`;
  }
    if (kind === '@weekly'){
    const DOW = document.getElementById('w_dow').value;
    if (CY) return cyclicWeekly(DOW);
    return `${MM} ${HH} * * ${DOW}`;
  }

    if (kind === '@monthly'){
    const DOM = +document.getElementById('m_dom').value || 1;
    if (CY) return cyclicMonthly(DOM);
    return `${MM} ${HH} ${DOM} * *`;
  }

    if (kind === '@yearly'){
    const MON = +document.getElementById('y_mon').value || 1;
    const DOM = +document.getElementById('y_dom').value || 1;
    if (CY) return cyclicYearly(DOM, MON);
    return `${MM} ${HH} ${DOM} ${MON} *`;
  }

  return "@daily";
}

(function initSched2(){
  const kindSel = document.getElementById('schedule_kind');
  const tz      = document.getElementById('sched_tz');

  const initial = window.builderState.schedule || '@daily';
  if (['@once','@times','@hourly','@daily','@weekly','@monthly','@yearly'].includes(initial)){
    kindSel.value = initial;
  } else { kindSel.value = '@daily'; }
  tz.value = window.builderState.timezone || tz.value || 'UTC';

  // Botones rápidos para @times
  function setTimesDows(mode){
    const cbs = Array.from(document.querySelectorAll('input[name="times_dow"]'));
    if(!cbs.length) return;
    if(mode==='lv'){
      cbs.forEach(cb => cb.checked = ['1','2','3','4','5'].includes(cb.value));
    } else if(mode==='all'){
      cbs.forEach(cb => cb.checked = true);
    } else if(mode==='none'){
      cbs.forEach(cb => cb.checked = false);
    }
    if (typeof syncCronFromUI === 'function') syncCronFromUI();
  }
  document.getElementById('times_btn_lv')?.addEventListener('click', ()=> setTimesDows('lv'));
  document.getElementById('times_btn_all')?.addEventListener('click', ()=> setTimesDows('all'));
  document.getElementById('times_btn_none')?.addEventListener('click', ()=> setTimesDows('none'));
  document.querySelectorAll('input[name="times_dow"]').forEach(cb=>{
    cb.addEventListener('change', ()=>{ if (typeof syncCronFromUI === 'function') syncCronFromUI(); });
  });

  // Auto-sync al tocar cualquier campo de scheduling
  const schedIds = [
    'schedule_kind','sched_tz',
    't_hh','t_mm','h_mm','h_start',
    'w_dow','m_dom','y_mon','y_dom',
    'cyclic_on','cyclic_n','cyclic_unit','cyclic_at_mm','cyc_from','cyc_to',
    'once_hh','once_mm',
    'times_list'
  ];
  schedIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const ev = (el.tagName === 'SELECT' || el.type === 'checkbox') ? 'change' : 'input';
    el.addEventListener(ev, ()=>{ if (typeof syncCronFromUI === 'function') syncCronFromUI(); });
    if(ev !== 'change') el.addEventListener('change', ()=>{ if (typeof syncCronFromUI === 'function') syncCronFromUI(); });
  });
  showSchedGroups(kindSel.value);

  // Mantener builderState.schedule sincronizado con la UI (evita que el preview use el valor inicial "@daily")
  function syncCronFromUI(){
    const cron = buildCronFromUI2();
    window.builderState.schedule = cron;
    const cp = document.getElementById('cron_preview');
    if(cp){
      if(typeof cron === 'string' && cron.startsWith('MULTI|')){
        const n = cron.slice(6).split('||').filter(Boolean).length;
        cp.textContent = `MULTI (${n})`;
        cp.title = cron;
      }else{
        cp.textContent = cron || '—';
        cp.title = '';
      }
    }
    return cron;
  }

  kindSel.addEventListener('change', ()=> { showSchedGroups(kindSel.value); syncCronFromUI(); });

  document.getElementById('btn_build_cron').addEventListener('click', ()=>{
    syncCronFromUI();
  });

  document.getElementById('btn_preview_runs').addEventListener('click', async ()=>{
    const cron = window.builderState.schedule || buildCronFromUI2();
    const timezone = window.builderState.timezone || 'UTC';
    async function previewOne(cr){
      const r = await fetch('/api/schedule/preview', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ cron: cr, timezone, count: 5 }),
      });
      const data = await r.json().catch(()=>({error:'resp inválida'}));
      if(data.error) throw new Error(data.error);
      return Array.isArray(data.next_runs) ? data.next_runs : [];
    }

    try {
      // MULTI|cron1||cron2...
      if(typeof cron === 'string' && cron.startsWith('MULTI|')){
        const parts = cron.slice(6).split('||').map(s=>s.trim()).filter(Boolean);
        const lists = await Promise.all(parts.map(p => previewOne(p)));
        const merged = lists.flat().filter(Boolean);

        // Ordenar (formato "YYYY-MM-DD HH:MM:SS" => orden lexicográfico funciona)
        merged.sort();

        // dedupe y tomar 5
        const out = [];
        const seen = new Set();
        for(const dt of merged){
          if(seen.has(dt)) continue;
          seen.add(dt);
          out.push(dt);
          if(out.length >= 5) break;
        }
        document.getElementById('runs_preview').textContent = out.length ? out.join('  ·  ') : '—';
        return;
      }

      const runs = await previewOne(cron);
      document.getElementById('runs_preview').textContent = runs.length ? runs.join('  ·  ') : '—';
    } catch (e) {
      document.getElementById('runs_preview').textContent = 'Error: ' + (e?.message || '—');
    }
  });

    function toggleCyclicUnitFields(){
    const unitSel = document.getElementById('cyclic_unit');
    const wrap    = document.getElementById('cyclic_at_mm_wrap');
    const nInput  = document.getElementById('cyclic_n');
    if(!unitSel || !wrap || !nInput) return;

    const unit = unitSel.value || 'minutes';
    wrap.style.display = (unit === 'hours') ? 'block' : 'none';

    // ajustar max según unidad
    nInput.max = (unit === 'hours') ? '23' : '59';
    const n = +nInput.value || 1;
    if(unit === 'hours' && n > 23) nInput.value = 23;
    if(unit === 'minutes' && n > 59) nInput.value = 59;

    // recalcular cron al cambiar unidad/max
    if (typeof syncCronFromUI === 'function') syncCronFromUI();
  }

  document.getElementById('cyclic_unit')?.addEventListener('change', ()=>{ toggleCyclicUnitFields(); if (typeof syncCronFromUI === 'function') syncCronFromUI(); });
  toggleCyclicUnitFields();
  if (typeof syncCronFromUI === 'function') syncCronFromUI();


})();
/* ===== Tasks / Deps / Graph ===== */
/* ===== Tasks ===== */
function taskIdOptions(){
  return Array.from(document.querySelectorAll('#tasks input[data-k="task_id"]'))
    .map(i=>normId(i.value)).filter(Boolean)
    .filter((v,i,a)=>a.indexOf(v)===i);
}
function refreshTaskSelects(){
  const ids = taskIdOptions();
  document.querySelectorAll('#deps select[data-k="_sel"]').forEach(sel=>{
    const v=sel.value; sel.innerHTML=""; ids.forEach(id=>sel.appendChild(el("option",{value:id},id))); if(ids.includes(v)) sel.value=v;
  });
  document.querySelectorAll('#extdeps select[data-k="downstream"]').forEach(sel=>{
    const v=sel.value; sel.innerHTML=""; ids.forEach(id=>sel.appendChild(el("option",{value:id},id))); if(ids.includes(v)) sel.value=v;
  });
}
function addTask(type){
  const wrap = el("div",{class:"section-card"});
  const tid = `t${++tcount}`;
  wrap.appendChild(el("div",{},`<b>${type}</b>`));
  wrap.appendChild(el("label",{},"task_id"));
  const idInput = el("input",{value:tid,"data-k":"task_id"});
  idInput.addEventListener('change', refreshTaskSelects);
  wrap.appendChild(idInput);
  wrap.appendChild(el("input",{"type":"hidden","data-k":"type",value:type}));

  const add = (label, key, ph="", long=false) => {
    wrap.appendChild(el("label",{},label));
    if(long){ wrap.appendChild(el("textarea",{"data-k":key,style:"height:88px;"}, ph)); }
    else { wrap.appendChild(el("input",{"data-k":key,placeholder:ph})); }
  };

  if(type==="BashOperator"){ add("bash_command","bash_command","echo 'hola'"); }
  if(type==="PythonOperator"){ add("python_callable_name","python_callable_name","my_callable"); add("python_callable_body","python_callable_body","print('Hello')",true); }
  if(type==="SqliteOperator"){ add("sqlite_conn_id","sqlite_conn_id","sqlite_default"); add("sql","sql","SELECT 1;"); }
  if(type==="PostgresOperator"){ add("postgres_conn_id","postgres_conn_id","postgres_default"); add("sql","sql","SELECT 1;"); }
  if(type==="MySqlOperator"){ add("mysql_conn_id","mysql_conn_id","mysql_default"); add("sql","sql","SELECT 1;"); }
  if(type==="MsSqlOperator"){ add("mssql_conn_id","mssql_conn_id","mssql_default"); add("sql","sql","SELECT 1;"); }
  if(type==="OracleOperator"){ add("oracle_conn_id","oracle_conn_id","oracle_default"); add("sql","sql","SELECT 1 FROM dual"); }
  if(type==="SnowflakeOperator"){ add("snowflake_conn_id","snowflake_conn_id","snowflake_default"); add("sql","sql","SELECT 1;"); }
  if(type==="S3CreateObjectOperator"){ add("aws_conn_id","aws_conn_id","aws_default"); add("s3_bucket","s3_bucket","my-bucket"); add("s3_key","s3_key","path/file.txt"); add("data","data","hello world"); }
  if(type==="LambdaInvokeFunctionOperator"){ add("aws_conn_id","aws_conn_id","aws_default"); add("function_name","function_name","my-fn"); add("payload","payload",'{"key":"value"}'); }
  if(type==="GlueJobOperator"){ add("aws_conn_id","aws_conn_id","aws_default"); add("job_name","job_name","my-job"); add("script_location","script_location","s3://bucket/script.py"); add("iam_role_name","iam_role_name","glue-role"); add("num_of_dpus","num_of_dpus","10"); }
  if(type==="BigQueryExecuteQueryOperator"){ add("gcp_conn_id","gcp_conn_id","google_cloud_default"); add("sql","sql","SELECT 1;"); add("use_legacy_sql","use_legacy_sql","false"); }
  if(type==="DataflowCreateJavaJobOperator"){ add("gcp_conn_id","gcp_conn_id","google_cloud_default"); add("jar","jar","/path/app.jar"); add("job_name","job_name","dataflow-job"); add("options","options",'{"key":"value"}'); }
  if(type==="AzureDataFactoryRunPipelineOperator"){ add("azure_data_factory_conn_id","azure_data_factory_conn_id","azure_data_factory_default"); add("pipeline_name","pipeline_name","pipeline1"); add("parameters","parameters",'{"p":1}'); }
  if(type==="DockerOperator"){ add("image","image","python:3.11"); add("api_version","api_version","auto"); add("command","command","echo hello"); add("docker_url","docker_url","unix://var/run/docker.sock"); add("auto_remove","auto_remove","true"); }
  if(type==="KubernetesPodOperator"){ add("name","name","pod-task"); add("namespace","namespace","default"); add("image","image","python:3.11"); add("cmds","cmds",'["python","-c"]'); add("arguments","arguments",'["print(\\"hi\\")"]'); add("env","env",'{"ENV":"value"}'); }
  if(type==="SparkSubmitOperator"){ add("application","application","/path/app.py"); add("conn_id","conn_id","spark_default"); add("application_args","application_args",'["--flag","value"]'); }
  if(type==="DatabricksSubmitRunOperator"){ add("databricks_conn_id","databricks_conn_id","databricks_default"); add("json","json",'{"run_name":"demo","new_cluster":{...}}',true); }
  if(type==="SimpleHttpOperator"){ add("http_conn_id","http_conn_id","http_default"); add("endpoint","endpoint","/"); add("method","method","GET"); add("data","data",""); add("headers","headers",'{"Content-Type":"application/json"}'); }
  if(type==="EmailOperator"){ add("to","to","example@example.com"); add("subject","subject","Airflow Notification"); add("html_content","html_content","Job done."); }

  if(type==="CustomOperator"){
    const help = el("div",{class:"muted"}, "Completa import path, class y kwargs (JSON).");
    wrap.appendChild(help);
    const row = el("div", {style:"display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px;"});
    const ip = el("div"); ip.appendChild(el("label",{},"import_path")); ip.appendChild(el("input",{"data-k":"import_path",placeholder:"airflow.providers.xxx.operators.yyy"}));
    const cl = el("div"); cl.appendChild(el("label",{},"class_name"));   cl.appendChild(el("input",{"data-k":"class_name",placeholder:"SomeOperator"}));
    row.appendChild(ip); row.appendChild(cl);
    wrap.appendChild(row);
    wrap.appendChild(el("label",{},"kwargs (JSON)"));
    wrap.appendChild(el("textarea",{"data-k":"kwargs",style:"height:120px;"}, "{\n  \n}"));
  }

  if(type==="SSHOperator"){
    const help = el("div",{class:"muted-note"},
      "Ejecuta en host remoto por SSH (usa Connection ssh_conn_id). " +
      "Elige comando directo o script (ruta + archivo) y agrega parámetros (argumentos) si aplica."
    );
    wrap.appendChild(help);

    // Conexión
    wrap.appendChild(el("label",{},"ssh_conn_id"));
    const sshConn = el("input",{"data-k":"ssh_conn_id",placeholder:"ssh_default"});
    wrap.appendChild(sshConn);

    wrap.appendChild(el("label",{},"remote_host (opcional)"));
    const remoteHost = el("input",{"data-k":"remote_host",placeholder:"host remoto si tu Conn no lo define"});
    wrap.appendChild(remoteHost);

    // Tipo de ejecución (solo UI; NO va a spec)
    wrap.appendChild(el("label",{},"tipo de ejecución"));
    const modeSel = el("select",{"data-ui":"ssh_mode"});
    modeSel.innerHTML = '<option value="command" selected>comando</option><option value="script">script</option>';
    wrap.appendChild(modeSel);

    // Bloque script (solo UI)
    const scriptBox = el("div",{style:"margin-top:8px; padding:12px; border:1px dashed var(--border); border-radius:12px; display:none;"});
    scriptBox.appendChild(el("div",{class:"muted-note"},"Si eliges script: indica ruta + script. El command se autogenera y se guarda en el campo 'command'."));

    const sg = el("div",{class:"form-grid-3", style:"margin-top:8px;"});
    const dirDiv  = el("div",{});
    const fileDiv = el("div",{});
    const shDiv   = el("div",{});

    const dirInp  = el("input",{placeholder:"/opt/jobs"});
    const fileInp = el("input",{placeholder:"mi_job.ksh"});
    const shSel   = el("select",{});
    shSel.innerHTML = '<option value="ksh" selected>ksh</option><option value="bash">bash</option><option value="sh">sh</option><option value="direct">directo (ejecutable)</option>';

    dirDiv.appendChild(el("label",{},"ruta (directorio)"));
    dirDiv.appendChild(dirInp);
    fileDiv.appendChild(el("label",{},"script (archivo)"));
    fileDiv.appendChild(fileInp);
    shDiv.appendChild(el("label",{},"intérprete"));
    shDiv.appendChild(shSel);

    sg.appendChild(dirDiv);
    sg.appendChild(fileDiv);
    sg.appendChild(shDiv);
    scriptBox.appendChild(sg);

    const sg2 = el("div",{class:"form-grid-2", style:"margin-top:8px;"});
    const argsDiv = el("div",{});
    const cdDiv = el("div",{});

    const argsInp = el("input",{placeholder:"--param1 123 --flag (opcional)"});
    argsDiv.appendChild(el("label",{},"argumentos (opcional)"));
    argsDiv.appendChild(argsInp);

    const cdChk = el("input",{type:"checkbox"});
    cdChk.checked = true;
    cdDiv.appendChild(el("label",{},"ejecutar desde la ruta (cd)"));
    const cdRow = el("div",{style:"display:flex; gap:8px; align-items:center;"});
    cdRow.appendChild(cdChk);
    cdRow.appendChild(el("span",{class:"muted-note"},"(recomendado para scripts con rutas relativas)"));
    cdDiv.appendChild(cdRow);

    sg2.appendChild(argsDiv);
    sg2.appendChild(cdDiv);
    scriptBox.appendChild(sg2);

    const btnGen = el("button",{class:"button ghost", type:"button", style:"margin-top:8px;"},"Construir command");
    scriptBox.appendChild(btnGen);

    wrap.appendChild(scriptBox);

    // Command (sí va a spec)
    wrap.appendChild(el("label",{},"command"));
    const cmdTA = el("textarea",{"data-k":"command",style:"height:88px;"},"echo 'hola'");
    wrap.appendChild(cmdTA);

    const manualRow = el("div",{style:"display:flex; gap:10px; align-items:center; margin-top:6px;"});
    const manualChk = el("input",{type:"checkbox"});
    manualRow.appendChild(manualChk);
    manualRow.appendChild(el("span",{class:"muted-note"},"Editar command manualmente (solo aplica si elegiste script)"));
    wrap.appendChild(manualRow);

    // Parámetros para la shell (argumentos). NO son environment vars.
    const parmSection = el("div",{style:"margin-top:8px; padding:10px; border:1px solid var(--border); border-radius:12px; display:none;"});
    parmSection.appendChild(el("div",{class:"muted-note"},
      "Estos valores se agregan como argumentos al final del command del script (ej: split_file.ksh -r -c ...). " +
      "Si necesitas variables de entorno reales, usa el modo avanzado environment (JSON)."
    ));

    const argsManualRow = el("div",{style:"display:flex; gap:10px; align-items:center; margin-top:6px;"});
    const argsManualChk = el("input",{type:"checkbox"});
    argsManualRow.appendChild(argsManualChk);
    argsManualRow.appendChild(el("span",{class:"muted-note"},"Editar args manualmente"));
    parmSection.appendChild(argsManualRow);

    // Builder de parámetros
    const pBox = el("div",{style:"margin-top:8px; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);"});
    const pRow = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap;"});
    const pK = el("input",{placeholder:"PARM1", style:"min-width:160px;"});
    const pV = el("input",{placeholder:"valor (ej: -r / *.log / /ruta)", style:"min-width:220px; flex:1;"});
    const pAdd = el("button",{class:"button ghost", type:"button"},"+ Agregar");
    pRow.appendChild(pK); pRow.appendChild(pV); pRow.appendChild(pAdd);
    const pList = el("div",{style:"margin-top:8px; display:flex; flex-direction:column; gap:6px;"});
    pBox.appendChild(pRow); pBox.appendChild(pList);
    parmSection.appendChild(pBox);

    // script_params se guarda en spec (opcional)
    const spTA = el("textarea",{"data-k":"script_params",style:"height:72px;"},'{}');
    const spDetails = el("details",{style:"margin-top:8px;"});
    spDetails.appendChild(el("summary",{},"Modo avanzado: script_params (JSON)"));
    spDetails.appendChild(spTA);
    parmSection.appendChild(spDetails);

    wrap.appendChild(parmSection);

    function paramsFromUI(){
      const rows = Array.from(pList.querySelectorAll('[data-p-row="1"]'));
      const pairs = [];
      rows.forEach(r=>{
        const k = (r.querySelector('[data-p-k]')?.value || '').trim();
        const v = (r.querySelector('[data-p-v]')?.value || '').trim();
        if(k && v !== '') pairs.push([k,v]);
      });
      // ordenar PARM\d+ si aplica
      const allParm = pairs.length && pairs.every(([k,_]) => /^PARM\d+$/i.test(k));
      if(allParm){
        pairs.sort((a,b)=> parseInt(a[0].slice(4),10) - parseInt(b[0].slice(4),10));
      }
      const obj = {};
      pairs.forEach(([k,v])=>{ obj[k]=v; });
      return {pairs, obj};
    }

    function syncParamsToTextarea(){
      try{ JSON.parse(spTA.value || "{}"); } catch { return; } // no pisar si inválido
      const {obj} = paramsFromUI();
      spTA.value = JSON.stringify(obj);
    }

    function argsFromParams(){
      const {pairs} = paramsFromUI();
      return pairs.map(([_,v])=> String(v).trim()).filter(Boolean).join(' ');
    }

    function syncArgsFromParams(){
      if(argsManualChk.checked) return;
      argsInp.value = argsFromParams();
    }

    function addParamRow(k,v){
      const row = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap;", "data-p-row":"1"});
      const kk = el("input",{"data-p-k":"1", style:"min-width:160px;", value: k || ""});
      const vv = el("input",{"data-p-v":"1", style:"min-width:220px; flex:1;", value: v || ""});
      const rm = el("button",{class:"button ghost", type:"button"},"Quitar");

      function syncAll(){
        syncParamsToTextarea();
        syncArgsFromParams();
        if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript();
      }

      rm.addEventListener("click", ()=>{ row.remove(); syncAll(); });
      kk.addEventListener("input", syncAll);
      vv.addEventListener("input", syncAll);

      row.appendChild(kk);
      row.appendChild(vv);
      row.appendChild(rm);
      pList.appendChild(row);
      syncAll();
    }

    pAdd.addEventListener("click", ()=>{
      const kk = (pK.value || "").trim();
      if(!kk) return;
      addParamRow(kk, pV.value || "");
      pK.value = ""; pV.value = "";
      pK.focus();
    });

    argsManualChk.addEventListener("change", ()=>{
      argsInp.readOnly = !argsManualChk.checked;
      if(!argsManualChk.checked) syncArgsFromParams();
      if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript();
    });

    // Environment (JSON) real para spec (modo avanzado)
    const envTA = el("textarea",{"data-k":"environment",style:"height:72px;"},'{}');
    const envDetails = el("details",{style:"margin-top:8px;"});
    envDetails.appendChild(el("summary",{},"Modo avanzado: environment (JSON)"));
    envDetails.appendChild(envTA);
    wrap.appendChild(envDetails);

// Editor simple de environment (opcional). Se sincroniza con envTA.
// Nota: environment son variables de entorno reales del proceso remoto, NO argumentos.
wrap.appendChild(el("label",{},"variables de entorno (opcional)"));
const varBox = el("div",{style:"padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);"});
varBox.appendChild(el("div",{class:"muted-note"},
  "Estas variables se envían como environment del comando remoto. " +
  "No son argumentos; para argumentos usa el bloque de Parámetros/args."
));

const kvRow = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px;"});
const kInp = el("input",{placeholder:"NOMBRE_VAR", style:"min-width:180px;"});
const vInp = el("input",{placeholder:"valor", style:"min-width:220px; flex:1;"});
const addBtn = el("button",{class:"button ghost", type:"button"},"+ Agregar");
kvRow.appendChild(kInp);
kvRow.appendChild(vInp);
kvRow.appendChild(addBtn);

const list = el("div",{style:"margin-top:8px; display:flex; flex-direction:column; gap:6px;"});
varBox.appendChild(kvRow);
varBox.appendChild(list);
wrap.appendChild(varBox);


    // get_pty (sí va a spec)
    wrap.appendChild(el("label",{},"get_pty"));
    const sel = el("select",{"data-k":"get_pty"});
    sel.innerHTML = '<option value="true">true</option><option value="false" selected>false</option>';
    wrap.appendChild(sel);

    // Helpers
    const dq = (s) => (s ?? "").replace(/\\/g,"\\\\").replace(/"/g,'\\"');

    function buildShellCall(shell, scriptRef){
      const q = `"${dq(scriptRef)}"`;
      if(shell === "direct") return q;
      return `${shell} ${q}`;
    }

    function envFromUI(){
      const env = {};
      Array.from(list.querySelectorAll('[data-env-row="1"]')).forEach(row=>{
        const kk = row.querySelector('[data-env-k]')?.value?.trim();
        const vv = row.querySelector('[data-env-v]')?.value ?? "";
        if(kk) env[kk] = vv;
      });
      return env;
    }

    function syncEnvToTextarea(){
      // Si el JSON actual es inválido, no lo pisamos (para no romper el modo avanzado)
      try{ JSON.parse(envTA.value || "{}"); } catch { return; }
      envTA.value = JSON.stringify(envFromUI());
    }

    function addEnvRow(k, v){
      const row = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap;", "data-env-row":"1"});
      const kk = el("input",{"data-env-k":"1", style:"min-width:180px;", value: k || ""});
      const vv = el("input",{"data-env-v":"1", style:"min-width:220px; flex:1;", value: v || ""});
      const rm = el("button",{class:"button ghost", type:"button"},"Quitar");

      rm.addEventListener("click", ()=>{ row.remove(); syncEnvToTextarea(); });
      kk.addEventListener("input", syncEnvToTextarea);
      vv.addEventListener("input", syncEnvToTextarea);

      row.appendChild(kk);
      row.appendChild(vv);
      row.appendChild(rm);
      list.appendChild(row);
      syncEnvToTextarea();
    }

    addBtn.addEventListener("click", ()=>{
      const kk = (kInp.value || "").trim();
      if(!kk) return;
      addEnvRow(kk, vInp.value ?? "");
      kInp.value = ""; vInp.value = "";
      kInp.focus();
    });

    function buildCommandFromScript(){
      const dir  = (dirInp.value || "").trim();
      const file = (fileInp.value || "").trim();
      const args = (argsInp.value || "").trim();
      const shell = shSel.value || "ksh";
      if(!file){
        cmdTA.value = "";
        return;
      }
      let cmd = "";
      if(dir){
        if(cdChk.checked){
          const ref = (file.startsWith("./") || file.startsWith("/") ) ? file : `./${file}`;
          cmd = `cd "${dq(dir)}" && ${buildShellCall(shell, ref)}`;
        }else{
          const cleanDir = dir.replace(/\/+$/,"");
          const cleanFile = file.replace(/^\/+/, "");
          const full = `${cleanDir}/${cleanFile}`;
          cmd = buildShellCall(shell, full);
        }
      }else{
        cmd = buildShellCall(shell, file);
      }
      if(args) cmd += ` ${args}`;
      cmdTA.value = cmd;
    }

    function applyMode(){
      const m = modeSel.value || "command";
      const isScript = (m === "script");
      scriptBox.style.display = isScript ? "block" : "none";
      parmSection.style.display = isScript ? "block" : "none";

      if(isScript){
        // args: por defecto se construyen desde script_params
        argsInp.readOnly = !argsManualChk.checked;
        if(!argsManualChk.checked) syncArgsFromParams();

        cmdTA.readOnly = !manualChk.checked;
        if(!manualChk.checked){
          buildCommandFromScript();
        }
      }else{
        cmdTA.readOnly = false;
      }
    }

    // Eventos
    modeSel.addEventListener("change", applyMode);
    manualChk.addEventListener("change", applyMode);

    [dirInp, fileInp, argsInp].forEach(inp=>{
      inp.addEventListener("input", ()=>{ if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript(); });
    });
    shSel.addEventListener("change", ()=>{ if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript(); });
    cdChk.addEventListener("change", ()=>{ if(modeSel.value==="script" && !manualChk.checked) buildCommandFromScript(); });
    btnGen.addEventListener("click", ()=>{ if(modeSel.value==="script") buildCommandFromScript(); });

    // Estado inicial
    applyMode();
  }

  if(type==="WinRMOperator"){
    const help = el("div",{class:"muted"}, "Ejecuta comando en Windows por WinRM (usa Connection winrm_conn_id).");
    wrap.appendChild(help);
    wrap.appendChild(el("label",{},"winrm_conn_id"));
    wrap.appendChild(el("input",{"data-k":"winrm_conn_id",placeholder:"winrm_default"}));
    wrap.appendChild(el("label",{},"command (PowerShell o cmd)"));
    wrap.appendChild(el("textarea",{"data-k":"command",style:"height:88px;"},"Write-Output 'hola'"));
    wrap.appendChild(el("label",{},"powershell"));
    const sel = el("select",{"data-k":"powershell"}); sel.innerHTML='<option value="true">true</option><option value="false">false</option>'; wrap.appendChild(sel);
  }

const adv = el("details",{style:"margin-top:8px;"});
adv.appendChild(el("summary",{}, "Recursos (Control-M) y Avanzado"));

// ── Recursos (múltiples, estilo Control-M). Nota: Airflow aplica SOLO 1 pool por task.
const resBox = el("div",{style:"margin-top:8px; padding:10px; border:1px solid var(--border); border-radius:12px;"});
resBox.appendChild(el("div",{class:"muted-note"},
  "Puedes registrar más de un recurso (cuantitativo/exclusivo) para la migración desde Control-M. " +
  "Airflow aplica solo 1 pool por task: marca uno como 'aplicado'. Los demás quedan documentados en la spec (resources)."
));

// Vista/entrada del pool aplicado (Airflow aplica 1 pool por task)
// Aquí ingresas un recurso y lo agregas a la lista. El "aplicado" es el que está marcado como primary.
const applied = el("div",{style:"display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px;margin-top:8px;align-items:end;"});

const apTypeDiv = el("div",{}); apTypeDiv.appendChild(el("label",{},"tipo (aplicado)"));
const apTypeView = el("select",{style:"width:100%;"});
apTypeView.innerHTML = '<option value="quant" selected>Cuantitativo</option><option value="exclusive">Exclusivo</option>';
apTypeDiv.appendChild(apTypeView);

const apPoolDiv = el("div",{}); apPoolDiv.appendChild(el("label",{},"pool (aplicado)"));
const apPoolView = el("input",{placeholder:"nombre pool / recurso", style:"width:100%;"});
apPoolDiv.appendChild(apPoolView);

const apSlotsDiv = el("div",{}); apSlotsDiv.appendChild(el("label",{},"slots (aplicados)"));
const apSlotsView = el("input",{type:"number", min:"1", step:"1", value:"1", style:"width:100%;"});
apSlotsDiv.appendChild(apSlotsView);

const apAddDiv = el("div",{});
apAddDiv.appendChild(el("label",{},""));
const apAddBtn = el("button",{class:"button ghost", type:"button", style:"width:100%;"},"+ Agregar recurso");
apAddDiv.appendChild(apAddBtn);

applied.appendChild(apTypeDiv);
applied.appendChild(apPoolDiv);
applied.appendChild(apSlotsDiv);
applied.appendChild(apAddDiv);
resBox.appendChild(applied);

// Alias para reutilizar la lógica existente
const rType = apTypeView;
const rPool = apPoolView;
const rSlots = apSlotsView;
const rAdd  = apAddBtn;

// Lista de recursos
const resList = el("div",{style:"margin-top:8px; display:flex; flex-direction:column; gap:6px;"});
resBox.appendChild(resList);

adv.appendChild(resBox);

// Hidden fields para el generador (compatibilidad)
const poolInp = el("input",{"data-k":"pool",style:"display:none;"});
const slotsInp = el("input",{"data-k":"pool_slots",style:"display:none;", value:"1"});
const resourcesTA = el("textarea",{"data-k":"resources",style:"display:none;height:72px;"}, "[]");
adv.appendChild(poolInp);
adv.appendChild(slotsInp);
adv.appendChild(resourcesTA);

// ── Otros campos avanzados comunes
const grid2 = el("div",{style:"display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px;margin-top:8px;"});

const qWrap = el("div",{});
qWrap.appendChild(el("label",{},"queue (opcional)"));
qWrap.appendChild(el("input",{"data-k":"queue",placeholder:"celery queue"}));

const pwWrap = el("div",{});
pwWrap.appendChild(el("label",{},"priority_weight (opcional)"));
pwWrap.appendChild(el("input",{"data-k":"priority_weight",type:"number",min:"1",step:"1"}));

const dopWrap = el("div",{});
dopWrap.appendChild(el("label",{},"depends_on_past"));
const dopSel = el("select",{"data-k":"depends_on_past"});
dopSel.innerHTML = '<option value="false" selected>false</option><option value="true">true</option>';
dopWrap.appendChild(dopSel);

const tcWrap = el("div",{});
tcWrap.appendChild(el("label",{},"task_concurrency (opcional)"));
tcWrap.appendChild(el("input",{"data-k":"task_concurrency",type:"number",min:"1",step:"1"}));

grid2.appendChild(qWrap);
grid2.appendChild(pwWrap);
grid2.appendChild(dopWrap);
grid2.appendChild(tcWrap);

adv.appendChild(grid2);

// helpers recursos
function _resRead(){
  try{ return JSON.parse(resourcesTA.value || "[]") || []; } catch { return []; }
}
function _resWrite(list){
  resourcesTA.value = JSON.stringify(list || []);
}
function _resSyncApplied(list){
  const applied = list.find(x=>x.primary) || list[0];
  if(applied && applied.pool){
    poolInp.value = applied.pool;
    slotsInp.value = String(applied.slots || 1);
    apPoolView.value = applied.pool;
    apSlotsView.value = String(applied.slots || 1);
    apTypeView.value = (applied.type === "exclusive") ? "exclusive" : "quant";
    // Ajuste slots en UI según tipo
    if(apTypeView.value==="exclusive"){ apSlotsView.value = "1"; apSlotsView.disabled = true; }
    else { apSlotsView.disabled = false; }
  }else{
    poolInp.value = "";
    slotsInp.value = "1";
    apPoolView.value = "";
    apSlotsView.value = "1";
    apTypeView.value = "quant";
    apSlotsView.disabled = false;
  }
}

function _resRender(){
  const list = _resRead();
  resList.innerHTML = "";
  if(!list.length){
    resList.appendChild(el("div",{class:"muted-note"},"(sin recursos configurados)"));
    _resSyncApplied(list);
    return;
  }

  list.forEach((it, idx)=>{
    const row = el("div",{style:"display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:8px; border:1px solid var(--border); border-radius:12px; background:var(--panel-alt);"});
    const radio = el("input",{type:"radio", name:`res_primary_${tid}`});
    radio.checked = !!it.primary;

    const type = el("span",{class:"pill"}, it.type==="exclusive" ? "Exclusivo" : "Cuantitativo");
    const pool = el("span",{style:"min-width:220px; word-break:break-all;"}, it.pool || "");
    const slots = el("span",{class:"muted-note"}, `slots: ${it.slots || 1}`);

    const editType = el("select",{});
    editType.innerHTML = '<option value="quant">Cuantitativo</option><option value="exclusive">Exclusivo</option>';
    editType.value = it.type || "quant";

    const editPool = el("input",{value: it.pool || "", style:"min-width:220px; flex:1;"});
    const editSlots = el("input",{type:"number", min:"1", step:"1", value: String(it.slots || 1), style:"width:120px;"});
    if(editType.value==="exclusive"){ editSlots.value="1"; editSlots.disabled=true; }

    const rm = el("button",{class:"button ghost", type:"button"},"Quitar");

    function save(){
      const arr = _resRead();
      const cur = arr[idx];
      if(!cur) return;
      cur.type = editType.value;
      cur.pool = (editPool.value || "").trim();
      cur.slots = (cur.type==="exclusive") ? 1 : Math.max(1, parseInt(editSlots.value||"1",10));
      // mantener primary por radio group
      _resWrite(arr);
      _resSyncApplied(arr);
      _resRender();
    }

    radio.addEventListener("change", ()=>{
      const arr = _resRead();
      arr.forEach((x,i)=> x.primary = (i===idx));
      _resWrite(arr);
      _resSyncApplied(arr);
      _resRender();
    });

    editType.addEventListener("change", ()=>{
      if(editType.value==="exclusive"){ editSlots.value="1"; editSlots.disabled=true; }
      else { editSlots.disabled=false; }
      save();
    });
    editPool.addEventListener("input", save);
    editSlots.addEventListener("input", save);

    rm.addEventListener("click", ()=>{
      const arr = _resRead();
      arr.splice(idx,1);
      // si quitamos el primary, elegir primero
      if(arr.length && !arr.some(x=>x.primary)) arr[0].primary = true;
      _resWrite(arr);
      _resSyncApplied(arr);
      _resRender();
    });

    row.appendChild(radio);
    row.appendChild(type);
    row.appendChild(pool);
    row.appendChild(slots);
    // editor inline
    row.appendChild(el("span",{class:"muted-note"},"→"));
    row.appendChild(editType);
    row.appendChild(editPool);
    row.appendChild(editSlots);
    row.appendChild(rm);

    resList.appendChild(row);
  });

  _resSyncApplied(list);
}

function _resAdd(type,pool,slots){
  const arr = _resRead();
  const item = {
    type: (type==="exclusive" ? "exclusive" : "quant"),
    pool: (pool || "").trim(),
    slots: (type==="exclusive" ? 1 : Math.max(1, parseInt(slots||"1",10))),
    primary: false
  };
  if(!arr.length){
    item.primary = true;
  }
  arr.push(item);
  // si no hay primary, set first
  if(arr.length && !arr.some(x=>x.primary)) arr[0].primary = true;
  _resWrite(arr);
  _resSyncApplied(arr);
  _resRender();
}

// comportamiento del tipo en el form
rType.addEventListener("change", ()=>{
  if(rType.value==="exclusive"){ rSlots.value="1"; rSlots.disabled=true; }
  else { rSlots.disabled=false; }
});

rAdd.addEventListener("click", ()=>{
  const pool = (rPool.value || "").trim();
  if(!pool) return;
  _resAdd(rType.value, pool, rSlots.value);
  rPool.value = "";
  rSlots.value = "1";
  rPool.focus();
});

// estado inicial
_resRender();

wrap.appendChild(adv);

  const del = el("button",{},"Eliminar");
  del.onclick = () => { wrap.remove(); refreshTaskSelects(); updateGraph(); };
  wrap.appendChild(el("div",{style:"margin-top:6px;"})).appendChild(del);

  document.getElementById("tasks").appendChild(wrap);
  refreshTaskSelects();
  updateGraph();
}

/* Dependencias */
function makeTaskSelect(selected){
  const sel = el("select", {"data-k":"_sel"});
  taskIdOptions().forEach(id => {
    const opt = el("option",{value:id}, id);
    if(id === selected) opt.selected = true;
    sel.appendChild(opt);
  });
  return sel;
}
function addDep(){
  const wrap = el("div",{class:"section-card"});
  wrap.appendChild(el("label",{},"upstream"));
  wrap.appendChild(makeTaskSelect());
  wrap.appendChild(el("label",{},"downstream"));
  wrap.appendChild(makeTaskSelect());
  const del = el("button",{},"Eliminar");
  del.onclick = () => { wrap.remove(); updateGraph(); };
  wrap.appendChild(el("div",{style:"margin-top:6px;"})).appendChild(del);
  document.getElementById("deps").appendChild(wrap);
  updateGraph();
}
function makeDownstreamSelect(selected){
  const sel = el("select", {"data-k":"downstream", style:"width:100%;"});
  taskIdOptions().forEach(id => sel.appendChild(el("option",{value:id}, id)));
  if(selected) sel.value = selected;
  return sel;
}
function addExternalDep(){
  const wrap = el("div",{class:"section-card"});
  wrap.appendChild(el("label",{},"external_dag_id"));
  wrap.appendChild(el("input",{"data-k":"external_dag_id",placeholder:"otro_dag_id"}));
  wrap.appendChild(el("label",{},"external_task_id (opcional)"));
  wrap.appendChild(el("input",{"data-k":"external_task_id",placeholder:"(vacío => espera al DAG)"}));
  wrap.appendChild(el("label",{},"mode (poke/reschedule)"));
  wrap.appendChild(el("input",{"data-k":"mode",value:"reschedule"}));
  wrap.appendChild(el("label",{},"poke_interval (s)"));
  wrap.appendChild(el("input",{"data-k":"poke_interval",type:"number",value:"60"}));
  wrap.appendChild(el("label",{},"timeout (s)"));
  wrap.appendChild(el("input",{"data-k":"timeout",type:"number",value:"3600"}));
  wrap.appendChild(el("label",{},"Conectar a (downstream local)"));
  wrap.appendChild(makeDownstreamSelect()); /* <- fix sin paréntesis extra */
  const del = el("button",{},"Eliminar");
  del.onclick = () => { wrap.remove(); updateGraph(); };
  wrap.appendChild(el("div",{style:"margin-top:6px;"})).appendChild(del);
  document.getElementById("extdeps").appendChild(wrap);
  updateGraph();
}

/* Toolbar + selects */
(function initOps(){
  const sel = document.getElementById("opsel");
  if(sel){ OP_TYPES.forEach(([k,v])=> sel.appendChild(el("option",{value:v}, `${k} — ${v}`))); }
  document.getElementById("add_op")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask(sel.value); });
  document.getElementById("add_empty")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("EmptyOperator"); });
  document.getElementById("add_bash")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("BashOperator"); });
  document.getElementById("add_python")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("PythonOperator"); });
  document.getElementById("add_dep")?.addEventListener("click", (e)=>{ e.preventDefault(); addDep(); });
  document.getElementById("add_extdep")?.addEventListener("click", (e)=>{ e.preventDefault(); addExternalDep(); });
  document.getElementById("add_custom")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("CustomOperator"); });
  document.getElementById("add_ssh")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("SSHOperator"); });
  document.getElementById("add_winrm")?.addEventListener("click", (e)=>{ e.preventDefault(); addTask("WinRMOperator"); });
})();

/* ===== Collect + Preview/Download ===== */
function qAll(root, sel){ return Array.from((root||document).querySelectorAll(sel)); }
function collect(){
  const taskCards = qAll(document, "#tasks > .section-card");
  let tasks = taskCards.map(card => {
    const o = {};
    qAll(card, "[data-k]").forEach(inp => {
      const k = inp.getAttribute("data-k");
      o[k] = (k === "task_id") ? normId(inp.value) : inp.value;
    });
    return o;
  });
  tasks = ensureUniqueTaskIds(tasks);

    // --- Dependencias internas ---
  const deps = qAll(document, "#deps > .section-card").map(card => {
    const [upSel, downSel] = qAll(card, 'select[data-k="_sel"]');
    return { upstream: upSel?.value || "", downstream: downSel?.value || "" };
  });

    // --- Dependencias externas -> ExternalTaskSensor + edge ---
  const extDeps = qAll(document, "#extdeps > .section-card").map(card => {
    const ext = {}; qAll(card, "[data-k]").forEach(inp => ext[inp.getAttribute("data-k")] = inp.value); return ext;
  });
  extDeps.forEach((e, idx) => {
    const ets_id = normId(`wait_${e.external_dag_id}_${e.external_task_id || "dag"}`) + (idx ? `_${idx+1}` : "");
    tasks.push({
      type: "ExternalTaskSensor", task_id: ets_id, external_dag_id: e.external_dag_id,
      external_task_id: e.external_task_id || null, mode: e.mode || "reschedule",
      poke_interval: e.poke_interval || 60, timeout: e.timeout || 3600
    });
    if(e.downstream){ deps.push({ upstream: ets_id, downstream: e.downstream }); }
  });

    // --- Hora específica para @once (NO es cron) ---
  const start_time_once = (() => {
    const hh = document.getElementById('once_hh')?.value ?? '';
    const mm = document.getElementById('once_mm')?.value ?? '';
    return (hh !== '' && mm !== '')
      ? `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`
      : '';
  })();

  return {
    dag_id: document.getElementById("dag_id")?.value || "",
    description: document.getElementById("description")?.value || "",
    owner: document.getElementById("owner")?.value || "owner",
    app: document.getElementById("app")?.value || "",
    subapp: document.getElementById("subapp")?.value || "",
    retries: parseInt(document.getElementById("retries")?.value || "1", 10),
    retry_minutes: parseInt(document.getElementById("retry_minutes")?.value || "5", 10),
    start_date: document.getElementById("start_date")?.value || "",    schedule: (function(){ const c = buildCronFromUI2(); window.builderState.schedule = c; return c; })(),
    timezone: (window.builderState?.timezone) || "UTC",
    start_time: start_time_once,
    catchup: !!document.getElementById("catchup")?.checked,
    tags: (document.getElementById("tags")?.value || "").split(",").map(s => s.trim()).filter(Boolean),
    tasks, dependencies: deps
  };
}

async function doPreview(){
  const spec = collect();
  const r = await fetch("/api/builder/preview", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(spec)});
  const data = await r.json().catch(()=>({}));
  document.getElementById("out_code").textContent = data.code || "";
  document.getElementById("out_val").textContent  = JSON.stringify(data.validation || {}, null, 2);
  document.getElementById("statusChip").textContent = (data.validation?.valid ? "válido" : "con errores");
}
document.getElementById("btn_preview")?.addEventListener("click", doPreview);
document.getElementById("btn_preview_footer")?.addEventListener("click", doPreview);

document.getElementById("btn_download")?.addEventListener("click", async ()=>{
  const spec = collect();
  const r = await fetch("/api/builder/download", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(spec)});
  const blob = await r.blob();
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = (spec.dag_id || "dag_generated") + ".py"; a.click();
});
document.getElementById("btn_download_footer")?.addEventListener("click", ()=> document.getElementById("btn_download").click());

/* Switch Código/Validación */
document.getElementById("btn_show_code")?.addEventListener("click", ()=>{
  document.getElementById("out_code").style.display="block";
  document.getElementById("out_val").style.display="none";
});
document.getElementById("btn_show_val")?.addEventListener("click", ()=>{
  document.getElementById("out_code").style.display="none";
  document.getElementById("out_val").style.display="block";
});

/* Fecha por defecto = hoy */
(function setDefaultDate(){
  const d = document.getElementById("start_date");
  if(!d?.value){
    const now = new Date(); const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,"0"), dd=String(now.getDate()).padStart(2,"0");
    d.value = `${y}-${m}-${dd}`;
  }
})();

/* Modo compacto persistente */
(function initCompact(){
  const KEY = 'builder:compact';
  const pane = document.getElementById('pane-tasks');
  const chk  = document.getElementById('toggle_compact');
  if(!pane || !chk) return;
  function apply(on){ pane.classList.toggle('compact', !!on); localStorage.setItem(KEY, on ? '1' : '0'); }
  const saved = localStorage.getItem(KEY) === '1';
  chk.checked = saved; apply(saved);
  chk.addEventListener('change', e => apply(e.target.checked));
})();

/* ===== DAG Graph (Cytoscape) ===== */
let cy = null;
function graphElementsFromSpec(spec){
  const nodes = [], edges = [], seenNode = new Set(), seenEdge = new Set();
  (spec.tasks || []).forEach(t => {
    const id = t.task_id; if(!id || seenNode.has(id)) return; seenNode.add(id);
    nodes.push({ data: { id, label: `${id}\n${t.type || 'Task'}` }, classes: (t.type==='ExternalTaskSensor')?'external':'internal' });
  });
  (spec.dependencies || []).forEach(d => {
    const u=d.upstream, v=d.downstream; if(!u||!v) return;
    const key = `${u}>>${v}`; if(seenEdge.has(key)) return; seenEdge.add(key);
    edges.push({ data: { id: key, source: u, target: v } });
  });
  return { nodes, edges };
}
function ensureCy(){
  if(cy) return cy;
  const text   = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#e6eaf2';
  const border = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#1f2a44';
  const brand  = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#017CEE';
  cy = cytoscape({
    container: document.getElementById('dagGraph'),
    wheelSensitivity: 0.2, pixelRatio: 1,
    layout: { name: 'breadthfirst', directed: true, spacingFactor: 1.15, padding: 20 },
    style: [
      { selector: 'node', style: {
          'shape':'round-rectangle','background-color':'#151a28','border-color':border,'border-width':1.5,
          'padding':'8px','label':'data(label)','font-size':12,'font-family':'ui-monospace, Menlo, Consolas, monospace',
          'text-wrap':'wrap','text-valign':'center','text-halign':'center','color':text,'width':'label','height':'label'
      }},
      { selector: 'node.external', style: { 'background-color':'#0b1220','border-style':'dashed','border-color':brand }},
      { selector: 'edge', style: {
          'curve-style':'taxi','taxi-direction':'downward','taxi-turn':20,'width':1.2,'line-color':border,
          'target-arrow-shape':'triangle','target-arrow-color':border
      }},
      { selector: ':selected', style: { 'border-color': brand, 'line-color': brand, 'target-arrow-color': brand } }
    ]
  });
  window.addEventListener('resize', () => cy.resize());
  return cy;
}
let graphDebounce = null;
function updateGraph(){
  if(graphDebounce){ cancelAnimationFrame(graphDebounce); }
  graphDebounce = requestAnimationFrame(()=>{
    const spec = collect();
    const {nodes, edges} = graphElementsFromSpec(spec);
    const g = ensureCy();
    g.json({ elements: { nodes, edges }});
    g.layout({ name: 'breadthfirst', directed: true, spacingFactor: 1.15, padding: 20 }).run();
  });
}
document.getElementById("btn_preview")?.addEventListener("click", updateGraph);
document.getElementById("btn_preview_footer")?.addEventListener("click", updateGraph);
['tasks','deps','extdeps'].forEach(id=>{
  const root = document.getElementById(id);
  if(root){ root.addEventListener('input', updateGraph); root.addEventListener('change', updateGraph); }
});
updateGraph();
document.getElementById('themeToggle')?.addEventListener('click', ()=>{ setTimeout(()=>{ cy=null; updateGraph(); }, 50); });
});
</script>
{% endblock %}
