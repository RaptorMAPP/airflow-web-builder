{# templates/calendars.html #}
{% extends "base.html" %}

{% block title %}Calendarios | Airflow DagCraft{% endblock %}
{% block page_title %}üìÖ Calendarios{% endblock %}
{% block page_subtitle %}Crea calendarios tipo Control-M (p.ej. d√≠as h√°biles) exportables para Airflow.{% endblock %}

{% block header_actions %}
  <button class="button ghost" id="btnNew" type="button">Nuevo</button>
  <button class="button secondary" id="btnExportBundle" type="button">Exportar bundle (ZIP)</button>
  <label class="button ghost" style="cursor:pointer;">
    Importar JSON
    <input id="fileImport" type="file" accept=".json" style="display:none;">
  </label>
{% endblock %}

{% block content %}
<div class="grid" id="calGrid">
  <div class="card span-4" id="leftPane">
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="q" placeholder="Buscar calendario...">
      <button class="button ghost" id="btnReload" type="button">‚Üª</button>
    </div>

    <div class="muted" style="margin-top:8px;">Calendarios disponibles</div>
    <div id="list" style="margin-top:8px; display:grid; gap:8px;"></div>
  </div>

  <div class="card span-8" id="rightPane">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
      <div>
        <div style="font-weight:700;">Editor</div>
        <div class="muted">Genera fechas y guarda. Luego se exporta como JSON para Airflow.</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="button ghost" id="btnPreview" type="button">Preview</button>
        <button class="button" id="btnSave" type="button">Guardar</button>
        <button class="button ghost" id="btnDelete" type="button">Eliminar</button>
      </div>
    </div>

    <div style="margin-top:12px;" class="grid">
      <div class="span-4">
        <label>Nombre (ID)</label>
        <input id="name" placeholder="habiles_cl_2026">
      </div>
      <div class="span-4">
        <label>Timezone</label>
        <input id="timezone" value="America/Santiago">
      </div>
      <div class="span-4">
        <label>Modo</label>
        <select id="mode">
          <option value="business_days">D√≠as h√°biles (reglas)</option>
          <option value="expanded_dates">Fechas expl√≠citas (lista)</option>
        </select>
      </div>

      <div class="span-4 only-rules">
        <label>A√±o desde</label>
        <input id="year_from" type="number" value="2026" min="2000" max="2100">
      </div>
      <div class="span-4 only-rules">
        <label>A√±o hasta</label>
        <input id="year_to" type="number" value="2026" min="2000" max="2100">
      </div>

      <div class="span-4 only-rules">
        <label>D√≠as de semana</label>
        <div style="display:flex; gap:10px; flex-wrap:wrap; padding:8px; border:1px solid var(--border); border-radius:10px; background:var(--panel-alt);">
          <label style="margin:0;"><input type="checkbox" class="wd" value="0" checked> Lun</label>
          <label style="margin:0;"><input type="checkbox" class="wd" value="1" checked> Mar</label>
          <label style="margin:0;"><input type="checkbox" class="wd" value="2" checked> Mi√©</label>
          <label style="margin:0;"><input type="checkbox" class="wd" value="3" checked> Jue</label>
          <label style="margin:0;"><input type="checkbox" class="wd" value="4" checked> Vie</label>
          <label style="margin:0;"><input type="checkbox" class="wd" value="5"> S√°b</label>
          <label style="margin:0;"><input type="checkbox" class="wd" value="6"> Dom</label>
        </div>
      </div>

      <div class="span-6">
        <label>Excluir fechas (una por l√≠nea, YYYY-MM-DD)</label>
        <textarea id="exclude" rows="6" placeholder="2026-01-01&#10;2026-05-01"></textarea>
        <div class="muted">√ötil para feriados que quieras sacar de d√≠as h√°biles.</div>
      </div>

      <div class="span-6">
        <label>Incluir fechas (una por l√≠nea, YYYY-MM-DD)</label>
        <textarea id="include" rows="6" placeholder="2026-12-26"></textarea>
        <div class="muted">√ötil para agregar excepciones aunque caigan fin de semana.</div>
      </div>

      <div class="span-12 only-expanded" style="display:none;">
        <label>Fechas expl√≠citas (una por l√≠nea, YYYY-MM-DD)</label>
        <textarea id="dates" rows="8" placeholder="2026-01-02&#10;2026-01-05"></textarea>
        <div class="muted">En este modo, se guarda exactamente esta lista.</div>
      </div>

      <div class="span-12">
        <div class="card" style="background:var(--panel-alt); border-style:dashed;">
          <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
            <div>
              <div style="font-weight:700;">Vista anual</div>
              <div class="muted" id="previewMeta">Selecciona d√≠as o presiona Preview.</div>
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
              <div class="muted" id="previewCount"></div>
              <select id="year_view" style="min-width:120px;"></select>
              <button class="button ghost" id="btnFull" type="button">Pantalla completa</button>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="legend">
              <span class="dot on"></span><span class="muted">Activo</span>
              <span class="dot off"></span><span class="muted">Inactivo</span>
              <span class="dot mutedDot"></span><span class="muted">Fuera de mes</span>
              <span class="muted" style="margin-left:auto; opacity:.85;">Click d√≠a = incluir/excluir</span>
            </div>
            <div id="yearGrid" class="year-grid"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  /* ---- FIX PRINCIPAL: tu base.html no define span-6 ni span-12 ---- */
  #calGrid .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; }
  #calGrid .grid > .span-4{ grid-column: span 4; }
  #calGrid .grid > .span-6{ grid-column: span 6; }
  #calGrid .grid > .span-8{ grid-column: span 8; }
  #calGrid .grid > .span-12{ grid-column: span 12; }

  /* Evita overflow/‚Äúse estira raro‚Äù cuando inputs son largos */
  #calGrid .grid > [class^="span-"]{ min-width:0; }
  #calGrid input, #calGrid select, #calGrid textarea{ min-width:0; }
  #calGrid textarea{ resize: vertical; }

  /* Fullscreen preview: oculta panel izquierdo y expande panel derecho */
  .cal-full #leftPane{ display:none; }
  .cal-full #rightPane{ grid-column: 1 / -1; }

  /* Vista anual: 4 por fila (12 meses = 3 filas). Responsive opcional. */
  .year-grid{
    display:grid;
    grid-template-columns: repeat(4, minmax(240px, 1fr));
    gap:12px;
  }
  @media (max-width: 1100px){
    .year-grid{ grid-template-columns: repeat(3, minmax(240px, 1fr)); }
  }
  @media (max-width: 820px){
    .year-grid{ grid-template-columns: repeat(2, minmax(240px, 1fr)); }
  }
  @media (max-width: 520px){
    .year-grid{ grid-template-columns: 1fr; }
  }

  /* IMPORTANTE: el scroll queda dentro del preview, no ‚Äúcrece infinito‚Äù */
  #yearGrid{
    max-height: calc(100vh - 420px);
    overflow:auto;
    padding-right: 6px;
  }
  .cal-full #yearGrid{
    max-height: calc(100vh - 260px);
  }

  .month-card{
    border:1px solid var(--border);
    border-radius:12px;
    overflow:hidden;
    background: var(--panel);
    box-shadow:0 1px 0 rgba(0,0,0,.12);
  }
  .month-header{
    background:#4f86c6;
    color:#fff;
    padding:8px 10px;
    font-weight:700;
    font-size:14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .month-body{ padding:8px 10px 10px 10px; background:var(--panel); }
  .dow{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    font-size:12px;
    font-weight:700;
    opacity:.9;
    margin-bottom:6px;
  }
  .days{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:4px;
  }
  .day{
    border-radius:7px;
    text-align:center;
    padding:6px 0;
    font-size:12px;
    user-select:none;
    cursor:pointer;
    border:1px solid transparent;
  }
  .day.out{ opacity:.35; cursor:default; }
  .day.on{
    background:#f2a23a;
    color:#111;
    border-color: rgba(0,0,0,.08);
    font-weight:700;
  }
  .day.off{
    background: rgba(255,255,255,.03);
    border-color: rgba(255,255,255,.05);
  }
  .day:hover{ border-color: rgba(255,255,255,.15); }

  .legend{
    display:flex; align-items:center; gap:8px;
    margin:0 0 10px 0;
    flex-wrap:wrap;
  }
  .dot{
    width:10px; height:10px; border-radius:50%;
    display:inline-block;
    border:1px solid rgba(0,0,0,.2);
  }
  .dot.on{ background:#f2a23a; }
  .dot.off{ background: rgba(255,255,255,.03); border-color: rgba(255,255,255,.12); }
  .dot.mutedDot{ background: rgba(255,255,255,.02); opacity:.35; border-color: rgba(255,255,255,.08); }

  /* Responsive de la grilla principal (mantiene consistencia con base) */
  @media (max-width: 960px){
    #calGrid{ grid-template-columns: 1fr !important; }
    #calGrid > .span-4, #calGrid > .span-8{ grid-column: 1 / -1; }
    #calGrid .grid{ grid-template-columns: 1fr; }
    #calGrid .grid > .span-4,
    #calGrid .grid > .span-6,
    #calGrid .grid > .span-8,
    #calGrid .grid > .span-12{ grid-column: 1 / -1; }
  }
</style>

<script>
  const $ = (id)=>document.getElementById(id);
  const listEl = $("list");
  let currentName = "";
  let lastDates = [];

  const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const DOW = ["Su","Mo","Tu","We","Th","Fr","Sa"];
  const DATE_RE = /^\d{4}-\d{2}-\d{2}$/;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function isoDate(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }

  function splitLines(v){
    return (v||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  }
  function uniqSorted(arr){
    return Array.from(new Set(arr)).sort();
  }
  function toDateSet(dates){
    return new Set((dates||[]).map(x=>String(x).trim()).filter(Boolean));
  }
  function jsDayToPyWeekday(jsDay){
    return (jsDay + 6) % 7; // JS 0=Sun -> Py 6; JS 1=Mon -> Py 0
  }
  function daysInMonth(y, m){
    return new Date(y, m, 0).getDate();
  }

  function getWeekdays(){
    return Array.from(document.querySelectorAll(".wd"))
      .filter(x=>x.checked)
      .map(x=>parseInt(x.value,10));
  }

  function setModeUI(){
    const mode = $("mode").value;
    const onlyRules = document.querySelectorAll(".only-rules");
    const onlyExpanded = document.querySelectorAll(".only-expanded");
    onlyRules.forEach(el=>el.style.display = (mode==="business_days") ? "" : "none");
    onlyExpanded.forEach(el=>el.style.display = (mode==="expanded_dates") ? "" : "none");
  }

  function buildPayloadFromUI(){
    return {
      name: ($("name").value || "").trim(),
      timezone: ($("timezone").value || "UTC").trim(),
      mode: $("mode").value,
      year_from: parseInt($("year_from").value,10),
      year_to: parseInt($("year_to").value,10),
      weekdays: getWeekdays(),
      exclude: splitLines($("exclude").value),
      include: splitLines($("include").value),
      dates: splitLines($("dates").value),
    };
  }

  // Local preview (sin backend): para ‚ÄúNuevo‚Äù y clicks r√°pidos
  function computeLocalDates(payload){
    const mode = payload.mode;
    const exclude = new Set((payload.exclude||[]).filter(x=>DATE_RE.test(x)));
    const include = new Set((payload.include||[]).filter(x=>DATE_RE.test(x)));
    const weekdaysArr = (payload.weekdays || []).map(n=>parseInt(n,10));
    const weekdays = new Set(weekdaysArr);

    // Si no hay d√≠as marcados, calendario vac√≠o (0 fechas)
    if(payload.mode !== "expanded_dates" && weekdays.size === 0){
      return uniqSorted(Array.from(include));
    }


    if(mode === "expanded_dates"){
      const lines = (payload.dates||[]).filter(x=>DATE_RE.test(x));
      return uniqSorted(lines);
    }

    let yf = payload.year_from || new Date().getFullYear();
    let yt = payload.year_to || yf;
    if(yf > yt){ const t=yf; yf=yt; yt=t; }

    const out = [];
    for(let y=yf; y<=yt; y++){
      for(let m=1; m<=12; m++){
        const dim = daysInMonth(y, m);
        for(let d=1; d<=dim; d++){
          const dt = new Date(y, m-1, d);
          const pyWd = jsDayToPyWeekday(dt.getDay());
          if(!weekdays.has(pyWd)) continue;

          const key = isoDate(y, m, d);
          if(exclude.has(key)) continue;
          out.push(key);
        }
      }
    }

    include.forEach(x=>out.push(x));
    return uniqSorted(out);
  }

  function renderYearOptions(){
    const yf = parseInt($("year_from").value,10) || new Date().getFullYear();
    const yt = parseInt($("year_to").value,10) || yf;
    const sel = $("year_view");

    const prev = sel.value;
    sel.innerHTML = "";

    const a = Math.min(yf, yt), b = Math.max(yf, yt);
    for(let y=a; y<=b; y++){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      sel.appendChild(opt);
    }

    const stillValid = Array.from(sel.options).some(o => o.value === prev);
    sel.value = stillValid ? prev : String(yf);
  }

  function renderYearGrid(year, dateSet){
    const root = $("yearGrid");
    root.innerHTML = "";

    for(let monthIdx=0; monthIdx<12; monthIdx++){
      const m = monthIdx + 1;
      const first = new Date(year, monthIdx, 1);
      const firstDow = first.getDay();
      const dim = daysInMonth(year, m);

      const card = document.createElement("div");
      card.className = "month-card";

      const header = document.createElement("div");
      header.className = "month-header";
      header.innerHTML = `<span>${MONTHS[monthIdx]} ${year}</span><span style="opacity:.9; font-size:12px;">${m}</span>`;

      const body = document.createElement("div");
      body.className = "month-body";

      const dow = document.createElement("div");
      dow.className = "dow";
      dow.innerHTML = DOW.map(x=>`<div style="text-align:center;">${x}</div>`).join("");

      const days = document.createElement("div");
      days.className = "days";

      for(let i=0; i<firstDow; i++){
        const el = document.createElement("div");
        el.className = "day out";
        el.textContent = "";
        days.appendChild(el);
      }

      for(let d=1; d<=dim; d++){
        const key = isoDate(year, m, d);
        const el = document.createElement("div");
        el.className = "day " + (dateSet.has(key) ? "on" : "off");
        el.textContent = String(d);

        el.onclick = ()=>{
          const mode = $("mode").value;

          if(mode === "expanded_dates"){
            const lines = new Set(splitLines($("dates").value));
            if(lines.has(key)) lines.delete(key); else lines.add(key);
            $("dates").value = uniqSorted(Array.from(lines)).join("\n");
          } else {
            const excl = new Set(splitLines($("exclude").value));
            const incl = new Set(splitLines($("include").value));

            if(dateSet.has(key)){
              incl.delete(key);
              excl.add(key);
            } else {
              excl.delete(key);
              incl.add(key);
            }
            $("exclude").value = uniqSorted(Array.from(excl)).join("\n");
            $("include").value = uniqSorted(Array.from(incl)).join("\n");
          }

          refreshLocal("Vista local (sin Preview backend)");
        };

        days.appendChild(el);
      }

      // trailing out
      const totalCells = firstDow + dim;
      const rem = totalCells % 7;
      if(rem !== 0){
        for(let i=0; i<(7-rem); i++){
          const el = document.createElement("div");
          el.className = "day out";
          el.textContent = "";
          days.appendChild(el);
        }
      }

      body.appendChild(dow);
      body.appendChild(days);

      card.appendChild(header);
      card.appendChild(body);
      root.appendChild(card);
    }
  }

  function renderFromDates(dates){
    lastDates = Array.isArray(dates) ? dates : [];
    renderYearOptions();

    const y = parseInt($("year_view").value, 10)
          || parseInt($("year_from").value, 10)
          || new Date().getFullYear();

    renderYearGrid(y, toDateSet(lastDates));
  }

  function refreshLocal(metaText){
    const payload = buildPayloadFromUI();
    const dates = computeLocalDates(payload);
    $("previewMeta").textContent = metaText || "Vista local";
    $("previewCount").textContent = `${dates.length} fechas`;
    renderFromDates(dates);
  }

  async function api(path, opts={}){
    const r = await fetch(path, {
      headers: {"Content-Type":"application/json"},
      credentials: "same-origin",
      ...opts
    });
    if(!r.ok){
      const t = await r.text();
      throw new Error(`${r.status} ${r.statusText}: ${t}`);
    }
    const ct = r.headers.get("content-type")||"";
    return ct.includes("application/json") ? r.json() : r.text();
  }

  function renderList(items){
    const q = ($("q").value||"").toLowerCase().trim();
    listEl.innerHTML = "";
    (items||[])
      .filter(x => !q || (x.name||"").toLowerCase().includes(q))
      .forEach(x=>{
        const a = document.createElement("div");
        a.style.cssText = `padding:10px; border:1px solid var(--border); border-radius:10px; background:var(--panel-alt);
                           cursor:pointer; display:flex; justify-content:space-between; gap:10px; align-items:center;`;
        a.innerHTML = `
          <div>
            <div style="font-weight:700;">${x.name}</div>
            <div class="muted">${x.timezone || "UTC"} ¬∑ ${x.count || 0} fechas</div>
          </div>
          <div class="muted">${x.updated_at ? new Date(x.updated_at).toLocaleString() : ""}</div>
        `;
        a.onclick = ()=>loadOne(x.name);
        listEl.appendChild(a);
      });
    if(!listEl.children.length){
      listEl.innerHTML = `<div class="muted" style="padding:10px;">No hay calendarios.</div>`;
    }
  }

  async function loadList(){
    const items = await api("/api/calendars");
    renderList(items);
  }

  async function loadOne(name){
    const c = await api(`/api/calendars/${encodeURIComponent(name)}`);
    currentName = c.name || name;

    $("name").value = c.name || "";
    $("timezone").value = c.timezone || "UTC";

    $("mode").value = c.meta?.type === "expanded_dates" ? "expanded_dates" : "business_days";
    setModeUI();

    $("exclude").value = (c.meta?.exclude||[]).join("\n");
    $("include").value = (c.meta?.include||[]).join("\n");
    $("year_from").value = c.meta?.year_from ?? 2026;
    $("year_to").value = c.meta?.year_to ?? 2026;

    const wds = new Set((c.meta?.weekdays||[0,1,2,3,4]).map(n=>parseInt(n,10)));
    document.querySelectorAll(".wd").forEach(cb=>cb.checked = wds.has(parseInt(cb.value,10)));

    $("dates").value = (c.dates||[]).join("\n");

    $("previewMeta").textContent = "Cargado.";
    $("previewCount").textContent = `${(c.dates||[]).length} fechas`;
    renderFromDates(c.dates || []);
  }

  function clearForm(){
    currentName = "";
    $("name").value = "";
    $("timezone").value = "America/Santiago";
    $("mode").value = "business_days";
    setModeUI();
    $("year_from").value = 2026;
    $("year_to").value = 2026;
    document.querySelectorAll(".wd").forEach(cb=>cb.checked = false);
    $("exclude").value = "";
    $("include").value = "";
    $("dates").value = "";

    renderYearOptions();
    refreshLocal("Nuevo calendario: selecciona d√≠as (vista local)");
  }

  async function preview(){
    const payload = buildPayloadFromUI();
    if(!payload.name) payload.name = "preview_tmp"; // evita error de nombre vac√≠o en backend
    const out = await api("/api/calendars/preview", {method:"POST", body: JSON.stringify(payload)});
    $("previewMeta").textContent = out.meta || "Preview OK (backend)";
    $("previewCount").textContent = `${(out.dates||[]).length} fechas`;
    renderFromDates(out.dates || []);
  }

  async function save(){
    const payload = buildPayloadFromUI();
    if(!payload.name){
      alert("Debes ingresar un Nombre (ID) antes de guardar.");
      return;
    }
    const out = await api("/api/calendars", {method:"POST", body: JSON.stringify(payload)});
    currentName = out.name;
    $("previewMeta").textContent = "Guardado.";
    $("previewCount").textContent = `${(out.dates||[]).length} fechas`;
    renderFromDates(out.dates || []);
    await loadList();
  }

  async function del(){
    const name = ($("name").value||"").trim();
    if(!name) return;
    await api(`/api/calendars/${encodeURIComponent(name)}`, {method:"DELETE"});
    clearForm();
    await loadList();
  }

  async function importJson(file){
    const fd = new FormData();
    fd.append("file", file);
    const r = await fetch("/api/calendars/import", {method:"POST", body: fd, credentials:"same-origin"});
    if(!r.ok) throw new Error(await r.text());
    await loadList();
  }

  function exportBundle(){
    window.location.href = "/api/calendars/export_bundle";
  }

  function toggleFull(){
    const on = document.body.classList.toggle("cal-full");
    $("btnFull").textContent = on ? "Salir" : "Pantalla completa";
  }

  // Eventos
  $("btnReload").onclick = loadList;
  $("btnNew").onclick = clearForm;
  $("btnPreview").onclick = preview;
  $("btnSave").onclick = save;
  $("btnDelete").onclick = del;
  $("btnExportBundle").onclick = exportBundle;
  $("btnFull").onclick = toggleFull;

  $("mode").onchange = ()=>{
    setModeUI();
    refreshLocal("Vista local (modo actualizado)");
  };

  $("q").oninput = loadList;

  $("fileImport").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) importJson(f).catch(err=>alert(err.message));
    e.target.value = "";
  });

  let tmr = null;
  function scheduleLocal(){
    if(tmr) clearTimeout(tmr);
    tmr = setTimeout(()=>refreshLocal("Vista local (editando)"), 150);
  }
  $("exclude").addEventListener("input", scheduleLocal);
  $("include").addEventListener("input", scheduleLocal);
  $("dates").addEventListener("input", scheduleLocal);
  document.querySelectorAll(".wd").forEach(cb=>cb.addEventListener("change", ()=>refreshLocal("Vista local (reglas)")));

  $("year_from").addEventListener("change", ()=>{
    renderYearOptions();
    refreshLocal("Vista local (a√±o actualizado)");
  });
  $("year_to").addEventListener("change", ()=>{
    renderYearOptions();
    refreshLocal("Vista local (a√±o actualizado)");
  });

  $("year_view").addEventListener("change", ()=>{
    const y = parseInt($("year_view").value,10) || new Date().getFullYear();
    renderYearGrid(y, toDateSet(lastDates));
  });

  // Init
  setModeUI();
  loadList().catch(err=>alert(err.message));
  clearForm();
</script>
{% endblock %}
